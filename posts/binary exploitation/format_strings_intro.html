<!DOCTYPE html><html lang="en"mode="dark"><!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><!-- i18n for `_javascript/utils/timeago.js` -->
    <meta name="day-prompt" content="days ago">
    <meta name="hour-prompt" content="hours ago">
    <meta name="minute-prompt" content="minutes ago">
    <meta name="justnow-prompt" content="just now"><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Introduction to Format Strings Vulnerabilities" />
<meta property="og:locale" content="en" />
<meta name="description" content="A format string is, simply put, a string that is used to format dynamic data for display. They are typically used to avoid hard-coding variables into a string, and also allows the programmer to specify the format in which specific data is to be displayed. Example: You are making a social media application and you want to display the username of a user when they open their profile. A minimalistic implementation of this in C looks like this;" />
<meta property="og:description" content="A format string is, simply put, a string that is used to format dynamic data for display. They are typically used to avoid hard-coding variables into a string, and also allows the programmer to specify the format in which specific data is to be displayed. Example: You are making a social media application and you want to display the username of a user when they open their profile. A minimalistic implementation of this in C looks like this;" />
<link rel="canonical" href="https://4g3nt47.github.io/posts/binary%20exploitation/format_strings_intro.html" />
<meta property="og:url" content="https://4g3nt47.github.io/posts/binary%20exploitation/format_strings_intro.html" />
<meta property="og:site_name" content="4g3nt47" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-09T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Introduction to Format Strings Vulnerabilities" />
<meta name="twitter:site" content="@UmarAbdoul" />
<meta name="google-site-verification" content="google_meta_tag_verification" />
<script type="application/ld+json">
{"description":"A format string is, simply put, a string that is used to format dynamic data for display. They are typically used to avoid hard-coding variables into a string, and also allows the programmer to specify the format in which specific data is to be displayed. Example: You are making a social media application and you want to display the username of a user when they open their profile. A minimalistic implementation of this in C looks like this;","@type":"BlogPosting","url":"https://4g3nt47.github.io/posts/binary%20exploitation/format_strings_intro.html","headline":"Introduction to Format Strings Vulnerabilities","dateModified":"2024-05-09T00:00:00+01:00","datePublished":"2024-05-09T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://4g3nt47.github.io/posts/binary%20exploitation/format_strings_intro.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<title>Introduction to Format Strings Vulnerabilities | 4g3nt47
  </title><!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
--><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="4g3nt47">
<meta name="application-name" content="4g3nt47">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- GA --><!-- Bootstrap -->
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="/assets/css/all.min.css"><!--
  CSS selector for site.
-->

<link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet"
    href="/assets/css/bootstrap-toc.min.css"><!-- Manific Popup -->
  <link rel="stylesheet" href="/assets/css/magnific-popup.min.css"><!-- JavaScript -->

  <script src="/assets/js/jquery.min.js"></script>

</head>
<body data-spy="scroll" data-target="#toc"><!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end" lang="en">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto"><img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"></a>
    </div>

    <div class="site-title mt-3">
      <a href="/">4g3nt47</a>
    </div>
    <div class="site-subtitle font-italic">Welcome to my infosec blog</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs --><li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i><span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item --><li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i><span>TAGS</span>
      </a>
    </li> <!-- .nav-item --><li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i><span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item --><li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i><span>ABOUT</span>
      </a>
    </li> <!-- .nav-item --></ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"><a href="https://github.com/4g3nt47" aria-label="github"target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a><a href="https://twitter.com/UmarAbdoul" aria-label="twitter"target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a><a href="javascript:location.href = 'mailto:' + ['aufaruq02','gmail.com'].join('@')" aria-label="email">
        <i class="fas fa-envelope"></i>
      </a><a href="/rss/feed.xml" aria-label="rss">
        <i class="fas fa-rss"></i>
      </a></div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->
<!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center topbar-down">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb"><span>
            <a href="/">
              Home
            </a>
          </span><span>Introduction to Format Strings Vulnerabilities</span></span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">Post</div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
      <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i>
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>
<div id="main-wrapper">
      <div id="main">

        <div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-8">
    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><!--
  Refactor the HTML structure.
--><!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
--><!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
--><!-- Add attribute 'hide-bullet' to the checkbox list --><!-- images --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add CDN URL --><!-- Add image path --><!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> --><!-- Add SVG placehoder to prevent layout reflow --><!-- Bypass the HTML-proofer test --><!-- Add header for code snippets --><!-- Create heading anchors --><!-- return -->

<h1 data-toc-skip>Introduction to Format Strings Vulnerabilities</h1>

<div class="post-meta text-muted">

  <!-- author -->
  <div>By
    <em><a href="https://twitter.com/UmarAbdoul">Umar Abdul</a></em>
  </div>

  <div class="d-flex">
    <div>
      <!-- published date -->
      <span>
        Posted<!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
--><em class="timeago"
    date="2024-05-09 00:00:00 +0100"data-toggle="tooltip"
      data-placement="bottom"
      title="Thu, May  9, 2024, 12:00 AM +0100">May  9</em>
</span>

      <!-- lastmod date --><!-- read time --><!--
  Calculate the post's reading time, and display the word count in tooltip
 --><!-- words per minute  --><!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="1552 words">
  <em>8 min</em> read</span>
<!-- page views --></div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>A format string is, simply put, a string that is used to format dynamic data for display. They are typically used to avoid hard-coding variables into a string, and also allows the programmer to specify the format in which specific data is to be displayed. Example: You are making a social media application and you want to display the username of a user when they open their profile. A minimalistic implementation of this in C looks like this;</p>

<div class="language-c highlighter-rouge"><div class="code-header"><span label-text="C"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="kt">char</span> <span class="o">*</span><span class="n">username</span> <span class="o">=</span> <span class="s">"4g3nt47"</span><span class="p">;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Username: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">username</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In the above example, the format string in use is <code class="language-plaintext highlighter-rouge">%s</code>, tells the <code class="language-plaintext highlighter-rouge">printf</code> function to display the argument passed to it as a <em>string</em>, in this case, the variable <code class="language-plaintext highlighter-rouge">username</code>. This should output the following;</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header"><span label-text="Plaintext"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Username: 4g3nt47
</pre></td></tr></tbody></table></code></div></div>

<p>So… how does this work? Looking at the <code class="language-plaintext highlighter-rouge">printf()</code> function prototype;</p>

<div class="language-c highlighter-rouge"><div class="code-header"><span label-text="C"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">format</code> is the format string, and the <code class="language-plaintext highlighter-rouge">...</code> indicates the function accepts variable number of additional arguments. These additional arguments are referenced sequentially whenever the <code class="language-plaintext highlighter-rouge">printf()</code> functions encounters a format string that needs to be resolved, in our example <code class="language-plaintext highlighter-rouge">%s</code>. It should be noted there are many functions that use format strings, not just <code class="language-plaintext highlighter-rouge">printf</code>. See the reference manual (<code class="language-plaintext highlighter-rouge">man 3 printf</code> on linux).</p>

<p><br /></p>

<h4 id="how-it-really-works">How It Really Works<a href="#how-it-really-works" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4>
<p><br /></p>

<p>Format strings look pretty useful and safe until you think about how they actually work. As discussed, the <code class="language-plaintext highlighter-rouge">printf()</code> function resolves format strings by reading their respective data from an infinite set of arguments. What happens if no argument was provided? Let’s see…</p>

<div class="language-c highlighter-rouge"><div class="code-header"><span label-text="C"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">(){</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Welcome, %s"</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Compiling and running this, I got;</p>

<p><img data-src="/assets/img/Pasted image 20240416200104.png" alt="" data-proofer-ignore></p>

<p>Notice we keep getting some random values in place of <code class="language-plaintext highlighter-rouge">%s</code>, which indicates the function is still reading something. As you know, a string is just a pointer to a bunch of characters, so we can assume the <code class="language-plaintext highlighter-rouge">%s</code> is causing the <code class="language-plaintext highlighter-rouge">printf()</code> function to de-reference some address. If we want to see the actual address that is being read, we need a format specifier that actually prints values as they are. Since we are working on x86 where pointers are 4 bytes in size, an ideal format specifier for this is an 8-characters wide hexadecimal (<code class="language-plaintext highlighter-rouge">%08x</code>);</p>

<div class="language-c highlighter-rouge"><div class="code-header"><span label-text="C"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">printf</span><span class="p">(</span><span class="s">"Welcome, %08x</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p><img data-src="/assets/img/Pasted image 20240416200843.png" alt="" data-proofer-ignore></p>

<p>Sweet! We are now getting the address, which appears different each time because of <em>ASLR</em>. Now the question is where exactly is the <code class="language-plaintext highlighter-rouge">print()</code> function getting this address considering we didn’t give it any? Well, function arguments in x86 typically go onto the stack, so it’s a safe guess to assume that’s where the address is coming from. To confirm this, we can load the program in a debugger and set a breakpoint immediately after the call to <code class="language-plaintext highlighter-rouge">printf()</code> to see if the leaked address is on the stack;</p>

<p><img data-src="/assets/img/Pasted image 20240416202853.png" alt="" data-proofer-ignore></p>

<p>As expected it is. The address <code class="language-plaintext highlighter-rouge">0x565c6008</code> (highlighted in blue), which contains our format string, is right at the top of our stack. Next to it (highlighted in green) is the address we are leaking. Remember that when calling functions in x86, arguments are pushed into the stack in reverse order, meaning the first argument goes in last, and will therefore be on top of the stack. In this case, we didn’t actually provide any extra argument to <code class="language-plaintext highlighter-rouge">printf()</code>, but the function has no way of knowing that since it does not have a way of tracking how many arguments were given to it, relying solely on the number of format specifiers in the format string. Since the format string we used has one format specifier, the function simply pulls data from the stack, which was not meant for it.</p>

<p><br /></p>

<h4 id="exploitation-leaking-memory">Exploitation: Leaking Memory<a href="#exploitation-leaking-memory" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4>
<p><br /></p>

<p>Now let’s look at another simple example;</p>

<div class="language-c highlighter-rouge"><div class="code-header"><span label-text="C"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Please specify your name!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Welcome: "</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The above code may look safe until you take a closer look at line <strong>10</strong>;</p>

<div class="language-c highlighter-rouge"><div class="code-header"><span label-text="C"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">printf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Remember that the first argument for <code class="language-plaintext highlighter-rouge">printf()</code> is the format string, in this case <code class="language-plaintext highlighter-rouge">argv[1]</code>, which is the first argument passed to the program during execution. Since we have full control over this value, we can provide <code class="language-plaintext highlighter-rouge">printf()</code> with our own format strings and leak stuff from the stack;</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header"><span label-text="Plaintext"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>(agent47@debian) ~&gt; ./test '%08x %08x %08x %08x'
Welcome: 00000001 5656d000 5656a1c1 00000002
</pre></td></tr></tbody></table></code></div></div>

<p>You can see we are able to leak <strong>16</strong> bytes from the top of the stack in hex. The first and last DWORDS (double-words/4 bytes) are clearly not addresses, so we can ignore those. But the middle two might point to something. To read contents at these addresses, we can simply replace the format specifiers with <code class="language-plaintext highlighter-rouge">%s</code>, which causes <code class="language-plaintext highlighter-rouge">printf()</code> to de-reference them (Caution: reading the wrong address will cause the program to segfault);</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header"><span label-text="Plaintext"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>(agent47@debian) ~&gt; ./test '%08x %s %s %08x'
Welcome: 00000001 &gt; ?. 00000002
</pre></td></tr></tbody></table></code></div></div>

<p>We were now able to read the data at those addresses. Nothing interesting in this case, but you could get lucky going further down the stack in sensitive programs that happen to be vulnerable.</p>

<p><br /></p>

<h4 id="exploitation-writing-to-memory">Exploitation: Writing to Memory<a href="#exploitation-writing-to-memory" class="anchor"><i class="fas fa-hashtag"></i></a></h4></h4>
<p><br /></p>

<p>Leaking stuff is fun, but let’s take a look at an example that will show you how dangerous format strings bugs can be;</p>

<div class="language-c highlighter-rouge"><div class="code-header"><span label-text="C"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="kt">void</span> <span class="nf">show_profile</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_admin</span><span class="p">){</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"[*] Username: "</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[*] Admin privs: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">is_admin</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Usage: %s &lt;username&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">is_admin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"[+] NOTE: Administrative function disabled due to security concerns!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">show_profile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_admin</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">is_admin</span><span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] YOU ARE AN ADMIN: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">is_admin</span><span class="p">);</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">execve</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[-] Out of here, you peasant!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The above shown code when executed will;</p>
<ol>
  <li>Expect to be given the name of the user as an argument, and save it to <code class="language-plaintext highlighter-rouge">name</code></li>
  <li>Set <code class="language-plaintext highlighter-rouge">is_admin</code> to <code class="language-plaintext highlighter-rouge">0</code>, and inform the user that admin functions are disabled.</li>
  <li>Call <code class="language-plaintext highlighter-rouge">show_profile()</code> with the name of the user, and a <em>pointer</em> to the <code class="language-plaintext highlighter-rouge">is_admin</code> variable.</li>
  <li>Check if <code class="language-plaintext highlighter-rouge">is_admin</code> is non-zero, which should always be false since we hard-coded the value to <code class="language-plaintext highlighter-rouge">0</code>. Therefore, the block of code that calls <code class="language-plaintext highlighter-rouge">execve()</code> to open a shell should never run.</li>
</ol>

<p>Running it, the program seems to be working as expected;</p>

<p><img data-src="/assets/img/Pasted image 20240417122012.png" alt="" data-proofer-ignore></p>

<p>Looking at the <code class="language-plaintext highlighter-rouge">show_profile()</code> code, we can clearly see the second call to <code class="language-plaintext highlighter-rouge">printf()</code> is vulnerable;</p>

<div class="language-c highlighter-rouge"><div class="code-header"><span label-text="C"><i class="fas fa-code small"></i></span><button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">show_profile</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">is_admin</span><span class="p">){</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"[*] Username: "</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[*] Admin privs: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">is_admin</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This function accepts two arguments, both of which are pointers, and are placed on the stack. Let’s see if we can find them! Since our call stack is just <code class="language-plaintext highlighter-rouge">main() &gt;&gt; show_profile() &gt;&gt; printf()</code>, we shouldn’t need to dig deep into the stack before finding our addresses. So I leaked the first 10 addresses and examine their contents (see the previous section on how to do this) until I found the the address of my format string;</p>

<p><img data-src="/assets/img/Pasted image 20240417124638.png" alt="" data-proofer-ignore></p>

<p>And success! Our format string (the <code class="language-plaintext highlighter-rouge">name</code> variable) is the 8th DWORD on the stack. Since we passed both <code class="language-plaintext highlighter-rouge">name</code> and <code class="language-plaintext highlighter-rouge">is_admin</code> in the call to <code class="language-plaintext highlighter-rouge">show_profile()</code>, we can be certain that the next DWORD (highlighted in red) is the pointer to our <code class="language-plaintext highlighter-rouge">is_admin</code> function. We can’t exactly print this since it’s currently set to <code class="language-plaintext highlighter-rouge">0</code>, which <code class="language-plaintext highlighter-rouge">printf()</code> will see as a null character. But what if we can modify it?</p>

<p>Turns out we can! There is a special format string used to write the number of bytes written by the <code class="language-plaintext highlighter-rouge">printf()</code> function at a specific point to a given memory address: <code class="language-plaintext highlighter-rouge">%n</code>. Since in our case we don’t really care what is written to the target address as long as it’s not zero, we could use this to easily bypass the check that disables the code block that calls <code class="language-plaintext highlighter-rouge">execve()</code>;</p>

<p><img data-src="/assets/img/Pasted image 20240417125550.png" alt="" data-proofer-ignore></p>

<p>And just like that, we modified memory and got a shell! You might be curious why <code class="language-plaintext highlighter-rouge">is_admin</code> is now set to <code class="language-plaintext highlighter-rouge">72</code>? Well, if you count the number of bytes printed by the second call to <code class="language-plaintext highlighter-rouge">printf()</code>, you will see they are <code class="language-plaintext highlighter-rouge">72</code> bytes long;</p>

<p><img data-src="/assets/img/Pasted image 20240417130108.png" alt="" data-proofer-ignore></p>

<p>This is great.. but notice our payload is quite long, and programs will often restrict the length of the string you are allowed to input. An elegant way to shorten your format string payloads significantly is using <em>direct parameter access</em>, which allows you to specify exactly which argument you want to access within the format string. In C/C++, the format for direct parameter access is  <code class="language-plaintext highlighter-rouge">%&lt;index&gt;$&lt;format&gt;</code>, where <code class="language-plaintext highlighter-rouge">&lt;index&gt;</code> is the position of the argument from the top of the stack (starting from 1), and <code class="language-plaintext highlighter-rouge">&lt;format&gt;</code> is the format specifier you wish to use on it.</p>

<p>In our case, we know that the pointer to <code class="language-plaintext highlighter-rouge">is_admin</code> is the 9th item from the top of the stack, so we can access it using the following;</p>

<p><img data-src="/assets/img/Pasted image 20240419095710.png" alt="" data-proofer-ignore></p>

<p>And we got the same exploit with much shorter payload! Note that this feature may not be available on some platforms. If you are interested in learning more on format strings exploitation, consider reading  the 4th chapter of <em>The Shellcoder’s Handbook: Discovering and Exploiting Security Holes.</em></p>

<hr />

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories --><div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i><a href='/categories/binary-exploitation/'>binary exploitation</a></div><!-- tags --><div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i><a href="/tags/binary-exploitation/"
          class="post-tag no-text-decoration" >binary exploitation</a><a href="/tags/format-strings/"
          class="post-tag no-text-decoration" >format strings</a><a href="/tags/radare2/"
          class="post-tag no-text-decoration" >radare2</a></div><div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a> by the author.</div><!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons"><a href="https://twitter.com/intent/tweet?text=Introduction to Format Strings Vulnerabilities - 4g3nt47&url=https://4g3nt47.github.io/posts/binary%20exploitation/format_strings_intro.html" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a><a href="https://www.facebook.com/sharer/sharer.php?title=Introduction to Format Strings Vulnerabilities - 4g3nt47&u=https://4g3nt47.github.io/posts/binary%20exploitation/format_strings_intro.html" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a><a href="https://telegram.me/share?text=Introduction to Format Strings Vulnerabilities - 4g3nt47&url=https://4g3nt47.github.io/posts/binary%20exploitation/format_strings_intro.html" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a><i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        title-succeed="Link copied successfully!">
    </i>

  </span>
</div>
</div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->

</div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">

    <div class="access"><!--<div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3"><a class="post-tag" href="/tags/linux/">linux</a><a class="post-tag" href="/tags/hackthebox/">hackthebox</a><a class="post-tag" href="/tags/web/">web</a><a class="post-tag" href="/tags/lfi/">lfi</a><a class="post-tag" href="/tags/static-analysis/">static analysis</a><a class="post-tag" href="/tags/command-injection/">command injection</a><a class="post-tag" href="/tags/custom-exploitation/">custom exploitation</a><a class="post-tag" href="/tags/python/">python</a><a class="post-tag" href="/tags/dvwa/">dvwa</a><a class="post-tag" href="/tags/easy/">easy</a></div>
  </div>-->
    </div></div>

</div>

<!-- tail --><div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  --><!-- An random integer that bigger than 0  --><!-- Equals to TAG_SCORE / {max_categories_hierarchy}  --><!-- Fill with the other newlest posts  --><div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4"><div class="card">
        <a href="/posts/hackthebox/overflow.html">
          <div class="card-body"><!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
--><em class="timeagosmall"
    date="2022-04-09 00:00:00 +0100">Apr  9, 2022</em>
<h3 class="pt-0 mt-1 mb-3" data-toc-skip>Overflow - HackTheBox</h3>
            <div class="text-muted small">
              <p>Overflow is an amazing hard-rated box on HackTheBox. To gain a foothold on the box, you will need to exploit an oracle padding vulnerability to gain access to an admin dashboard that’s vulnerable t...
              </p>
            </div>
          </div>
        </a>
      </div><div class="card">
        <a href="/posts/shellcoding/shellcoding_addr_chall.html">
          <div class="card-body"><!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
--><em class="timeagosmall"
    date="2024-05-09 00:00:00 +0100">May  9</em>
<h3 class="pt-0 mt-1 mb-3" data-toc-skip>Injectable Shellcodes: The ADDRESS Challenge</h3>
            <div class="text-muted small">
              <p>One challenging aspect of creating a shellcode is dealing with addresses. Your shellcode will often need to reference certain locations, which gets complicated when working in the context of the pr...
              </p>
            </div>
          </div>
        </a>
      </div><div class="card">
        <a href="/posts/hackthebox/gofer.html">
          <div class="card-body"><!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
--><em class="timeagosmall"
    date="2023-10-22 00:00:00 +0100">Oct 22, 2023</em>
<h3 class="pt-0 mt-1 mb-3" data-toc-skip>Gofer - HackTheBox</h3>
            <div class="text-muted small">
              <p>Gofer is a very nice, hard box on HackTheBox. It starts with a verb tampering attack on a custom proxy to bypass access control, then a phishing attack on a local user using LibreOffice macro. Priv...
              </p>
            </div>
          </div>
        </a>
      </div></div> <!-- .card-deck -->
  </div> <!-- #related-posts --><!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between"><a href="/posts/hackthebox/zipping.html" class="btn btn-outline-primary"
    prompt="Older">
    <p>Zipping - HackTheBox</p>
  </a><a href="/posts/shellcoding/shellcoding_addr_chall.html" class="btn btn-outline-primary"
    prompt="Newer">
    <p>Injectable Shellcodes: The ADDRESS Challenge</p>
  </a></div>
<!--  The comments switcher --></div>
  </div>
</div> <!-- .row --><!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center text-muted">
    <div class="footer-left">
      <p class="mb-0">
        © 2024
        <a href="https://twitter.com/UmarAbdoul">Umar Abdul</a>.<span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p>
    </div>

    <div class="footer-right">
      <p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.

      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>
</div><!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints"><div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3"><a class="post-tag" href="/tags/linux/">linux</a><a class="post-tag" href="/tags/hackthebox/">hackthebox</a><a class="post-tag" href="/tags/web/">web</a><a class="post-tag" href="/tags/lfi/">lfi</a><a class="post-tag" href="/tags/static-analysis/">static analysis</a><a class="post-tag" href="/tags/command-injection/">command injection</a><a class="post-tag" href="/tags/custom-exploitation/">custom exploitation</a><a class="post-tag" href="/tags/python/">python</a><a class="post-tag" href="/tags/dvwa/">dvwa</a><a class="post-tag" href="/tags/easy/">easy</a></div>
  </div></div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>
</div> <!-- #main-wrapper --><div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a><!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
--><script src="/assets/js/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>
<!--
  JS selector for site.
-->

<!-- layout specified --><!-- image lazy-loading & popup -->
  <script src="/assets/js/clipboard.min.js"></script><script defer src="/assets/js/dist/post.min.js"></script><!-- commons -->

<script src="/assets/js/bootstrap.min.js"></script></body>

</html>
